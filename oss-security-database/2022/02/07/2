
Date: Mon, 7 Feb 2022 14:50:41 -0500
From: Phil Pennock <oss-security-phil@...dhuis.org>
To: oss-security@...ts.openwall.com
Cc: pdp@...s.io
Subject: [CVE-2022-24450] nats-server unconstrained account assumption by
 authenticated clients

CVE: CVE-2022-24450
Date: 2022-02-07

Background:

NATS.io is a high performance open source pub-sub distributed communication
technology, built for the cloud, on-premise, IoT, and edge computing.

The NATS server provides an optional account system for multi-tenancy,
such that Users live inside Accounts.  Users exist only at authentication
time; thereafter actions are all scoped to their account.  If Accounts
are not in use then normally all users are in the Global account, but
there is a System account most users should not have access to.

The NATS server can be embedded inside other software; any such software which
uses authentication managed by the nats-server is affected.


Problem Description:

NATS nats-server through 2022-02-04 has Incorrect Access Control, with
unchecked ability for clients to authorize into any account, because of a
coding error in a long-extant experimental feature.

A client crafting the initial protocol-level handshake could, with valid
credentials for any account, specify a target account and switch into it
immediately.  This includes any other tenant, and includes the System account
which controls nats-server core operations.

For deployments not using multi-tenancy through NATS Accounts, there is
still a vulnerability: normal users are able to choose to be in the System
account.

An experimental feature to provide dynamically provisioned sandbox accounts was
designed to allow a server administrator to turn on an option to allow clients
to dynamically request a brand new account inline at connection time.  This
feature went nowhere, but lived on in the code and was used by a number of
tests; support was never added to any client libraries or to the documentation.

A bug in handling the feature meant that if someone did in fact have valid
account credentials, then they could specify any other existing account and
they would be assigned into that account.

Release 2.7.2 of nats-server removes the feature.
Because of the lack of client support and absence from protocol documentation,
we feel this is safe operationally as well as the safest fix for the code.


Affected versions:

NATS Server:
 * All 2.x versions up to and including 2.7.1.
 * Fixed with nats-io/nats-server: 2.7.2
 * NATS Server 1.x did not have accounts.
 * Docker image:  nats <https://hub.docker.com/_/nats>

NATS Streaming Server:
 * All versions embedding affected NATS Server:
   + Affected: v0.15.0 up to and including v0.24.0
   + Fixed with nats-io/nats-streaming-server: 0.24.1
 * Docker image:  nats-streaming <https://hub.docker.com/_/nats-streaming>


Impact:

Existing users could act in any account, including the System account.


Workaround:

None.


Solution:

Upgrade the NATS server.


References:

 * <https://advisories.nats.io/CVE/CVE-2022-24450.txt>


Download attachment "signature.asc" of type "application/pgp-signature" (229 bytes)
