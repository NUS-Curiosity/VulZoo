
Date: Thu, 1 Oct 2015 12:07:55 GMT
From: matthias.deeg@...s.de
To: bugtraq@...urityfocus.com
Subject: [SYSS-2015-003] Kaspersky Small Office Security - Authentication
 Bypass

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Advisory ID: SYSS-2015-003
Product: Kaspersky Small Office Security (KSOS)
Vendor: Kaspersky Lab ZAO
Affected Version(s): 13.0.4.233
Tested Version(s): 13.0.4.233
Vulnerability Type: Authentication Bypass Using an Alternate Path or 
                    Channel (CWE-288)
Risk Level: Medium
Solution Status: Fixed
Vendor Notification: 2015-02-19
Solution Date: 2015-10-01
Public Disclosure: 2015-10-01
CVE Reference: Not yet assigned
Authors of Advisory: Matthias Deeg and Sven Freund (SySS GmbH)

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Overview:

Kaspersky Small Office Security is an endpoint protection software
with many features like malware protection, defences against phishing
attacks and exploits, data encryption and data backup functionality.

The vendor Kaspersky describes the product as follows (see [1]):

"Kaspersky Small Office Security delivers business-grade protection 
technologies that are designed to be simple to install, configure and
run. The solution protects your Windows-based PCs & file servers and 
Android smartphones and tablets to safeguard your online banking
transactions, your business data and the information your customers
entrust to you."

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Vulnerability Details:

The Kaspersky Small Office Security software allows users to disable
the offered protection by entering a so-called unload password.
Beside the graphical user interface (GUI) authentication, it is also
possible to manually deactivate the protection over the command-line
interface using the Kaspersky software tool avp.exe.

By analyzing the password-based authentication for unloading the
Kaspersky Small Office Security protection, the SySS GmbH found out,
that the password comparison is done within the process avp.exe
(actually within the module avpmain.dll), which runs or can be run in
the context of the current Windows user, who can also be a standard,
limited user.

This fact allows a further analysis and the manipulation of the password
comparison during runtime without administrative privileges, as every 
user is able to debug and manipulate the processes running with her user
privileges.

In order to bypass the password-based authentication to deactivate the 
protection of Kaspersky Small Office Security in an unauthorized manner,
an attacker only has to patch this password comparison, so that  it
always returns true, for example by comparing the correct unload
password with itself or by modifying the program control flow.

The SySS GmbH also found out, that by modifying the software tool 
avp.exe, the Kaspersky Small Office Security can also be deactivated
completely even when no password was set for protecting administrative
functions. The intended behavior of the software tool avp.exe in this
case is to deny access to the requested function, for example "exit",
due to a disabled password protection.

Thus, a limited Windows user or malware running in the context of such a
user is able to unload Kaspersky Small Office Security in an
unauthorized manner regardless of the configured password protection.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Proof of Concept (PoC):

The SySS GmbH developed a proof-of-concept software tool named
UnloadKSOS for deactivating Kaspersky Small Office Security in an
unauthorized manner.

The following output exemplarily shows a successful deactivation of
Kaspersky Small Office Security:

>UnloadKSOS.exe
                ____________________________________________________________
               /    _____       _____ _____                                 \
              /    /  ___|     /  ___/  ___|                                 \
             |     \ `--. _   _\ `--.\ `--.                                   |
             |      `--. \ | | |`--. \`--. \                                  |
             |     /\__/ / |_| /\__/ /\__/ /                                  |
              \    \____/ \__, \____/\____/   ... unloads KSOS!              /
               \          __/ |                                             /
               /         |___/    _________________________________________/
              / _________________/
        (__) /_/
        (oo)
  /------\/
 / |____||
*  ||   ||
   ^^   ^^
SySS Unload KSOS v1.0 by Matthias Deeg & Sven Freund - SySS GmbH (c) 2015

[+] Found location of the executable file avp.exe
[+] Created new instance of the Kaspersky Small Office Security process avp.exe
[+] The Kaspersky Small Office Security process was patched successfully.
    Kaspersky Small Office Security will now exit without a password.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Solution:

According to information by Kaspersky, the described security issue has
been fixed in newer software releases.

Please contact the manufacturer for further information or support.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Disclosure Timeline:

2015-02-19: Vulnerability reported to manufacturer
2015-02-19: Manufacturer acknowledges e-mail with SySS security advisory          
2015-03-17: Rescheduling of the publication date in agreement with the
            manufacturer
2015-04-14: Rescheduling of the publication date in agreement with the
            manufacturer
2015-09-28: SySS asks for further information about software fix
2015-10-01: Public release of security advisory on agreed publication
            date
         
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

References:

[1] Product Web site for Kaspersky Small Office Security
    http://www.kaspersky.com/small-office-security
[2] SySS Security Advisory SYSS-2015-003
    https://www.syss.de/fileadmin/dokumente/Publikationen/Advisories/SYSS-2015-003.txt
[3] SySS Responsible Disclosure Policy
    https://www.syss.de/en/news/responsible-disclosure-policy/

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Credits:

This security vulnerability was found by Matthias Deeg and Sven Freund
of the SySS GmbH.

E-Mail: matthias.deeg (at) syss.de
Public Key: https://www.syss.de/fileadmin/dokumente/Materialien/PGPKeys/Matthias_Deeg.asc
Key fingerprint = D1F0 A035 F06C E675 CDB9 0514 D9A4 BF6A 34AD 4DAB

E-Mail: sven.freund (at) syss.de
Public Key: https://www.syss.de/fileadmin/dokumente/Materialien/PGPKeys/Sven_Freund.asc
Key fingerprint = DCDB 7627 C1E3 9CE8 62DF 2666 8A5F A853 415D 46DC

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Disclaimer:

The information provided in this security advisory is provided "as is" 
and without warranty of any kind. Details of this security advisory may 
be updated in order to provide as accurate information as possible. The
latest version of this security advisory is available on the SySS Web 
site.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Copyright:

Creative Commons - Attribution (by) - Version 3.0
URL: http://creativecommons.org/licenses/by/3.0/deed.en

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2

iQIcBAEBCgAGBQJWDPBnAAoJENmkv2o0rU2rVywQAIzyHG0UmuI4yMQwj5J3DEFG
hD8yWjUjkLJu6+ym8c9Iu9qxB9Q07wbDl+rUzjzWZ8ZPpwdfh3fJ00gQjLYlmeKe
sn+Smi1gWeDmLa3PjS0Zxv74OeFl+DyDjcxeHKfprNoKlyVAMm2VOQBn9m3UigVD
llMTP+MKLT5SNlE9ZO7r7MBC09b/oP5k2XWkJnZxqbmo+lZNSNoG4x1rHvLzVs7I
jNAymcGm6TZVxL7hQ0LRGAjIXQSziNsrY2TmnHaUZi+t32Q24m05nnmJQtAOitUs
MdegKlumEiU1BHMHCjpAis+R7bmhg9VNVsD17kyvignQt5zFPIKmQQrUplMzBItB
X/IPVejVWF1k8l/TQGrED5apxEXO5N+ZIo2UdmS5HupOpWQ9WX95QDxpChlUZe6K
19oY257gufCubnzWx8QFj1SNl1BXyB4Icq+E21OkUVnZYE8qufdldN0hUOMc7PEl
PCSakThGbT4BTjEztFD3UbblqMmPBEVI4lBcWBCHqHJJnSKTQF0FSGTEgWrRZLO8
fa/GtaZCg2ceMP/PF8ooDmftzrin5sSQTV7A0lrWNMzlQdMJERP5qDrfpXNERxmw
eGoUwRmSMEZpN9SbIHUFK6GH3QG1zi0tCN5UjGaIFjgKoV4QdDP0V0mJ6AzEewgH
XnYrKxMmPS1yBTic3UNQ
=tA90
-----END PGP SIGNATURE-----
