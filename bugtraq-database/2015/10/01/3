
Date: Thu, 1 Oct 2015 08:56:34 GMT
From: matthias.deeg@...s.de
To: bugtraq@...urityfocus.com
Subject: [SYSS-2015-009] Kaspersky Anti-Virus - Authentication Bypass

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Advisory ID: SYSS-2015-009
Product: Kaspersky Anti-Virus (KAV)
Vendor: Kaspersky Lab ZAO
Affected Version(s): 15.0.1.415
Tested Version(s): 15.0.1.415
Vulnerability Type: Authentication Bypass Using an Alternate Path or 
                    Channel (CWE-288)
Risk Level: Medium
Solution Status: Fixed
Vendor Notification: 2015-02-19
Solution Date: 2015-10-01
Public Disclosure: 2015-10-01
CVE Reference: Not yet assigned
Authors of Advisory: Matthias Deeg and Sven Freund (SySS GmbH)

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Overview:

Kaspersky Anti-Virus is an endpoint protection software with many
features defending users against different threats.

The vendor Kaspersky describes the product as follows (see [1]):

"Kaspersky Anti-Virus 2015 is your PC's first line of defense against
today's complex malware threats. From the moment it's installed, you
benefit from essential, real-time protection against the latest malware
attacks - without affecting your PC's performance."

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Vulnerability Details:

The Kaspersky Anti-Virus software allows users to disable the offered
protection by entering a so-called unload password. Beside the graphical
user interface (GUI) authentication, it is also possible to manually
deactivate the protection over the command-line interface using the
Kaspersky software tool avp.exe.

By analyzing the password-based authentication for unloading the
Kaspersky Anti-Virus protection, the SySS GmbH found out, that the
password comparison is done within the process avp.exe (actually within
the used module shell_service.dll), which runs or can be run in the
context of the current Windows user, who can also be a standard, limited
user.

This fact allows a further analysis and the manipulation of the password
comparison during runtime without administrative privileges, as every 
user is able to debug and manipulate the processes running with her user
privileges.

In order to bypass the password-based authentication to deactivate the 
protection of Kaspersky Anti-Virus in an unauthorized manner, an
attacker only has to patch this password comparison, so that it always
returns true, for example by comparing the correct unload password with
itself or by modifying the program control flow.

The SySS GmbH also found out, that by modifying the software tool
avp.exe, Kaspersky Anti-Virus can also be deactivated completely even
when no password was set for protecting administrative functions. The
intended behavior of the software tool avp.exe in this case is to deny
access to the requested function, for example "exit", due to a disabled
password protection.

Thus, a limited Windows user or malware running in the context of such a
user is able to unload Kaspersky Anti-Virus in an unauthorized manner
regardless of the configured password protection.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Proof of Concept (PoC):

The SySS GmbH developed a proof-of-concept software tool named UnloadKAV
for deactivating Kaspersky Anti-Virus in an unauthorized manner.

The following output exemplarily shows a successful deactivation of
Kaspersky Anti-Virus:

>UnloadKAV.exe
                ____________________________________________________________
               /    _____       _____ _____                                 \
              /    /  ___|     /  ___/  ___|                                 \
             |     \ `--. _   _\ `--.\ `--.                                   |
             |      `--. \ | | |`--. \`--. \                                  |
             |     /\__/ / |_| /\__/ /\__/ /                                  |
              \    \____/ \__, \____/\____/   ... unloads KAV!               /
               \          __/ |                                             /
               /         |___/    _________________________________________/
              / _________________/
        (__) /_/
        (oo)
  /------\/
 / |____||
*  ||   ||
   ^^   ^^
SySS Unload KAV v1.0 by Matthias Deeg & Sven Freund - SySS GmbH (c) 2015

[+] Found location of the executable file avp.exe
[+] Created new instance of the Kaspersky Anti-Virus process avp.exe
[+] The Kaspersky Anti-Virus process was patched successfully.
    Kaspersky Anti-Virus will now exit without a password.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Solution:

According to information by Kaspersky, the described security issue has
been fixed in newer software releases.

Please contact the manufacturer for further information or support.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Disclosure Timeline:

2015-02-19: Vulnerability reported to vendor
2015-02-20: Vendor acknowledges e-mail with SySS security advisory          
2015-03-17: Rescheduling of the publication date in agreement with the
            manufacturer
2015-04-14: Rescheduling of the publication date in agreement with the
            manufacturer
2015-09-28: SySS asks for further information about software fix
2015-10-01: Public release of security advisory on agreed publication
            date

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

References:

[1] Product Web site for Kaspersky Anti-Virus
    http://www.kaspersky.com/anti-virus
[2] SySS Security Advisory SYSS-2015-009
    https://www.syss.de/fileadmin/dokumente/Publikationen/Advisories/SYSS-2015-009.txt
[3] SySS Responsible Disclosure Policy
    https://www.syss.de/en/news/responsible-disclosure-policy/

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Credits:

This security vulnerability was found by Matthias Deeg and Sven Freund
of the SySS GmbH.

E-Mail: matthias.deeg (at) syss.de
Public Key: https://www.syss.de/fileadmin/dokumente/Materialien/PGPKeys/Matthias_Deeg.asc
Key fingerprint = D1F0 A035 F06C E675 CDB9 0514 D9A4 BF6A 34AD 4DAB

E-Mail: sven.freund (at) syss.de
Public Key: https://www.syss.de/fileadmin/dokumente/Materialien/PGPKeys/Sven_Freund.asc
Key fingerprint = DCDB 7627 C1E3 9CE8 62DF 2666 8A5F A853 415D 46DC

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Disclaimer:

The information provided in this security advisory is provided "as is" 
and without warranty of any kind. Details of this security advisory may 
be updated in order to provide as accurate information as possible. The
latest version of this security advisory is available on the SySS Web 
site.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Copyright:

Creative Commons - Attribution (by) - Version 3.0
URL: http://creativecommons.org/licenses/by/3.0/deed.en

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2

iQIcBAEBCgAGBQJWDPClAAoJENmkv2o0rU2rbF8P/2lMxS3R4F3Z/AdQrRkzPZbl
NiaXjzd1HhV4dwlJ0/Bgw3t8kp2yOClfHMJY6vOLTUge236jm1T6voFsCnSfpumV
nRtKlJ7jxMIiug4AGJPmINEyoTnAS9GYPNVqrEDbDVkXF6H8Xtsd/Iu4IKcoI2yA
hsYxwnFpYL/OSnqcL/fy13oLJVTNY8Ppqs9HEHPZQLrz4CDPfcZj4fK6LpHZwycb
UsU6oEXaI0AjWu47qcijcLtBUC3QBrwSKHCEO/7Xk8GaOZ5EDPYgMyjMN1gofIOv
h9L+J1pCa6+a99ewuTlpbjPE4gQO44DxoaSUQ5LjZQs31TU90wli0oQggEFFN66Q
wodxfnGnF/Nr9F2cqJWKR85iYdkMH4EgpDhS99HUW1UnZeXJvpx4O4DSf46orOfz
hdwtjPFy4h+PUZclVGBzksPrRjB2QekbAqNP2/sddSxuzN5OvcbdSo8SHGc81UBw
uZFLuodWByeW45cjWhAOGrGXurOAKk4ayYOEXRbpFkt1+pobb+HlIEDn2wJ79PDL
oI9ciohSLe6UIBJqom9UU3urqKC7zotviO88iXGI41We/HU8TjlP2Y8T9hlLwD18
T0W7cJWEGT9qD6WL5VHJb2LHwjHLPzbXq4deSLaAAJULsJnP3xfsfuNb9rRd7WuG
UTh4M/rZg2gUV/tU8iXK
=qihO
-----END PGP SIGNATURE-----
