From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-47469: spi: Fix deadlock when adding SPI controllers on SPI buses

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

spi: Fix deadlock when adding SPI controllers on SPI buses

Currently we have a global spi_add_lock which we take when adding new
devices so that we can check that we're not trying to reuse a chip
select that's already controlled.  This means that if the SPI device is
itself a SPI controller and triggers the instantiation of further SPI
devices we trigger a deadlock as we try to register and instantiate
those devices while in the process of doing so for the parent controller
and hence already holding the global spi_add_lock.  Since we only care
about concurrency within a single SPI bus move the lock to be per
controller, avoiding the deadlock.

This can be easily triggered in the case of spi-mux.

The Linux kernel CVE team has assigned CVE-2021-47469 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.4.286 with commit aa3f3d7bef59583f2d3234173105a27ff61ef8fe
	Fixed in 5.10.230 with commit c8dce228db6f81dbc897a018dfc5c418e917cf64
	Fixed in 5.14.15 with commit 722ef19a161ce3fffb3d1b01ce2301c306639bdd
	Fixed in 5.15 with commit 6098475d4cb48d821bdf453c61118c56e26294f0

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-47469
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/spi/spi.c
	include/linux/spi/spi.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/aa3f3d7bef59583f2d3234173105a27ff61ef8fe
	https://git.kernel.org/stable/c/c8dce228db6f81dbc897a018dfc5c418e917cf64
	https://git.kernel.org/stable/c/722ef19a161ce3fffb3d1b01ce2301c306639bdd
	https://git.kernel.org/stable/c/6098475d4cb48d821bdf453c61118c56e26294f0
