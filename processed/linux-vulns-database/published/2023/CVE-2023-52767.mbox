From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-52767: tls: fix NULL deref on tls_sw_splice_eof() with empty record

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

tls: fix NULL deref on tls_sw_splice_eof() with empty record

syzkaller discovered that if tls_sw_splice_eof() is executed as part of
sendfile() when the plaintext/ciphertext sk_msg are empty, the send path
gets confused because the empty ciphertext buffer does not have enough
space for the encryption overhead. This causes tls_push_record() to go on
the `split = true` path (which is only supposed to be used when interacting
with an attached BPF program), and then get further confused and hit the
tls_merge_open_record() path, which then assumes that there must be at
least one populated buffer element, leading to a NULL deref.

It is possible to have empty plaintext/ciphertext buffers if we previously
bailed from tls_sw_sendmsg_locked() via the tls_trim_both_msgs() path.
tls_sw_push_pending_record() already handles this case correctly; let's do
the same check in tls_sw_splice_eof().

The Linux kernel CVE team has assigned CVE-2023-52767 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.5 with commit df720d288dbb1793e82b6ccbfc670ec871e9def4 and fixed in 6.6.4 with commit 2214e2bb5489145aba944874d0ee1652a0a63dc8
	Issue introduced in 6.5 with commit df720d288dbb1793e82b6ccbfc670ec871e9def4 and fixed in 6.7 with commit 53f2cb491b500897a619ff6abd72f565933760f0

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-52767
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/tls/tls_sw.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/944900fe2736c07288efe2d9394db4d3ca23f2c9
	https://git.kernel.org/stable/c/2214e2bb5489145aba944874d0ee1652a0a63dc8
	https://git.kernel.org/stable/c/53f2cb491b500897a619ff6abd72f565933760f0
