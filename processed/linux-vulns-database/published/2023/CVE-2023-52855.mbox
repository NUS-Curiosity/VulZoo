From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-52855: usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency

In _dwc2_hcd_urb_enqueue(), "urb->hcpriv = NULL" is executed without
holding the lock "hsotg->lock". In _dwc2_hcd_urb_dequeue():

    spin_lock_irqsave(&hsotg->lock, flags);
    ...
	if (!urb->hcpriv) {
		dev_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
		goto out;
	}
    rc = dwc2_hcd_urb_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
    ...
out:
    spin_unlock_irqrestore(&hsotg->lock, flags);

When _dwc2_hcd_urb_enqueue() and _dwc2_hcd_urb_dequeue() are
concurrently executed, the NULL check of "urb->hcpriv" can be executed
before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
in the function call to dwc2_hcd_urb_dequeue(), which can cause a NULL
pointer dereference.

This possible bug is found by an experimental static analysis tool
developed by myself. This tool analyzes the locking APIs to extract
function pairs that can be concurrently executed, and then analyzes the
instructions in the paired functions to identify possible concurrency
bugs including data races and atomicity violations. The above possible
bug is reported, when my tool analyzes the source code of Linux 6.5.

To fix this possible bug, "urb->hcpriv = NULL" should be executed with
holding the lock "hsotg->lock". After using this patch, my tool never
reports the possible bug, with the kernelconfiguration allyesconfig for
x86_64. Because I have no associated hardware, I cannot test the patch
in runtime testing, and just verify it according to the code logic.

The Linux kernel CVE team has assigned CVE-2023-52855 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.2 with commit 33ad261aa62be02f0cedeb4d5735cc726de84a3f and fixed in 4.14.330 with commit 14c9ec34e8118fbffd7f5431814d767726323e72
	Issue introduced in 4.2 with commit 33ad261aa62be02f0cedeb4d5735cc726de84a3f and fixed in 4.19.299 with commit fed492aa6493a91a77ebd51da6fb939c98d94a0d
	Issue introduced in 4.2 with commit 33ad261aa62be02f0cedeb4d5735cc726de84a3f and fixed in 5.4.261 with commit 64c47749fc7507ed732e155c958253968c1d275e
	Issue introduced in 4.2 with commit 33ad261aa62be02f0cedeb4d5735cc726de84a3f and fixed in 5.10.201 with commit bdb3dd4096302d6b87441fdc528439f171b04be6
	Issue introduced in 4.2 with commit 33ad261aa62be02f0cedeb4d5735cc726de84a3f and fixed in 5.15.139 with commit fcaafb574fc88a52dce817f039f7ff2f9da38001
	Issue introduced in 4.2 with commit 33ad261aa62be02f0cedeb4d5735cc726de84a3f and fixed in 6.1.63 with commit 6b21a22728852d020a6658d39cd7bb7e14b07790
	Issue introduced in 4.2 with commit 33ad261aa62be02f0cedeb4d5735cc726de84a3f and fixed in 6.5.12 with commit 3e851a77a13ce944d703721793f49ee82622986d
	Issue introduced in 4.2 with commit 33ad261aa62be02f0cedeb4d5735cc726de84a3f and fixed in 6.6.2 with commit a7bee9598afb38004841a41dd8fe68c1faff4e90
	Issue introduced in 4.2 with commit 33ad261aa62be02f0cedeb4d5735cc726de84a3f and fixed in 6.7 with commit ef307bc6ef04e8c1ea843231db58e3afaafa9fa6

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-52855
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/usb/dwc2/hcd.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/14c9ec34e8118fbffd7f5431814d767726323e72
	https://git.kernel.org/stable/c/fed492aa6493a91a77ebd51da6fb939c98d94a0d
	https://git.kernel.org/stable/c/64c47749fc7507ed732e155c958253968c1d275e
	https://git.kernel.org/stable/c/bdb3dd4096302d6b87441fdc528439f171b04be6
	https://git.kernel.org/stable/c/fcaafb574fc88a52dce817f039f7ff2f9da38001
	https://git.kernel.org/stable/c/6b21a22728852d020a6658d39cd7bb7e14b07790
	https://git.kernel.org/stable/c/3e851a77a13ce944d703721793f49ee82622986d
	https://git.kernel.org/stable/c/a7bee9598afb38004841a41dd8fe68c1faff4e90
	https://git.kernel.org/stable/c/ef307bc6ef04e8c1ea843231db58e3afaafa9fa6
