From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-52527: ipv4, ipv6: Fix handling of transhdrlen in __ip{,6}_append_data()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ipv4, ipv6: Fix handling of transhdrlen in __ip{,6}_append_data()

Including the transhdrlen in length is a problem when the packet is
partially filled (e.g. something like send(MSG_MORE) happened previously)
when appending to an IPv4 or IPv6 packet as we don't want to repeat the
transport header or account for it twice.  This can happen under some
circumstances, such as splicing into an L2TP socket.

The symptom observed is a warning in __ip6_append_data():

    WARNING: CPU: 1 PID: 5042 at net/ipv6/ip6_output.c:1800 __ip6_append_data.isra.0+0x1be8/0x47f0 net/ipv6/ip6_output.c:1800

that occurs when MSG_SPLICE_PAGES is used to append more data to an already
partially occupied skbuff.  The warning occurs when 'copy' is larger than
the amount of data in the message iterator.  This is because the requested
length includes the transport header length when it shouldn't.  This can be
triggered by, for example:

        sfd = socket(AF_INET6, SOCK_DGRAM, IPPROTO_L2TP);
        bind(sfd, ...); // ::1
        connect(sfd, ...); // ::1 port 7
        send(sfd, buffer, 4100, MSG_MORE);
        sendfile(sfd, dfd, NULL, 1024);

Fix this by only adding transhdrlen into the length if the write queue is
empty in l2tp_ip6_sendmsg(), analogously to how UDP does things.

l2tp_ip_sendmsg() looks like it won't suffer from this problem as it builds
the UDP packet itself.

The Linux kernel CVE team has assigned CVE-2023-52527 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.5 with commit a32e0eec7042b21ccb52896cf715e3e2641fed93 and fixed in 4.14.327 with commit 7626b9fed53092aa2147978070e610ecb61af844
	Issue introduced in 3.5 with commit a32e0eec7042b21ccb52896cf715e3e2641fed93 and fixed in 4.19.296 with commit 559d697c5d072593d22b3e0bd8b8081108aeaf59
	Issue introduced in 3.5 with commit a32e0eec7042b21ccb52896cf715e3e2641fed93 and fixed in 5.4.258 with commit 1fc793d68d50dee4782ef2e808913d5dd880bcc6
	Issue introduced in 3.5 with commit a32e0eec7042b21ccb52896cf715e3e2641fed93 and fixed in 5.10.198 with commit 96b2e1090397217839fcd6c9b6d8f5d439e705ed
	Issue introduced in 3.5 with commit a32e0eec7042b21ccb52896cf715e3e2641fed93 and fixed in 5.15.135 with commit cd1189956393bf850b2e275e37411855d3bd86bb
	Issue introduced in 3.5 with commit a32e0eec7042b21ccb52896cf715e3e2641fed93 and fixed in 6.1.57 with commit f6a7182179c0ed788e3755ee2ed18c888ddcc33f
	Issue introduced in 3.5 with commit a32e0eec7042b21ccb52896cf715e3e2641fed93 and fixed in 6.5.7 with commit fe80658c08e3001c80c5533cd41abfbb0e0e28fd
	Issue introduced in 3.5 with commit a32e0eec7042b21ccb52896cf715e3e2641fed93 and fixed in 6.6 with commit 9d4c75800f61e5d75c1659ba201b6c0c7ead3070

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-52527
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/l2tp/l2tp_ip6.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/7626b9fed53092aa2147978070e610ecb61af844
	https://git.kernel.org/stable/c/559d697c5d072593d22b3e0bd8b8081108aeaf59
	https://git.kernel.org/stable/c/1fc793d68d50dee4782ef2e808913d5dd880bcc6
	https://git.kernel.org/stable/c/96b2e1090397217839fcd6c9b6d8f5d439e705ed
	https://git.kernel.org/stable/c/cd1189956393bf850b2e275e37411855d3bd86bb
	https://git.kernel.org/stable/c/f6a7182179c0ed788e3755ee2ed18c888ddcc33f
	https://git.kernel.org/stable/c/fe80658c08e3001c80c5533cd41abfbb0e0e28fd
	https://git.kernel.org/stable/c/9d4c75800f61e5d75c1659ba201b6c0c7ead3070
