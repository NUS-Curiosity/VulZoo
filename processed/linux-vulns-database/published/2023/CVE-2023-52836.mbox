From bippy-d175d3acf727 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-52836: locking/ww_mutex/test: Fix potential workqueue corruption

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

locking/ww_mutex/test: Fix potential workqueue corruption

In some cases running with the test-ww_mutex code, I was seeing
odd behavior where sometimes it seemed flush_workqueue was
returning before all the work threads were finished.

Often this would cause strange crashes as the mutexes would be
freed while they were being used.

Looking at the code, there is a lifetime problem as the
controlling thread that spawns the work allocates the
"struct stress" structures that are passed to the workqueue
threads. Then when the workqueue threads are finished,
they free the stress struct that was passed to them.

Unfortunately the workqueue work_struct node is in the stress
struct. Which means the work_struct is freed before the work
thread returns and while flush_workqueue is waiting.

It seems like a better idea to have the controlling thread
both allocate and free the stress structures, so that we can
be sure we don't corrupt the workqueue by freeing the structure
prematurely.

So this patch reworks the test to do so, and with this change
I no longer see the early flush_workqueue returns.

The Linux kernel CVE team has assigned CVE-2023-52836 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.14.331 with commit d4d37c9e6a4d
	Fixed in 4.19.300 with commit d8267cabbe1b
	Fixed in 5.4.262 with commit dcd85e3c9293
	Fixed in 5.10.202 with commit 9ed2d68b3925
	Fixed in 5.15.140 with commit e89d0ed45a41
	Fixed in 6.1.64 with commit c56df79d6867
	Fixed in 6.5.13 with commit e36407713163
	Fixed in 6.6.3 with commit 304a2c4aad0f
	Fixed in 6.7 with commit bccdd808902f

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-52836
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	kernel/locking/test-ww_mutex.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/d4d37c9e6a4dbcca958dabd99216550525c7e389
	https://git.kernel.org/stable/c/d8267cabbe1bed15ccf8b0e684c528bf8eeef715
	https://git.kernel.org/stable/c/dcd85e3c929368076a7592b27f541e0da8b427f5
	https://git.kernel.org/stable/c/9ed2d68b3925145f5f51c46559484881d6082f75
	https://git.kernel.org/stable/c/e89d0ed45a419c485bae999426ecf92697cbdda3
	https://git.kernel.org/stable/c/c56df79d68677cf062da1b6e3b33e74299a92dfc
	https://git.kernel.org/stable/c/e36407713163363e65566e7af0abe207d5f59a0c
	https://git.kernel.org/stable/c/304a2c4aad0fff887ce493e4197bf9cbaf394479
	https://git.kernel.org/stable/c/bccdd808902f8c677317cec47c306e42b93b849e
