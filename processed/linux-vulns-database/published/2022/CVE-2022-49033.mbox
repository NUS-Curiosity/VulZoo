From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49033: btrfs: qgroup: fix sleep from invalid context bug in btrfs_qgroup_inherit()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

btrfs: qgroup: fix sleep from invalid context bug in btrfs_qgroup_inherit()

Syzkaller reported BUG as follows:

  BUG: sleeping function called from invalid context at
       include/linux/sched/mm.h:274
  Call Trace:
   <TASK>
   dump_stack_lvl+0xcd/0x134
   __might_resched.cold+0x222/0x26b
   kmem_cache_alloc+0x2e7/0x3c0
   update_qgroup_limit_item+0xe1/0x390
   btrfs_qgroup_inherit+0x147b/0x1ee0
   create_subvol+0x4eb/0x1710
   btrfs_mksubvol+0xfe5/0x13f0
   __btrfs_ioctl_snap_create+0x2b0/0x430
   btrfs_ioctl_snap_create_v2+0x25a/0x520
   btrfs_ioctl+0x2a1c/0x5ce0
   __x64_sys_ioctl+0x193/0x200
   do_syscall_64+0x35/0x80

Fix this by calling qgroup_dirty() on @dstqgroup, and update limit item in
btrfs_run_qgroups() later outside of the spinlock context.

The Linux kernel CVE team has assigned CVE-2022-49033 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.9.335 with commit 89840b12c8fad7200eb6478525c13261512c01be
	Fixed in 4.14.301 with commit 3c98e91be6aea4c7acf09da6eb0c107ea9186bb5
	Fixed in 4.19.268 with commit f4b930a1602b05e77fee31f9616599b25e910a86
	Fixed in 5.4.226 with commit 8eb912af525042a7365295eb62f6d5270c2a6462
	Fixed in 5.10.158 with commit 01d7c41eac9129fba80d8aed0060caab4a7dbe09
	Fixed in 5.15.82 with commit 044da1a371a0da579e805e89c96865f62d8f6f69
	Fixed in 6.0.12 with commit 588ae4fdd8b11788a797776b10d6c44ae12bc133
	Fixed in 6.1 with commit f7e942b5bb35d8e3af54053d19a6bf04143a3955

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49033
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/btrfs/qgroup.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/89840b12c8fad7200eb6478525c13261512c01be
	https://git.kernel.org/stable/c/3c98e91be6aea4c7acf09da6eb0c107ea9186bb5
	https://git.kernel.org/stable/c/f4b930a1602b05e77fee31f9616599b25e910a86
	https://git.kernel.org/stable/c/8eb912af525042a7365295eb62f6d5270c2a6462
	https://git.kernel.org/stable/c/01d7c41eac9129fba80d8aed0060caab4a7dbe09
	https://git.kernel.org/stable/c/044da1a371a0da579e805e89c96865f62d8f6f69
	https://git.kernel.org/stable/c/588ae4fdd8b11788a797776b10d6c44ae12bc133
	https://git.kernel.org/stable/c/f7e942b5bb35d8e3af54053d19a6bf04143a3955
