From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49274: ocfs2: fix crash when mount with quota enabled

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ocfs2: fix crash when mount with quota enabled

There is a reported crash when mounting ocfs2 with quota enabled.

  RIP: 0010:ocfs2_qinfo_lock_res_init+0x44/0x50 [ocfs2]
  Call Trace:
    ocfs2_local_read_info+0xb9/0x6f0 [ocfs2]
    dquot_load_quota_sb+0x216/0x470
    dquot_load_quota_inode+0x85/0x100
    ocfs2_enable_quotas+0xa0/0x1c0 [ocfs2]
    ocfs2_fill_super.cold+0xc8/0x1bf [ocfs2]
    mount_bdev+0x185/0x1b0
    legacy_get_tree+0x27/0x40
    vfs_get_tree+0x25/0xb0
    path_mount+0x465/0xac0
    __x64_sys_mount+0x103/0x140

It is caused by when initializing dqi_gqlock, the corresponding dqi_type
and dqi_sb are not properly initialized.

This issue is introduced by commit 6c85c2c72819, which wants to avoid
accessing uninitialized variables in error cases.  So make global quota
info properly initialized.

The Linux kernel CVE team has assigned CVE-2022-49274 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.15 with commit 6c85c2c728193d19d6a908ae9fb312d0325e65ca and fixed in 5.15.33 with commit 7c5312fdb1dcfdc1951b018669af88d5d6420b31
	Issue introduced in 5.15 with commit 6c85c2c728193d19d6a908ae9fb312d0325e65ca and fixed in 5.16.19 with commit 01931e1c4e3de5d777253acae64c0e8fd071a1dd
	Issue introduced in 5.15 with commit 6c85c2c728193d19d6a908ae9fb312d0325e65ca and fixed in 5.17.2 with commit eda31f77317647b9fbf889779ee1fb6907651865
	Issue introduced in 5.15 with commit 6c85c2c728193d19d6a908ae9fb312d0325e65ca and fixed in 5.18 with commit de19433423c7bedabbd4f9a25f7dbc62c5e78921

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49274
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/ocfs2/quota_global.c
	fs/ocfs2/quota_local.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/7c5312fdb1dcfdc1951b018669af88d5d6420b31
	https://git.kernel.org/stable/c/01931e1c4e3de5d777253acae64c0e8fd071a1dd
	https://git.kernel.org/stable/c/eda31f77317647b9fbf889779ee1fb6907651865
	https://git.kernel.org/stable/c/de19433423c7bedabbd4f9a25f7dbc62c5e78921
