From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49315: drivers: staging: rtl8192e: Fix deadlock in rtllib_beacons_stop()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

drivers: staging: rtl8192e: Fix deadlock in rtllib_beacons_stop()

There is a deadlock in rtllib_beacons_stop(), which is shown
below:

   (Thread 1)              |      (Thread 2)
                           | rtllib_send_beacon()
rtllib_beacons_stop()      |  mod_timer()
 spin_lock_irqsave() //(1) |  (wait a time)
 ...                       | rtllib_send_beacon_cb()
 del_timer_sync()          |  spin_lock_irqsave() //(2)
 (wait timer to stop)      |  ...

We hold ieee->beacon_lock in position (1) of thread 1 and
use del_timer_sync() to wait timer to stop, but timer handler
also need ieee->beacon_lock in position (2) of thread 2.
As a result, rtllib_beacons_stop() will block forever.

This patch extracts del_timer_sync() from the protection of
spin_lock_irqsave(), which could let timer handler to obtain
the needed lock.

The Linux kernel CVE team has assigned CVE-2022-49315 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.9.318 with commit 4681129fda9e8555392eaaadb239ec6a6e2b3e12
	Fixed in 4.14.283 with commit 381045dc64d23a2229c47c5524c06bfc33d34446
	Fixed in 4.19.247 with commit 08bacf871c019163ccd1389d0bc957a43324967a
	Fixed in 5.4.198 with commit 64b05fa212c7e4d057676e8b7e7120c6eb2f615b
	Fixed in 5.10.122 with commit 0f69d7d5e918aa43423d86bd17ddb11b1b5e8ada
	Fixed in 5.15.47 with commit fef451f0fbbe85dbd2962b18379d02e2965610db
	Fixed in 5.17.15 with commit 46c861009bf437a18417df24cea0d181741b7d72
	Fixed in 5.18.4 with commit ffd4c4d5293e4985092ea45ba21cad9326e2e434
	Fixed in 5.19 with commit 9b6bdbd9337de3917945847bde262a34a87a6303

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49315
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/staging/rtl8192e/rtllib_softmac.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/4681129fda9e8555392eaaadb239ec6a6e2b3e12
	https://git.kernel.org/stable/c/381045dc64d23a2229c47c5524c06bfc33d34446
	https://git.kernel.org/stable/c/08bacf871c019163ccd1389d0bc957a43324967a
	https://git.kernel.org/stable/c/64b05fa212c7e4d057676e8b7e7120c6eb2f615b
	https://git.kernel.org/stable/c/0f69d7d5e918aa43423d86bd17ddb11b1b5e8ada
	https://git.kernel.org/stable/c/fef451f0fbbe85dbd2962b18379d02e2965610db
	https://git.kernel.org/stable/c/46c861009bf437a18417df24cea0d181741b7d72
	https://git.kernel.org/stable/c/ffd4c4d5293e4985092ea45ba21cad9326e2e434
	https://git.kernel.org/stable/c/9b6bdbd9337de3917945847bde262a34a87a6303
