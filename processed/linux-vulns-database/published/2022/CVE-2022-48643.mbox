From bippy-d175d3acf727 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-48643: netfilter: nf_tables: fix nft_counters_enabled underflow at nf_tables_addchain()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

netfilter: nf_tables: fix nft_counters_enabled underflow at nf_tables_addchain()

syzbot is reporting underflow of nft_counters_enabled counter at
nf_tables_addchain() [1], for commit 43eb8949cfdffa76 ("netfilter:
nf_tables: do not leave chain stats enabled on error") missed that
nf_tables_chain_destroy() after nft_basechain_init() in the error path of
nf_tables_addchain() decrements the counter because nft_basechain_init()
makes nft_is_base_chain() return true by setting NFT_CHAIN_BASE flag.

Increment the counter immediately after returning from
nft_basechain_init().

The Linux kernel CVE team has assigned CVE-2022-48643 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.10.140 with commit c907dfe4eaca and fixed in 5.10.146 with commit 710e3f526bd2
	Issue introduced in 5.15.64 with commit 6d7ddee50395 and fixed in 5.15.71 with commit 91aa52652f4b
	Issue introduced in 5.19.6 with commit 98a621ef45e3 and fixed in 5.19.12 with commit 8bcad2a93131

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-48643
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/netfilter/nf_tables_api.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/710e3f526bd23a0d33435dedc52c3144de284378
	https://git.kernel.org/stable/c/91aa52652f4b37089aff3cb53e83049d826fef6d
	https://git.kernel.org/stable/c/8bcad2a931313aeba076b76922d5813ef97d0a91
	https://git.kernel.org/stable/c/921ebde3c0d22c8cba74ce8eb3cc4626abff1ccd
