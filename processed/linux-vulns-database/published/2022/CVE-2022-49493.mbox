From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49493: ASoC: rt5645: Fix errorenous cleanup order

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ASoC: rt5645: Fix errorenous cleanup order

There is a logic error when removing rt5645 device as the function
rt5645_i2c_remove() first cancel the &rt5645->jack_detect_work and
delete the &rt5645->btn_check_timer latter. However, since the timer
handler rt5645_btn_check_callback() will re-queue the jack_detect_work,
this cleanup order is buggy.

That is, once the del_timer_sync in rt5645_i2c_remove is concurrently
run with the rt5645_btn_check_callback, the canceled jack_detect_work
will be rescheduled again, leading to possible use-after-free.

This patch fix the issue by placing the del_timer_sync function before
the cancel_delayed_work_sync.

The Linux kernel CVE team has assigned CVE-2022-49493 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.9.318 with commit 7d801e807536a9a9c2146c5f4a5836f154517ed3
	Fixed in 4.14.283 with commit 236d29c5857f02e0a53fdf15d3dce1536c4322ce
	Fixed in 4.19.247 with commit 0941150100173d4eaf3fe08ff4b16740e7c3026f
	Fixed in 5.4.198 with commit abe7554da62cb489712a54de69ef5665c250e564
	Fixed in 5.10.121 with commit 1a5a3dfd9f172dcb115072f0aea5e27d3083c20e
	Fixed in 5.15.46 with commit 061a6159cea583f1155f67d1915917a6b9282662
	Fixed in 5.17.14 with commit 88c09e4812d72c3153afc8e5a45ecac2d0eae3ff
	Fixed in 5.18.3 with commit 453f0920ffc1a28e28ddb9c3cd5562472b2895b0
	Fixed in 5.19 with commit 2def44d3aec59e38d2701c568d65540783f90f2f

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49493
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	sound/soc/codecs/rt5645.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/7d801e807536a9a9c2146c5f4a5836f154517ed3
	https://git.kernel.org/stable/c/236d29c5857f02e0a53fdf15d3dce1536c4322ce
	https://git.kernel.org/stable/c/0941150100173d4eaf3fe08ff4b16740e7c3026f
	https://git.kernel.org/stable/c/abe7554da62cb489712a54de69ef5665c250e564
	https://git.kernel.org/stable/c/1a5a3dfd9f172dcb115072f0aea5e27d3083c20e
	https://git.kernel.org/stable/c/061a6159cea583f1155f67d1915917a6b9282662
	https://git.kernel.org/stable/c/88c09e4812d72c3153afc8e5a45ecac2d0eae3ff
	https://git.kernel.org/stable/c/453f0920ffc1a28e28ddb9c3cd5562472b2895b0
	https://git.kernel.org/stable/c/2def44d3aec59e38d2701c568d65540783f90f2f
