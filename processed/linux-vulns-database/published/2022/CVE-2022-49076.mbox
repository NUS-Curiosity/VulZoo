From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49076: RDMA/hfi1: Fix use-after-free bug for mm struct

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

RDMA/hfi1: Fix use-after-free bug for mm struct

Under certain conditions, such as MPI_Abort, the hfi1 cleanup code may
represent the last reference held on the task mm.
hfi1_mmu_rb_unregister() then drops the last reference and the mm is freed
before the final use in hfi1_release_user_pages().  A new task may
allocate the mm structure while it is still being used, resulting in
problems. One manifestation is corruption of the mmap_sem counter leading
to a hang in down_write().  Another is corruption of an mm struct that is
in use by another task.

The Linux kernel CVE team has assigned CVE-2022-49076 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.10 with commit 3d2a9d642512c21a12d19b9250e7a835dcb41a79 and fixed in 5.10.111 with commit 5f54364ff6cfcd14cddf5441c4a490bb28dd69f7
	Issue introduced in 5.10 with commit 3d2a9d642512c21a12d19b9250e7a835dcb41a79 and fixed in 5.15.34 with commit 9ca11bd8222a612de0d2f54d050bfcf61ae2883f
	Issue introduced in 5.10 with commit 3d2a9d642512c21a12d19b9250e7a835dcb41a79 and fixed in 5.16.20 with commit 0b7186d657ee55e2cdefae498f07d5c1961e8023
	Issue introduced in 5.10 with commit 3d2a9d642512c21a12d19b9250e7a835dcb41a79 and fixed in 5.17.3 with commit 5a9a1b24ddb510715f8f621263938186579a965c
	Issue introduced in 5.10 with commit 3d2a9d642512c21a12d19b9250e7a835dcb41a79 and fixed in 5.18 with commit 2bbac98d0930e8161b1957dc0ec99de39ade1b3c
	Issue introduced in 5.9.12 with commit 5732f83596f8a573f2cde814cc76a54e1a8995c7

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49076
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/infiniband/hw/hfi1/mmu_rb.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/5f54364ff6cfcd14cddf5441c4a490bb28dd69f7
	https://git.kernel.org/stable/c/9ca11bd8222a612de0d2f54d050bfcf61ae2883f
	https://git.kernel.org/stable/c/0b7186d657ee55e2cdefae498f07d5c1961e8023
	https://git.kernel.org/stable/c/5a9a1b24ddb510715f8f621263938186579a965c
	https://git.kernel.org/stable/c/2bbac98d0930e8161b1957dc0ec99de39ade1b3c
