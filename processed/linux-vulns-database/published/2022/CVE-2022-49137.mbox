From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49137: drm/amd/amdgpu/amdgpu_cs: fix refcount leak of a dma_fence obj

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

drm/amd/amdgpu/amdgpu_cs: fix refcount leak of a dma_fence obj

This issue takes place in an error path in
amdgpu_cs_fence_to_handle_ioctl(). When `info->in.what` falls into
default case, the function simply returns -EINVAL, forgetting to
decrement the reference count of a dma_fence obj, which is bumped
earlier by amdgpu_cs_get_fence(). This may result in reference count
leaks.

Fix it by decreasing the refcount of specific object before returning
the error code.

The Linux kernel CVE team has assigned CVE-2022-49137 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.19.238 with commit 72d77ddb2224ebc00648f4f78f8a9a259dccbdf7
	Fixed in 5.4.189 with commit 4009f104b02b223d1a11d74b36b1cc083bc37028
	Fixed in 5.10.111 with commit 927beb05aaa429c883cc0ec6adc48964b187e291
	Fixed in 5.15.34 with commit 3edd8646cb7c11b57c90e026bda6f21076223f5b
	Fixed in 5.16.20 with commit b6d1f7d97c81ebaf2cda9c4c943ee2e484fffdcf
	Fixed in 5.17.3 with commit bc2d5c0775c839e2b072884f4ee6a93ba410f107
	Fixed in 5.18 with commit dfced44f122c500004a48ecc8db516bb6a295a1b

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49137
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/gpu/drm/amd/amdgpu/amdgpu_cs.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/72d77ddb2224ebc00648f4f78f8a9a259dccbdf7
	https://git.kernel.org/stable/c/4009f104b02b223d1a11d74b36b1cc083bc37028
	https://git.kernel.org/stable/c/927beb05aaa429c883cc0ec6adc48964b187e291
	https://git.kernel.org/stable/c/3edd8646cb7c11b57c90e026bda6f21076223f5b
	https://git.kernel.org/stable/c/b6d1f7d97c81ebaf2cda9c4c943ee2e484fffdcf
	https://git.kernel.org/stable/c/bc2d5c0775c839e2b072884f4ee6a93ba410f107
	https://git.kernel.org/stable/c/dfced44f122c500004a48ecc8db516bb6a295a1b
