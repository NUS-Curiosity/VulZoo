From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49017: tipc: re-fetch skb cb after tipc_msg_validate

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

tipc: re-fetch skb cb after tipc_msg_validate

As the call trace shows, the original skb was freed in tipc_msg_validate(),
and dereferencing the old skb cb would cause an use-after-free crash.

  BUG: KASAN: use-after-free in tipc_crypto_rcv_complete+0x1835/0x2240 [tipc]
  Call Trace:
   <IRQ>
   tipc_crypto_rcv_complete+0x1835/0x2240 [tipc]
   tipc_crypto_rcv+0xd32/0x1ec0 [tipc]
   tipc_rcv+0x744/0x1150 [tipc]
  ...
  Allocated by task 47078:
   kmem_cache_alloc_node+0x158/0x4d0
   __alloc_skb+0x1c1/0x270
   tipc_buf_acquire+0x1e/0xe0 [tipc]
   tipc_msg_create+0x33/0x1c0 [tipc]
   tipc_link_build_proto_msg+0x38a/0x2100 [tipc]
   tipc_link_timeout+0x8b8/0xef0 [tipc]
   tipc_node_timeout+0x2a1/0x960 [tipc]
   call_timer_fn+0x2d/0x1c0
  ...
  Freed by task 47078:
   tipc_msg_validate+0x7b/0x440 [tipc]
   tipc_crypto_rcv_complete+0x4b5/0x2240 [tipc]
   tipc_crypto_rcv+0xd32/0x1ec0 [tipc]
   tipc_rcv+0x744/0x1150 [tipc]

This patch fixes it by re-fetching the skb cb from the new allocated skb
after calling tipc_msg_validate().

The Linux kernel CVE team has assigned CVE-2022-49017 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.5 with commit fc1b6d6de2208774efd2a20bf0daddb02d18b1e0 and fixed in 5.10.158 with commit a1ba595e35aa3afbe417ff0af353afb9f65559c0
	Issue introduced in 5.5 with commit fc1b6d6de2208774efd2a20bf0daddb02d18b1e0 and fixed in 5.15.82 with commit 1daec0815655e110c6f206c5e777a4af8168ff58
	Issue introduced in 5.5 with commit fc1b6d6de2208774efd2a20bf0daddb02d18b1e0 and fixed in 6.0.12 with commit e128190adb2edfd5042105b5d1ed4553f295f5ef
	Issue introduced in 5.5 with commit fc1b6d6de2208774efd2a20bf0daddb02d18b1e0 and fixed in 6.1 with commit 3067bc61fcfe3081bf4807ce65560f499e895e77

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49017
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/tipc/crypto.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/a1ba595e35aa3afbe417ff0af353afb9f65559c0
	https://git.kernel.org/stable/c/1daec0815655e110c6f206c5e777a4af8168ff58
	https://git.kernel.org/stable/c/e128190adb2edfd5042105b5d1ed4553f295f5ef
	https://git.kernel.org/stable/c/3067bc61fcfe3081bf4807ce65560f499e895e77
