From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49118: scsi: hisi_sas: Free irq vectors in order for v3 HW

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

scsi: hisi_sas: Free irq vectors in order for v3 HW

If the driver probe fails to request the channel IRQ or fatal IRQ, the
driver will free the IRQ vectors before freeing the IRQs in free_irq(),
and this will cause a kernel BUG like this:

------------[ cut here ]------------
kernel BUG at drivers/pci/msi.c:369!
Internal error: Oops - BUG: 0 [#1] PREEMPT SMP
Call trace:
   free_msi_irqs+0x118/0x13c
   pci_disable_msi+0xfc/0x120
   pci_free_irq_vectors+0x24/0x3c
   hisi_sas_v3_probe+0x360/0x9d0 [hisi_sas_v3_hw]
   local_pci_probe+0x44/0xb0
   work_for_cpu_fn+0x20/0x34
   process_one_work+0x1d0/0x340
   worker_thread+0x2e0/0x460
   kthread+0x180/0x190
   ret_from_fork+0x10/0x20
---[ end trace b88990335b610c11 ]---

So we use devm_add_action() to control the order in which we free the
vectors.

The Linux kernel CVE team has assigned CVE-2022-49118 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.10.111 with commit 224903cc60d045576393c3b16907742f23e6c740
	Fixed in 5.15.34 with commit f05a0d8de2ea49af36821a20b0b501e20ced937e
	Fixed in 5.16.20 with commit 8b6eab9d683bae7f88dc894b8c851f866032301c
	Fixed in 5.17.3 with commit b4cc04fa8f1fc3816c8494d77abab3f72b9d2292
	Fixed in 5.18 with commit 554fb72ee34f4732c7f694f56c3c6e67790352a0

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49118
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/scsi/hisi_sas/hisi_sas_v3_hw.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/224903cc60d045576393c3b16907742f23e6c740
	https://git.kernel.org/stable/c/f05a0d8de2ea49af36821a20b0b501e20ced937e
	https://git.kernel.org/stable/c/8b6eab9d683bae7f88dc894b8c851f866032301c
	https://git.kernel.org/stable/c/b4cc04fa8f1fc3816c8494d77abab3f72b9d2292
	https://git.kernel.org/stable/c/554fb72ee34f4732c7f694f56c3c6e67790352a0
