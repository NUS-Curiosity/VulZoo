From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-48660: gpiolib: cdev: Set lineevent_state::irq after IRQ register successfully

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

gpiolib: cdev: Set lineevent_state::irq after IRQ register successfully

When running gpio test on nxp-ls1028 platform with below command
gpiomon --num-events=3 --rising-edge gpiochip1 25
There will be a warning trace as below:
Call trace:
free_irq+0x204/0x360
lineevent_free+0x64/0x70
gpio_ioctl+0x598/0x6a0
__arm64_sys_ioctl+0xb4/0x100
invoke_syscall+0x5c/0x130
......
el0t_64_sync+0x1a0/0x1a4
The reason of this issue is that calling request_threaded_irq()
function failed, and then lineevent_free() is invoked to release
the resource. Since the lineevent_state::irq was already set, so
the subsequent invocation of free_irq() would trigger the above
warning call trace. To fix this issue, set the lineevent_state::irq
after the IRQ register successfully.

The Linux kernel CVE team has assigned CVE-2022-48660 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.9 with commit 468242724143a8e732f82f664b1e77432d149618 and fixed in 5.10.146 with commit 657803b918e097e47d99d1489da83a603c36bcdd
	Issue introduced in 5.9 with commit 468242724143a8e732f82f664b1e77432d149618 and fixed in 5.15.71 with commit 97da736cd11ae73bdf2f5e21e24446b8349e0168
	Issue introduced in 5.9 with commit 468242724143a8e732f82f664b1e77432d149618 and fixed in 5.19.12 with commit b1489043d3b9004dd8d5a0357b08b5f0e6691c43
	Issue introduced in 5.9 with commit 468242724143a8e732f82f664b1e77432d149618 and fixed in 6.0 with commit 69bef19d6b9700e96285f4b4e28691cda3dcd0d1

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-48660
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/gpio/gpiolib-cdev.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/657803b918e097e47d99d1489da83a603c36bcdd
	https://git.kernel.org/stable/c/97da736cd11ae73bdf2f5e21e24446b8349e0168
	https://git.kernel.org/stable/c/b1489043d3b9004dd8d5a0357b08b5f0e6691c43
	https://git.kernel.org/stable/c/69bef19d6b9700e96285f4b4e28691cda3dcd0d1
