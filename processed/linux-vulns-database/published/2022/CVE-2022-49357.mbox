From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49357: efi: Do not import certificates from UEFI Secure Boot for T2 Macs

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

efi: Do not import certificates from UEFI Secure Boot for T2 Macs

On Apple T2 Macs, when Linux attempts to read the db and dbx efi variables
at early boot to load UEFI Secure Boot certificates, a page fault occurs
in Apple firmware code and EFI runtime services are disabled with the
following logs:

[Firmware Bug]: Page fault caused by firmware at PA: 0xffffb1edc0068000
WARNING: CPU: 3 PID: 104 at arch/x86/platform/efi/quirks.c:735 efi_crash_gracefully_on_page_fault+0x50/0xf0
(Removed some logs from here)
Call Trace:
 <TASK>
 page_fault_oops+0x4f/0x2c0
 ? search_bpf_extables+0x6b/0x80
 ? search_module_extables+0x50/0x80
 ? search_exception_tables+0x5b/0x60
 kernelmode_fixup_or_oops+0x9e/0x110
 __bad_area_nosemaphore+0x155/0x190
 bad_area_nosemaphore+0x16/0x20
 do_kern_addr_fault+0x8c/0xa0
 exc_page_fault+0xd8/0x180
 asm_exc_page_fault+0x1e/0x30
(Removed some logs from here)
 ? __efi_call+0x28/0x30
 ? switch_mm+0x20/0x30
 ? efi_call_rts+0x19a/0x8e0
 ? process_one_work+0x222/0x3f0
 ? worker_thread+0x4a/0x3d0
 ? kthread+0x17a/0x1a0
 ? process_one_work+0x3f0/0x3f0
 ? set_kthread_struct+0x40/0x40
 ? ret_from_fork+0x22/0x30
 </TASK>
---[ end trace 1f82023595a5927f ]---
efi: Froze efi_rts_wq and disabled EFI Runtime Services
integrity: Couldn't get size: 0x8000000000000015
integrity: MODSIGN: Couldn't get UEFI db list
efi: EFI Runtime Services are disabled!
integrity: Couldn't get size: 0x8000000000000015
integrity: Couldn't get UEFI dbx list
integrity: Couldn't get size: 0x8000000000000015
integrity: Couldn't get mokx list
integrity: Couldn't get size: 0x80000000

So we avoid reading these UEFI variables and thus prevent the crash.

The Linux kernel CVE team has assigned CVE-2022-49357 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.0 with commit 15ea0e1e3e185040bed6119f815096f2e4326242 and fixed in 5.4.198 with commit b1cda6dd2c44771f042d65f0d17bec322ef99a0a
	Issue introduced in 5.0 with commit 15ea0e1e3e185040bed6119f815096f2e4326242 and fixed in 5.10.121 with commit c072cab98bac11f6ef9db640fb51834d9552e2e6
	Issue introduced in 5.0 with commit 15ea0e1e3e185040bed6119f815096f2e4326242 and fixed in 5.15.46 with commit 65237307f88f5200782ae7f243bdd385e37cde5d
	Issue introduced in 5.0 with commit 15ea0e1e3e185040bed6119f815096f2e4326242 and fixed in 5.17.14 with commit b34786b25d75f9c119696e6bdf3827f54ae3601b
	Issue introduced in 5.0 with commit 15ea0e1e3e185040bed6119f815096f2e4326242 and fixed in 5.18.3 with commit 1f7264f0510f519b4e4f575a8f0579ea65e7592e
	Issue introduced in 5.0 with commit 15ea0e1e3e185040bed6119f815096f2e4326242 and fixed in 5.19 with commit 155ca952c7ca19aa32ecfb7373a32bbc2e1ec6eb

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49357
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	security/integrity/platform_certs/keyring_handler.h
	security/integrity/platform_certs/load_uefi.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/b1cda6dd2c44771f042d65f0d17bec322ef99a0a
	https://git.kernel.org/stable/c/c072cab98bac11f6ef9db640fb51834d9552e2e6
	https://git.kernel.org/stable/c/65237307f88f5200782ae7f243bdd385e37cde5d
	https://git.kernel.org/stable/c/b34786b25d75f9c119696e6bdf3827f54ae3601b
	https://git.kernel.org/stable/c/1f7264f0510f519b4e4f575a8f0579ea65e7592e
	https://git.kernel.org/stable/c/155ca952c7ca19aa32ecfb7373a32bbc2e1ec6eb
