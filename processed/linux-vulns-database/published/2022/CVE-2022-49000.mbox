From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49000: iommu/vt-d: Fix PCI device refcount leak in has_external_pci()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

iommu/vt-d: Fix PCI device refcount leak in has_external_pci()

for_each_pci_dev() is implemented by pci_get_device(). The comment of
pci_get_device() says that it will increase the reference count for the
returned pci_dev and also decrease the reference count for the input
pci_dev @from if it is not NULL.

If we break for_each_pci_dev() loop with pdev not NULL, we need to call
pci_dev_put() to decrease the reference count. Add the missing
pci_dev_put() before 'return true' to avoid reference count leak.

The Linux kernel CVE team has assigned CVE-2022-49000 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.0 with commit 89a6079df791aeace2044ea93be1b397195824ec and fixed in 5.10.158 with commit 10ed7655a17f6a3eaecd1293830488259ccd5723
	Issue introduced in 5.0 with commit 89a6079df791aeace2044ea93be1b397195824ec and fixed in 5.15.82 with commit b6eea8b2e858a20ad58ac62dc2de90fea2413f94
	Issue introduced in 5.0 with commit 89a6079df791aeace2044ea93be1b397195824ec and fixed in 6.0.12 with commit 17f67414718e6aba123335a33b7d15aa594fff34
	Issue introduced in 5.0 with commit 89a6079df791aeace2044ea93be1b397195824ec and fixed in 6.1 with commit afca9e19cc720bfafc75dc5ce429c185ca93f31d

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49000
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/iommu/intel/iommu.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/10ed7655a17f6a3eaecd1293830488259ccd5723
	https://git.kernel.org/stable/c/b6eea8b2e858a20ad58ac62dc2de90fea2413f94
	https://git.kernel.org/stable/c/17f67414718e6aba123335a33b7d15aa594fff34
	https://git.kernel.org/stable/c/afca9e19cc720bfafc75dc5ce429c185ca93f31d
