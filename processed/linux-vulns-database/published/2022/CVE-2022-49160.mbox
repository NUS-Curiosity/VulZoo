From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49160: scsi: qla2xxx: Fix crash during module load unload test

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

scsi: qla2xxx: Fix crash during module load unload test

During purex packet handling the driver was incorrectly freeing a
pre-allocated structure. Fix this by skipping that entry.

System crashed with the following stack during a module unload test.

Call Trace:
	sbitmap_init_node+0x7f/0x1e0
	sbitmap_queue_init_node+0x24/0x150
	blk_mq_init_bitmaps+0x3d/0xa0
	blk_mq_init_tags+0x68/0x90
	blk_mq_alloc_map_and_rqs+0x44/0x120
	blk_mq_alloc_set_map_and_rqs+0x63/0x150
	blk_mq_alloc_tag_set+0x11b/0x230
	scsi_add_host_with_dma.cold+0x3f/0x245
	qla2x00_probe_one+0xd5a/0x1b80 [qla2xxx]

Call Trace with slub_debug and debug kernel:
	kasan_report_invalid_free+0x50/0x80
	__kasan_slab_free+0x137/0x150
	slab_free_freelist_hook+0xc6/0x190
	kfree+0xe8/0x2e0
	qla2x00_free_device+0x3bb/0x5d0 [qla2xxx]
	qla2x00_remove_one+0x668/0xcf0 [qla2xxx]

The Linux kernel CVE team has assigned CVE-2022-49160 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.9 with commit 62e9dd177732843ae6c5b9d2ed61e7c9538fa276 and fixed in 5.15.54 with commit 9b7eb92dac240ab3bc83e188d83a3df834b41eb2
	Issue introduced in 5.9 with commit 62e9dd177732843ae6c5b9d2ed61e7c9538fa276 and fixed in 5.16.19 with commit 213e57b42537f1a2e5395caa9d7189854133ed12
	Issue introduced in 5.9 with commit 62e9dd177732843ae6c5b9d2ed61e7c9538fa276 and fixed in 5.17.2 with commit 67f744f73eba870ab96411d0310e831a4adc3713
	Issue introduced in 5.9 with commit 62e9dd177732843ae6c5b9d2ed61e7c9538fa276 and fixed in 5.18 with commit 0972252450f90db56dd5415a20e2aec21a08d036

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49160
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/scsi/qla2xxx/qla_os.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/9b7eb92dac240ab3bc83e188d83a3df834b41eb2
	https://git.kernel.org/stable/c/213e57b42537f1a2e5395caa9d7189854133ed12
	https://git.kernel.org/stable/c/67f744f73eba870ab96411d0310e831a4adc3713
	https://git.kernel.org/stable/c/0972252450f90db56dd5415a20e2aec21a08d036
