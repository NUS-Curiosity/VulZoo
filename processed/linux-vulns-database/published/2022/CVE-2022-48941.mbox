From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-48941: ice: fix concurrent reset and removal of VFs

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ice: fix concurrent reset and removal of VFs

Commit c503e63200c6 ("ice: Stop processing VF messages during teardown")
introduced a driver state flag, ICE_VF_DEINIT_IN_PROGRESS, which is
intended to prevent some issues with concurrently handling messages from
VFs while tearing down the VFs.

This change was motivated by crashes caused while tearing down and
bringing up VFs in rapid succession.

It turns out that the fix actually introduces issues with the VF driver
caused because the PF no longer responds to any messages sent by the VF
during its .remove routine. This results in the VF potentially removing
its DMA memory before the PF has shut down the device queues.

Additionally, the fix doesn't actually resolve concurrency issues within
the ice driver. It is possible for a VF to initiate a reset just prior
to the ice driver removing VFs. This can result in the remove task
concurrently operating while the VF is being reset. This results in
similar memory corruption and panics purportedly fixed by that commit.

Fix this concurrency at its root by protecting both the reset and
removal flows using the existing VF cfg_lock. This ensures that we
cannot remove the VF while any outstanding critical tasks such as a
virtchnl message or a reset are occurring.

This locking change also fixes the root cause originally fixed by commit
c503e63200c6 ("ice: Stop processing VF messages during teardown"), so we
can simply revert it.

Note that I kept these two changes together because simply reverting the
original commit alone would leave the driver vulnerable to worse race
conditions.

The Linux kernel CVE team has assigned CVE-2022-48941 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.14 with commit c503e63200c679e362afca7aca9d3dc63a0f45ed and fixed in 5.10.104 with commit 05ae1f0fe9c6c5ead08b306e665763a352d20716
	Issue introduced in 5.14 with commit c503e63200c679e362afca7aca9d3dc63a0f45ed and fixed in 5.15.26 with commit 3c805fce07c9dbc47d8a9129c7c5458025951957
	Issue introduced in 5.14 with commit c503e63200c679e362afca7aca9d3dc63a0f45ed and fixed in 5.16.12 with commit 2a3e61de89bab6696aa28b70030eb119968c5586
	Issue introduced in 5.14 with commit c503e63200c679e362afca7aca9d3dc63a0f45ed and fixed in 5.17 with commit fadead80fe4c033b5e514fcbadd20b55c4494112
	Issue introduced in 5.13.12 with commit 8a08142433624fd1088bc8c13639408cf4e1707c

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-48941
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/ethernet/intel/ice/ice.h
	drivers/net/ethernet/intel/ice/ice_main.c
	drivers/net/ethernet/intel/ice/ice_virtchnl_pf.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/05ae1f0fe9c6c5ead08b306e665763a352d20716
	https://git.kernel.org/stable/c/3c805fce07c9dbc47d8a9129c7c5458025951957
	https://git.kernel.org/stable/c/2a3e61de89bab6696aa28b70030eb119968c5586
	https://git.kernel.org/stable/c/fadead80fe4c033b5e514fcbadd20b55c4494112
