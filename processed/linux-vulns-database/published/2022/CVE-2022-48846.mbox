From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-48846: block: release rq qos structures for queue without disk

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

block: release rq qos structures for queue without disk

blkcg_init_queue() may add rq qos structures to request queue, previously
blk_cleanup_queue() calls rq_qos_exit() to release them, but commit
8e141f9eb803 ("block: drain file system I/O on del_gendisk")
moves rq_qos_exit() into del_gendisk(), so memory leak is caused
because queues may not have disk, such as un-present scsi luns, nvme
admin queue, ...

Fixes the issue by adding rq_qos_exit() to blk_cleanup_queue() back.

BTW, v5.18 won't need this patch any more since we move
blkcg_init_queue()/blkcg_exit_queue() into disk allocation/release
handler, and patches have been in for-5.18/block.

The Linux kernel CVE team has assigned CVE-2022-48846 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.15 with commit 8e141f9eb803e209714a80aa6ec073893f94c526 and fixed in 5.15.31 with commit d4ad8736ac982111bb0be8306bf19c8207f6600e
	Issue introduced in 5.15 with commit 8e141f9eb803e209714a80aa6ec073893f94c526 and fixed in 5.16.17 with commit 60c2c8e2ef3a3ec79de8cbc80a06ca0c21df8c29
	Issue introduced in 5.15 with commit 8e141f9eb803e209714a80aa6ec073893f94c526 and fixed in 5.17 with commit daaca3522a8e67c46e39ef09c1d542e866f85f3b

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-48846
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	block/blk-core.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/d4ad8736ac982111bb0be8306bf19c8207f6600e
	https://git.kernel.org/stable/c/60c2c8e2ef3a3ec79de8cbc80a06ca0c21df8c29
	https://git.kernel.org/stable/c/daaca3522a8e67c46e39ef09c1d542e866f85f3b
