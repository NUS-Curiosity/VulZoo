From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49291: ALSA: pcm: Fix races among concurrent hw_params and hw_free calls

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ALSA: pcm: Fix races among concurrent hw_params and hw_free calls

Currently we have neither proper check nor protection against the
concurrent calls of PCM hw_params and hw_free ioctls, which may result
in a UAF.  Since the existing PCM stream lock can't be used for
protecting the whole ioctl operations, we need a new mutex to protect
those racy calls.

This patch introduced a new mutex, runtime->buffer_mutex, and applies
it to both hw_params and hw_free ioctl code paths.  Along with it, the
both functions are slightly modified (the mmap_count check is moved
into the state-check block) for code simplicity.

The Linux kernel CVE team has assigned CVE-2022-49291 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.14.279 with commit a42aa926843acca96c0dfbde2e835b8137f2f092
	Fixed in 4.19.243 with commit 9cb6c40a6ebe4a0cfc9d6a181958211682cffea9
	Fixed in 5.4.193 with commit fbeb492694ce0441053de57699e1e2b7bc148a69
	Fixed in 5.10.109 with commit 0f6947f5f5208f6ebd4d76a82a4757e2839a23f8
	Fixed in 5.15.32 with commit 33061d0fba51d2bf70a2ef9645f703c33fe8e438
	Fixed in 5.16.18 with commit 0090c13cbbdffd7da079ac56f80373a9a1be0bf8
	Fixed in 5.17.1 with commit 1bbf82d9f961414d6c76a08f7f843ea068e0ab7b
	Fixed in 5.18 with commit 92ee3c60ec9fe64404dc035e7c41277d74aa26cb

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49291
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	include/sound/pcm.h
	sound/core/pcm.c
	sound/core/pcm_native.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/a42aa926843acca96c0dfbde2e835b8137f2f092
	https://git.kernel.org/stable/c/9cb6c40a6ebe4a0cfc9d6a181958211682cffea9
	https://git.kernel.org/stable/c/fbeb492694ce0441053de57699e1e2b7bc148a69
	https://git.kernel.org/stable/c/0f6947f5f5208f6ebd4d76a82a4757e2839a23f8
	https://git.kernel.org/stable/c/33061d0fba51d2bf70a2ef9645f703c33fe8e438
	https://git.kernel.org/stable/c/0090c13cbbdffd7da079ac56f80373a9a1be0bf8
	https://git.kernel.org/stable/c/1bbf82d9f961414d6c76a08f7f843ea068e0ab7b
	https://git.kernel.org/stable/c/92ee3c60ec9fe64404dc035e7c41277d74aa26cb
