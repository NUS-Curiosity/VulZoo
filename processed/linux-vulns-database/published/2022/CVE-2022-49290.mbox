From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-49290: mac80211: fix potential double free on mesh join

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

mac80211: fix potential double free on mesh join

While commit 6a01afcf8468 ("mac80211: mesh: Free ie data when leaving
mesh") fixed a memory leak on mesh leave / teardown it introduced a
potential memory corruption caused by a double free when rejoining the
mesh:

  ieee80211_leave_mesh()
  -> kfree(sdata->u.mesh.ie);
  ...
  ieee80211_join_mesh()
  -> copy_mesh_setup()
     -> old_ie = ifmsh->ie;
     -> kfree(old_ie);

This double free / kernel panics can be reproduced by using wpa_supplicant
with an encrypted mesh (if set up without encryption via "iw" then
ifmsh->ie is always NULL, which avoids this issue). And then calling:

  $ iw dev mesh0 mesh leave
  $ iw dev mesh0 mesh join my-mesh

Note that typically these commands are not used / working when using
wpa_supplicant. And it seems that wpa_supplicant or wpa_cli are going
through a NETDEV_DOWN/NETDEV_UP cycle between a mesh leave and mesh join
where the NETDEV_UP resets the mesh.ie to NULL via a memcpy of
default_mesh_setup in cfg80211_netdev_notifier_call, which then avoids
the memory corruption, too.

The issue was first observed in an application which was not using
wpa_supplicant but "Senf" instead, which implements its own calls to
nl80211.

Fixing the issue by removing the kfree()'ing of the mesh IE in the mesh
join function and leaving it solely up to the mesh leave to free the
mesh IE.

The Linux kernel CVE team has assigned CVE-2022-49290 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.9.233 with commit 3212d6248faf0efce6b7a718e198feecce0eea05 and fixed in 4.9.309 with commit 615716af8644813355e014314a0bc1e961250f5a
	Issue introduced in 4.14.192 with commit 86e7d4cd2ed5f4b0188afce8199faffcf1ae7c7e and fixed in 4.14.274 with commit c1d9c3628ef0a0ca197595d0f9e01cd3b5dda186
	Issue introduced in 4.19.137 with commit 37bccfa89559a70c044b5ccde3c916a91388e14a and fixed in 4.19.237 with commit 273ebddc5fda2967492cb0b6cdd7d81cfb821b76
	Issue introduced in 5.4.56 with commit 3f15e3e62c80e180282f0cbc5559264e11c328b7 and fixed in 5.4.188 with commit 3bbd0000d012f92aec423b224784fbf0f7bf40f8
	Issue introduced in 5.8 with commit 6a01afcf8468d3ca2bd8bbb27503f60dcf643b20 and fixed in 5.10.109 with commit 5d3ff9542a40ce034416bca03864709540a36016
	Issue introduced in 5.8 with commit 6a01afcf8468d3ca2bd8bbb27503f60dcf643b20 and fixed in 5.15.32 with commit 12e407a8ef17623823fd0c066fbd7f103953d28d
	Issue introduced in 5.8 with commit 6a01afcf8468d3ca2bd8bbb27503f60dcf643b20 and fixed in 5.16.18 with commit 582d8c60c0c053684f7138875e8150d5749ffc17
	Issue introduced in 5.8 with commit 6a01afcf8468d3ca2bd8bbb27503f60dcf643b20 and fixed in 5.17.1 with commit 46bb87d40683337757a2f902fcd4244b32bb4e86
	Issue introduced in 5.8 with commit 6a01afcf8468d3ca2bd8bbb27503f60dcf643b20 and fixed in 5.18 with commit 4a2d4496e15ea5bb5c8e83b94ca8ca7fb045e7d3
	Issue introduced in 4.4.233 with commit 12e9cb1e7c93413112260991d094cfda712fdc97
	Issue introduced in 5.7.13 with commit 4f3193e08602462a806e8f53212e79c60a6f7488

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-49290
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/mac80211/cfg.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/615716af8644813355e014314a0bc1e961250f5a
	https://git.kernel.org/stable/c/c1d9c3628ef0a0ca197595d0f9e01cd3b5dda186
	https://git.kernel.org/stable/c/273ebddc5fda2967492cb0b6cdd7d81cfb821b76
	https://git.kernel.org/stable/c/3bbd0000d012f92aec423b224784fbf0f7bf40f8
	https://git.kernel.org/stable/c/5d3ff9542a40ce034416bca03864709540a36016
	https://git.kernel.org/stable/c/12e407a8ef17623823fd0c066fbd7f103953d28d
	https://git.kernel.org/stable/c/582d8c60c0c053684f7138875e8150d5749ffc17
	https://git.kernel.org/stable/c/46bb87d40683337757a2f902fcd4244b32bb4e86
	https://git.kernel.org/stable/c/4a2d4496e15ea5bb5c8e83b94ca8ca7fb045e7d3
