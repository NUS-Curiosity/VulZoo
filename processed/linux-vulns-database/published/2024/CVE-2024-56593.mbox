From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-56593: wifi: brcmfmac: Fix oops due to NULL pointer dereference in brcmf_sdiod_sglist_rw()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

wifi: brcmfmac: Fix oops due to NULL pointer dereference in brcmf_sdiod_sglist_rw()

This patch fixes a NULL pointer dereference bug in brcmfmac that occurs
when a high 'sd_sgentry_align' value applies (e.g. 512) and a lot of queued SKBs
are sent from the pkt queue.

The problem is the number of entries in the pre-allocated sgtable, it is
nents = max(rxglom_size, txglom_size) + max(rxglom_size, txglom_size) >> 4 + 1.
Given the default [rt]xglom_size=32 it's actually 35 which is too small.
Worst case, the pkt queue can end up with 64 SKBs. This occurs when a new SKB
is added for each original SKB if tailroom isn't enough to hold tail_pad.
At least one sg entry is needed for each SKB. So, eventually the "skb_queue_walk loop"
in brcmf_sdiod_sglist_rw may run out of sg entries. This makes sg_next return
NULL and this causes the oops.

The patch sets nents to max(rxglom_size, txglom_size) * 2 to be able handle
the worst-case.
Btw. this requires only 64-35=29 * 16 (or 20 if CONFIG_NEED_SG_DMA_LENGTH) = 464
additional bytes of memory.

The Linux kernel CVE team has assigned CVE-2024-56593 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.4.287 with commit 342f87d263462c2670b77ea9a32074cab2ac6fa1
	Fixed in 5.10.231 with commit 7522d7d745d13fbeff3350fe6aa56c8dae263571
	Fixed in 5.15.174 with commit dfb3f9d3f602602de208da7bdcc0f6d5ee74af68
	Fixed in 6.1.120 with commit 67a25ea28f8ec1da8894f2f115d01d3becf67dc7
	Fixed in 6.6.66 with commit 07c020c6d14d29e5a3ea4e4576b8ecf956a80834
	Fixed in 6.12.5 with commit 34941321b516bd7c6103bd01287d71a1804d19d3
	Fixed in 6.13 with commit 857282b819cbaa0675aaab1e7542e2c0579f52d7

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-56593
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/342f87d263462c2670b77ea9a32074cab2ac6fa1
	https://git.kernel.org/stable/c/7522d7d745d13fbeff3350fe6aa56c8dae263571
	https://git.kernel.org/stable/c/dfb3f9d3f602602de208da7bdcc0f6d5ee74af68
	https://git.kernel.org/stable/c/67a25ea28f8ec1da8894f2f115d01d3becf67dc7
	https://git.kernel.org/stable/c/07c020c6d14d29e5a3ea4e4576b8ecf956a80834
	https://git.kernel.org/stable/c/34941321b516bd7c6103bd01287d71a1804d19d3
	https://git.kernel.org/stable/c/857282b819cbaa0675aaab1e7542e2c0579f52d7
