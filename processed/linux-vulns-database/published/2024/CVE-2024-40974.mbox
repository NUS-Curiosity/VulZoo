From bippy-c9c4e1df01b2 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-40974: powerpc/pseries: Enforce hcall result buffer validity and size

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

powerpc/pseries: Enforce hcall result buffer validity and size

plpar_hcall(), plpar_hcall9(), and related functions expect callers to
provide valid result buffers of certain minimum size. Currently this
is communicated only through comments in the code and the compiler has
no idea.

For example, if I write a bug like this:

  long retbuf[PLPAR_HCALL_BUFSIZE]; // should be PLPAR_HCALL9_BUFSIZE
  plpar_hcall9(H_ALLOCATE_VAS_WINDOW, retbuf, ...);

This compiles with no diagnostics emitted, but likely results in stack
corruption at runtime when plpar_hcall9() stores results past the end
of the array. (To be clear this is a contrived example and I have not
found a real instance yet.)

To make this class of error less likely, we can use explicitly-sized
array parameters instead of pointers in the declarations for the hcall
APIs. When compiled with -Warray-bounds[1], the code above now
provokes a diagnostic like this:

error: array argument is too small;
is of size 32, callee requires at least 72 [-Werror,-Warray-bounds]
   60 |                 plpar_hcall9(H_ALLOCATE_VAS_WINDOW, retbuf,
      |                 ^                                   ~~~~~~

[1] Enabled for LLVM builds but not GCC for now. See commit
    0da6e5fd6c37 ("gcc: disable '-Warray-bounds' for gcc-13 too") and
    related changes.

The Linux kernel CVE team has assigned CVE-2024-40974 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.19.317 with commit acf2b80c31c3
	Fixed in 5.4.279 with commit 19c166ee42cf
	Fixed in 5.10.221 with commit a8c988d752b3
	Fixed in 5.15.162 with commit 262e942ff5a8
	Fixed in 6.1.96 with commit 8aa11aa00157
	Fixed in 6.6.36 with commit 3ad0034910a5
	Fixed in 6.9.7 with commit aa6107dcc4ce
	Fixed in 6.10 with commit ff2e185cf73d

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-40974
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/powerpc/include/asm/hvcall.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/acf2b80c31c37acab040baa3cf5f19fbd5140b18
	https://git.kernel.org/stable/c/19c166ee42cf16d8b156a6cb4544122d9a65d3ca
	https://git.kernel.org/stable/c/a8c988d752b3d98d5cc1e3929c519a55ef55426c
	https://git.kernel.org/stable/c/262e942ff5a839b9e4f3302a8987928b0c8b8a2d
	https://git.kernel.org/stable/c/8aa11aa001576bf3b00dcb8559564ad7a3113588
	https://git.kernel.org/stable/c/3ad0034910a57aa88ed9976b1431b7b8c84e0048
	https://git.kernel.org/stable/c/aa6107dcc4ce9a3451f2d729204713783b657257
	https://git.kernel.org/stable/c/ff2e185cf73df480ec69675936c4ee75a445c3e4
