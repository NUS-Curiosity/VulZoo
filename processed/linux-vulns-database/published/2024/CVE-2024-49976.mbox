From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-49976: tracing/timerlat: Drop interface_lock in stop_kthread()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

tracing/timerlat: Drop interface_lock in stop_kthread()

stop_kthread() is the offline callback for "trace/osnoise:online", since
commit 5bfbcd1ee57b ("tracing/timerlat: Add interface_lock around clearing
of kthread in stop_kthread()"), the following ABBA deadlock scenario is
introduced:

T1                            | T2 [BP]               | T3 [AP]
osnoise_hotplug_workfn()      | work_for_cpu_fn()     | cpuhp_thread_fun()
                              |   _cpu_down()         |   osnoise_cpu_die()
  mutex_lock(&interface_lock) |                       |     stop_kthread()
                              |     cpus_write_lock() |       mutex_lock(&interface_lock)
  cpus_read_lock()            |     cpuhp_kick_ap()   |

As the interface_lock here in just for protecting the "kthread" field of
the osn_var, use xchg() instead to fix this issue. Also use
for_each_online_cpu() back in stop_per_cpu_kthreads() as it can take
cpu_read_lock() again.

The Linux kernel CVE team has assigned CVE-2024-49976 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.6.51 with commit b4fdabffae14cca2c80d99bd81f3f27239ac7f5e and fixed in 6.6.55 with commit a4a05ceffe8fad68b45de38fe2311bda619e76e2
	Issue introduced in 6.10.10 with commit 4679272d5252720746fd9c5465352cbc5665f230 and fixed in 6.10.14 with commit 09cb44cc3d3df7ade2cebc939d6257a2fa8afc7a
	Issue introduced in 6.11 with commit 5bfbcd1ee57b607fd29e4645c7f350dd385dd9ad and fixed in 6.11.3 with commit db8571a9a098086608c11a15856ff585789e67e8
	Issue introduced in 6.11 with commit 5bfbcd1ee57b607fd29e4645c7f350dd385dd9ad and fixed in 6.12 with commit b484a02c9cedf8703eff8f0756f94618004bd165

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-49976
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	kernel/trace/trace_osnoise.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/a4a05ceffe8fad68b45de38fe2311bda619e76e2
	https://git.kernel.org/stable/c/09cb44cc3d3df7ade2cebc939d6257a2fa8afc7a
	https://git.kernel.org/stable/c/db8571a9a098086608c11a15856ff585789e67e8
	https://git.kernel.org/stable/c/b484a02c9cedf8703eff8f0756f94618004bd165
