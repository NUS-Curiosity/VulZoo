From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-53215: svcrdma: fix miss destroy percpu_counter in svc_rdma_proc_init()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

svcrdma: fix miss destroy percpu_counter in svc_rdma_proc_init()

There's issue as follows:
RPC: Registered rdma transport module.
RPC: Registered rdma backchannel transport module.
RPC: Unregistered rdma transport module.
RPC: Unregistered rdma backchannel transport module.
BUG: unable to handle page fault for address: fffffbfff80c609a
PGD 123fee067 P4D 123fee067 PUD 123fea067 PMD 10c624067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
RIP: 0010:percpu_counter_destroy_many+0xf7/0x2a0
Call Trace:
 <TASK>
 __die+0x1f/0x70
 page_fault_oops+0x2cd/0x860
 spurious_kernel_fault+0x36/0x450
 do_kern_addr_fault+0xca/0x100
 exc_page_fault+0x128/0x150
 asm_exc_page_fault+0x26/0x30
 percpu_counter_destroy_many+0xf7/0x2a0
 mmdrop+0x209/0x350
 finish_task_switch.isra.0+0x481/0x840
 schedule_tail+0xe/0xd0
 ret_from_fork+0x23/0x80
 ret_from_fork_asm+0x1a/0x30
 </TASK>

If register_sysctl() return NULL, then svc_rdma_proc_cleanup() will not
destroy the percpu counters which init in svc_rdma_proc_init().
If CONFIG_HOTPLUG_CPU is enabled, residual nodes may be in the
'percpu_counters' list. The above issue may occur once the module is
removed. If the CONFIG_HOTPLUG_CPU configuration is not enabled, memory
leakage occurs.
To solve above issue just destroy all percpu counters when
register_sysctl() return NULL.

The Linux kernel CVE team has assigned CVE-2024-53215 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.12 with commit 1e7e55731628c90d8c701c45f9c3a3b8718840d6 and fixed in 5.15.174 with commit a12c897adf40b6e2b4a56e6912380c31bd7b2479
	Issue introduced in 5.12 with commit 1e7e55731628c90d8c701c45f9c3a3b8718840d6 and fixed in 6.1.120 with commit 94d2d6d398706ab7218a26d61e12919c4b498e09
	Issue introduced in 5.12 with commit 1e7e55731628c90d8c701c45f9c3a3b8718840d6 and fixed in 6.6.64 with commit 1c9a99c89e45b22eb556fd2f3f729f2683f247d5
	Issue introduced in 5.12 with commit 1e7e55731628c90d8c701c45f9c3a3b8718840d6 and fixed in 6.11.11 with commit ebf47215d46992caea660ec01cd618005d9e687a
	Issue introduced in 5.12 with commit 1e7e55731628c90d8c701c45f9c3a3b8718840d6 and fixed in 6.12.2 with commit 20322edcbad82a60321a8615a99ca73a9611115f
	Issue introduced in 5.12 with commit 1e7e55731628c90d8c701c45f9c3a3b8718840d6 and fixed in 6.13 with commit ce89e742a4c12b20f09a43fec1b21db33f2166cd

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-53215
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/sunrpc/xprtrdma/svc_rdma.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/a12c897adf40b6e2b4a56e6912380c31bd7b2479
	https://git.kernel.org/stable/c/94d2d6d398706ab7218a26d61e12919c4b498e09
	https://git.kernel.org/stable/c/1c9a99c89e45b22eb556fd2f3f729f2683f247d5
	https://git.kernel.org/stable/c/ebf47215d46992caea660ec01cd618005d9e687a
	https://git.kernel.org/stable/c/20322edcbad82a60321a8615a99ca73a9611115f
	https://git.kernel.org/stable/c/ce89e742a4c12b20f09a43fec1b21db33f2166cd
