From bippy-851b3ed3d212 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-26749: usb: cdns3: fixed memory use after free at cdns3_gadget_ep_disable()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

usb: cdns3: fixed memory use after free at cdns3_gadget_ep_disable()

  ...
  cdns3_gadget_ep_free_request(&priv_ep->endpoint, &priv_req->request);
  list_del_init(&priv_req->list);
  ...

'priv_req' actually free at cdns3_gadget_ep_free_request(). But
list_del_init() use priv_req->list after it.

[ 1542.642868][  T534] BUG: KFENCE: use-after-free read in __list_del_entry_valid+0x10/0xd4
[ 1542.642868][  T534]
[ 1542.653162][  T534] Use-after-free read at 0x000000009ed0ba99 (in kfence-#3):
[ 1542.660311][  T534]  __list_del_entry_valid+0x10/0xd4
[ 1542.665375][  T534]  cdns3_gadget_ep_disable+0x1f8/0x388 [cdns3]
[ 1542.671571][  T534]  usb_ep_disable+0x44/0xe4
[ 1542.675948][  T534]  ffs_func_eps_disable+0x64/0xc8
[ 1542.680839][  T534]  ffs_func_set_alt+0x74/0x368
[ 1542.685478][  T534]  ffs_func_disable+0x18/0x28

Move list_del_init() before cdns3_gadget_ep_free_request() to resolve this
problem.

The Linux kernel CVE team has assigned CVE-2024-26749 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.4 with commit 7733f6c32e36 and fixed in 5.4.270 with commit cfa9abb5570c
	Issue introduced in 5.4 with commit 7733f6c32e36 and fixed in 5.10.211 with commit b40328eea93c
	Issue introduced in 5.4 with commit 7733f6c32e36 and fixed in 5.15.150 with commit 4e5c73b15d95
	Issue introduced in 5.4 with commit 7733f6c32e36 and fixed in 6.1.80 with commit 2134e9906e17
	Issue introduced in 5.4 with commit 7733f6c32e36 and fixed in 6.6.19 with commit 29e42e1578a1
	Issue introduced in 5.4 with commit 7733f6c32e36 and fixed in 6.7.7 with commit 9a07244f614b
	Issue introduced in 5.4 with commit 7733f6c32e36 and fixed in 6.8 with commit cd45f99034b0

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-26749
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/usb/cdns3/cdns3-gadget.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/cfa9abb5570c489dabf6f7fb3a066cc576fc8824
	https://git.kernel.org/stable/c/b40328eea93c75a5645891408010141a0159f643
	https://git.kernel.org/stable/c/4e5c73b15d95452c1ba9c771dd013a3fbe052ff3
	https://git.kernel.org/stable/c/2134e9906e17b1e5284300fab547869ebacfd7d9
	https://git.kernel.org/stable/c/29e42e1578a10c611b3f1a38f3229b2d664b5d16
	https://git.kernel.org/stable/c/9a07244f614bc417de527b799da779dcae780b5d
	https://git.kernel.org/stable/c/cd45f99034b0c8c9cb346dd0d6407a95ca3d36f6
