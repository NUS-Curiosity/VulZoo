From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-46843: scsi: ufs: core: Remove SCSI host only if added

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

scsi: ufs: core: Remove SCSI host only if added

If host tries to remove ufshcd driver from a UFS device it would cause a
kernel panic if ufshcd_async_scan fails during ufshcd_probe_hba before
adding a SCSI host with scsi_add_host and MCQ is enabled since SCSI host
has been defered after MCQ configuration introduced by commit 0cab4023ec7b
("scsi: ufs: core: Defer adding host to SCSI if MCQ is supported").

To guarantee that SCSI host is removed only if it has been added, set the
scsi_host_added flag to true after adding a SCSI host and check whether it
is set or not before removing it.

The Linux kernel CVE team has assigned CVE-2024-46843 to this issue.


Affected and fixed versions
===========================

	Fixed in 6.6.51 with commit 2f49e05d6b58d660f035a75ff96b77071b4bd5ed
	Fixed in 6.10.10 with commit 3844586e9bd9845140e1078f1e61896b576ac536
	Fixed in 6.11 with commit 7cbff570dbe8907e23bba06f6414899a0fbb2fcc

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-46843
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/ufs/core/ufshcd.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/2f49e05d6b58d660f035a75ff96b77071b4bd5ed
	https://git.kernel.org/stable/c/3844586e9bd9845140e1078f1e61896b576ac536
	https://git.kernel.org/stable/c/7cbff570dbe8907e23bba06f6414899a0fbb2fcc
