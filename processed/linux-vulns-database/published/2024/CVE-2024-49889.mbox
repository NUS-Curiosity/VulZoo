From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-49889: ext4: avoid use-after-free in ext4_ext_show_leaf()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ext4: avoid use-after-free in ext4_ext_show_leaf()

In ext4_find_extent(), path may be freed by error or be reallocated, so
using a previously saved *ppath may have been freed and thus may trigger
use-after-free, as follows:

ext4_split_extent
  path = *ppath;
  ext4_split_extent_at(ppath)
  path = ext4_find_extent(ppath)
  ext4_split_extent_at(ppath)
    // ext4_find_extent fails to free path
    // but zeroout succeeds
  ext4_ext_show_leaf(inode, path)
    eh = path[depth].p_hdr
    // path use-after-free !!!

Similar to ext4_split_extent_at(), we use *ppath directly as an input to
ext4_ext_show_leaf(). Fix a spelling error by the way.

Same problem in ext4_ext_handle_unwritten_extents(). Since 'path' is only
used in ext4_ext_show_leaf(), remove 'path' and use *ppath directly.

This issue is triggered only when EXT_DEBUG is defined and therefore does
not affect functionality.

The Linux kernel CVE team has assigned CVE-2024-49889 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.10.227 with commit b0cb4561fc4284d04e69c8a66c8504928ab2484e
	Fixed in 5.15.168 with commit 4999fed877bb64e3e7f9ab9996de2ca983c41928
	Fixed in 6.1.113 with commit 2eba3b0cc5b8de624918d21f32b5b8db59a90b39
	Fixed in 6.6.55 with commit 34b2096380ba475771971a778a478661a791aa15
	Fixed in 6.10.14 with commit 8b114f2cc7dd5d36729d040b68432fbd0f0a8868
	Fixed in 6.11.3 with commit d483c7cc1796bd6a80e7b3a8fd494996260f6b67
	Fixed in 6.12 with commit 4e2524ba2ca5f54bdbb9e5153bea00421ef653f5

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-49889
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/ext4/extents.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/b0cb4561fc4284d04e69c8a66c8504928ab2484e
	https://git.kernel.org/stable/c/4999fed877bb64e3e7f9ab9996de2ca983c41928
	https://git.kernel.org/stable/c/2eba3b0cc5b8de624918d21f32b5b8db59a90b39
	https://git.kernel.org/stable/c/34b2096380ba475771971a778a478661a791aa15
	https://git.kernel.org/stable/c/8b114f2cc7dd5d36729d040b68432fbd0f0a8868
	https://git.kernel.org/stable/c/d483c7cc1796bd6a80e7b3a8fd494996260f6b67
	https://git.kernel.org/stable/c/4e2524ba2ca5f54bdbb9e5153bea00421ef653f5
