From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-50116: nilfs2: fix kernel bug due to missing clearing of buffer delay flag

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

nilfs2: fix kernel bug due to missing clearing of buffer delay flag

Syzbot reported that after nilfs2 reads a corrupted file system image
and degrades to read-only, the BUG_ON check for the buffer delay flag
in submit_bh_wbc() may fail, causing a kernel bug.

This is because the buffer delay flag is not cleared when clearing the
buffer state flags to discard a page/folio or a buffer head. So, fix
this.

This became necessary when the use of nilfs2's own page clear routine
was expanded.  This state inconsistency does not occur if the buffer
is written normally by log writing.

The Linux kernel CVE team has assigned CVE-2024-50116 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.10 with commit 8c26c4e2694a163d525976e804d81cd955bbb40c and fixed in 4.19.323 with commit 033bc52f35868c2493a2d95c56ece7fc155d7cb3
	Issue introduced in 3.10 with commit 8c26c4e2694a163d525976e804d81cd955bbb40c and fixed in 5.4.285 with commit 412a30b1b28d6073ba29c46a2b0f324c5936293f
	Issue introduced in 3.10 with commit 8c26c4e2694a163d525976e804d81cd955bbb40c and fixed in 5.10.229 with commit 9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1
	Issue introduced in 3.10 with commit 8c26c4e2694a163d525976e804d81cd955bbb40c and fixed in 5.15.170 with commit 822203f6355f4b322d21e7115419f6b98284be25
	Issue introduced in 3.10 with commit 8c26c4e2694a163d525976e804d81cd955bbb40c and fixed in 6.1.115 with commit 27524f65621f490184f2ace44cd8e5f3685af4a3
	Issue introduced in 3.10 with commit 8c26c4e2694a163d525976e804d81cd955bbb40c and fixed in 6.6.59 with commit 743c78d455e784097011ea958b27396001181567
	Issue introduced in 3.10 with commit 8c26c4e2694a163d525976e804d81cd955bbb40c and fixed in 6.11.6 with commit c6f58ff2d4c552927fe9a187774e668ebba6c7aa
	Issue introduced in 3.10 with commit 8c26c4e2694a163d525976e804d81cd955bbb40c and fixed in 6.12 with commit 6ed469df0bfbef3e4b44fca954a781919db9f7ab

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-50116
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/nilfs2/page.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/033bc52f35868c2493a2d95c56ece7fc155d7cb3
	https://git.kernel.org/stable/c/412a30b1b28d6073ba29c46a2b0f324c5936293f
	https://git.kernel.org/stable/c/9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1
	https://git.kernel.org/stable/c/822203f6355f4b322d21e7115419f6b98284be25
	https://git.kernel.org/stable/c/27524f65621f490184f2ace44cd8e5f3685af4a3
	https://git.kernel.org/stable/c/743c78d455e784097011ea958b27396001181567
	https://git.kernel.org/stable/c/c6f58ff2d4c552927fe9a187774e668ebba6c7aa
	https://git.kernel.org/stable/c/6ed469df0bfbef3e4b44fca954a781919db9f7ab
