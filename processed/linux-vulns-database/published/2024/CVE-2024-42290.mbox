From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-42290: irqchip/imx-irqsteer: Handle runtime power management correctly

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

irqchip/imx-irqsteer: Handle runtime power management correctly

The power domain is automatically activated from clk_prepare(). However, on
certain platforms like i.MX8QM and i.MX8QXP, the power-on handling invokes
sleeping functions, which triggers the 'scheduling while atomic' bug in the
context switch path during device probing:

 BUG: scheduling while atomic: kworker/u13:1/48/0x00000002
 Call trace:
  __schedule_bug+0x54/0x6c
  __schedule+0x7f0/0xa94
  schedule+0x5c/0xc4
  schedule_preempt_disabled+0x24/0x40
  __mutex_lock.constprop.0+0x2c0/0x540
  __mutex_lock_slowpath+0x14/0x20
  mutex_lock+0x48/0x54
  clk_prepare_lock+0x44/0xa0
  clk_prepare+0x20/0x44
  imx_irqsteer_resume+0x28/0xe0
  pm_generic_runtime_resume+0x2c/0x44
  __genpd_runtime_resume+0x30/0x80
  genpd_runtime_resume+0xc8/0x2c0
  __rpm_callback+0x48/0x1d8
  rpm_callback+0x6c/0x78
  rpm_resume+0x490/0x6b4
  __pm_runtime_resume+0x50/0x94
  irq_chip_pm_get+0x2c/0xa0
  __irq_do_set_handler+0x178/0x24c
  irq_set_chained_handler_and_data+0x60/0xa4
  mxc_gpio_probe+0x160/0x4b0

Cure this by implementing the irq_bus_lock/sync_unlock() interrupt chip
callbacks and handle power management in them as they are invoked from
non-atomic context.

[ tglx: Rewrote change log, added Fixes tag ]

The Linux kernel CVE team has assigned CVE-2024-42290 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.0 with commit 0136afa08967f6e160b9b4e85a7a70e4180a8333 and fixed in 5.4.282 with commit a590e8dea3df2639921f874d763be961dd74e8f9
	Issue introduced in 5.0 with commit 0136afa08967f6e160b9b4e85a7a70e4180a8333 and fixed in 5.10.224 with commit 3a2884a44e5cda192df1b28e9925661f79f599a1
	Issue introduced in 5.0 with commit 0136afa08967f6e160b9b4e85a7a70e4180a8333 and fixed in 5.15.165 with commit fa1803401e1c360efe6342fb41d161cc51748a11
	Issue introduced in 5.0 with commit 0136afa08967f6e160b9b4e85a7a70e4180a8333 and fixed in 6.1.103 with commit 58c56735facb225a5c46fa4b8bbbe7f31d1cb894
	Issue introduced in 5.0 with commit 0136afa08967f6e160b9b4e85a7a70e4180a8333 and fixed in 6.6.44 with commit 21bd3f9e7f924cd2fc892a484e7a50c7e1847565
	Issue introduced in 5.0 with commit 0136afa08967f6e160b9b4e85a7a70e4180a8333 and fixed in 6.10.3 with commit f8ae38f1dfe652779c7c613facbc257cec00ac44
	Issue introduced in 5.0 with commit 0136afa08967f6e160b9b4e85a7a70e4180a8333 and fixed in 6.11 with commit 33b1c47d1fc0b5f06a393bb915db85baacba18ea

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-42290
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/irqchip/irq-imx-irqsteer.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/a590e8dea3df2639921f874d763be961dd74e8f9
	https://git.kernel.org/stable/c/3a2884a44e5cda192df1b28e9925661f79f599a1
	https://git.kernel.org/stable/c/fa1803401e1c360efe6342fb41d161cc51748a11
	https://git.kernel.org/stable/c/58c56735facb225a5c46fa4b8bbbe7f31d1cb894
	https://git.kernel.org/stable/c/21bd3f9e7f924cd2fc892a484e7a50c7e1847565
	https://git.kernel.org/stable/c/f8ae38f1dfe652779c7c613facbc257cec00ac44
	https://git.kernel.org/stable/c/33b1c47d1fc0b5f06a393bb915db85baacba18ea
