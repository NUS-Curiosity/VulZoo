From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-41049: filelock: fix potential use-after-free in posix_lock_inode

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

filelock: fix potential use-after-free in posix_lock_inode

Light Hsieh reported a KASAN UAF warning in trace_posix_lock_inode().
The request pointer had been changed earlier to point to a lock entry
that was added to the inode's list. However, before the tracepoint could
fire, another task raced in and freed that lock.

Fix this by moving the tracepoint inside the spinlock, which should
ensure that this doesn't happen.

The Linux kernel CVE team has assigned CVE-2024-41049 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.4.257 with commit 117fb80cd1e63c419c7a221ce070becb4bfc7b6d and fixed in 5.4.280 with commit 1cbbb3d9475c403ebedc327490c7c2b991398197
	Issue introduced in 5.10.197 with commit a6f4129378ca15f62cbdde09a7d3ccc35adcf49d and fixed in 5.10.222 with commit 7d4c14f4b511fd4c0dc788084ae59b4656ace58b
	Issue introduced in 5.15.133 with commit 766e56faddbec2eaf70c9299e1c9ef74d846d32b and fixed in 5.15.163 with commit 02a8964260756c70b20393ad4006948510ac9967
	Issue introduced in 6.1.55 with commit 34bff6d850019e00001129d6de3aa4874c2cf471 and fixed in 6.1.100 with commit 5cb36e35bc10ea334810937990c2b9023dacb1b0
	Issue introduced in 6.6 with commit 74f6f5912693ce454384eaeec48705646a21c74f and fixed in 6.6.41 with commit 432b06b69d1d354a171f7499141116536579eb6a
	Issue introduced in 6.6 with commit 74f6f5912693ce454384eaeec48705646a21c74f and fixed in 6.9.10 with commit 116599f6a26906cf33f67975c59f0692ecf7e9b2
	Issue introduced in 6.6 with commit 74f6f5912693ce454384eaeec48705646a21c74f and fixed in 6.10 with commit 1b3ec4f7c03d4b07bad70697d7e2f4088d2cfe92
	Issue introduced in 6.5.5 with commit e75396988bb9b3b90e6e8690604d0f566cea403a

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-41049
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/locks.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/1cbbb3d9475c403ebedc327490c7c2b991398197
	https://git.kernel.org/stable/c/7d4c14f4b511fd4c0dc788084ae59b4656ace58b
	https://git.kernel.org/stable/c/02a8964260756c70b20393ad4006948510ac9967
	https://git.kernel.org/stable/c/5cb36e35bc10ea334810937990c2b9023dacb1b0
	https://git.kernel.org/stable/c/432b06b69d1d354a171f7499141116536579eb6a
	https://git.kernel.org/stable/c/116599f6a26906cf33f67975c59f0692ecf7e9b2
	https://git.kernel.org/stable/c/1b3ec4f7c03d4b07bad70697d7e2f4088d2cfe92
