From bippy-d175d3acf727 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-26654: ALSA: sh: aica: reorder cleanup operations to avoid UAF bugs

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ALSA: sh: aica: reorder cleanup operations to avoid UAF bugs

The dreamcastcard->timer could schedule the spu_dma_work and the
spu_dma_work could also arm the dreamcastcard->timer.

When the snd_pcm_substream is closing, the aica_channel will be
deallocated. But it could still be dereferenced in the worker
thread. The reason is that del_timer() will return directly
regardless of whether the timer handler is running or not and
the worker could be rescheduled in the timer handler. As a result,
the UAF bug will happen. The racy situation is shown below:

      (Thread 1)                 |      (Thread 2)
snd_aicapcm_pcm_close()          |
 ...                             |  run_spu_dma() //worker
                                 |    mod_timer()
  flush_work()                   |
  del_timer()                    |  aica_period_elapsed() //timer
  kfree(dreamcastcard->channel)  |    schedule_work()
                                 |  run_spu_dma() //worker
  ...                            |    dreamcastcard->channel-> //USE

In order to mitigate this bug and other possible corner cases,
call mod_timer() conditionally in run_spu_dma(), then implement
PCM sync_stop op to cancel both the timer and worker. The sync_stop
op will be called from PCM core appropriately when needed.

The Linux kernel CVE team has assigned CVE-2024-26654 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.23 with commit 198de43d758c and fixed in 4.19.312 with commit eeb2a2ca0b8d
	Issue introduced in 2.6.23 with commit 198de43d758c and fixed in 5.4.274 with commit 4206ad65a0ee
	Issue introduced in 2.6.23 with commit 198de43d758c and fixed in 5.10.215 with commit aa39e6878f61
	Issue introduced in 2.6.23 with commit 198de43d758c and fixed in 5.15.154 with commit 8c9902216816
	Issue introduced in 2.6.23 with commit 198de43d758c and fixed in 6.1.84 with commit 9d66ae0e7bb7
	Issue introduced in 2.6.23 with commit 198de43d758c and fixed in 6.6.24 with commit 61d4787692c1
	Issue introduced in 2.6.23 with commit 198de43d758c and fixed in 6.7.12 with commit e955e8a7f38a
	Issue introduced in 2.6.23 with commit 198de43d758c and fixed in 6.8.3 with commit 3c907bf56905
	Issue introduced in 2.6.23 with commit 198de43d758c and fixed in 6.9 with commit 051e0840ffa8

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-26654
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	sound/sh/aica.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/eeb2a2ca0b8de7e1c66afaf719529154e7dc60b2
	https://git.kernel.org/stable/c/4206ad65a0ee76920041a755bd3c17c6ba59bba2
	https://git.kernel.org/stable/c/aa39e6878f61f50892ee2dd9d2176f72020be845
	https://git.kernel.org/stable/c/8c990221681688da34295d6d76cc2f5b963e83f5
	https://git.kernel.org/stable/c/9d66ae0e7bb78b54e1e0525456c6b54e1d132046
	https://git.kernel.org/stable/c/61d4787692c1fccdc268ffa7a891f9c149f50901
	https://git.kernel.org/stable/c/e955e8a7f38a856fc6534ba4e6bffd4d5cc80ac3
	https://git.kernel.org/stable/c/3c907bf56905de7d27b329afaf59c2fb35d17b04
	https://git.kernel.org/stable/c/051e0840ffa8ab25554d6b14b62c9ab9e4901457
