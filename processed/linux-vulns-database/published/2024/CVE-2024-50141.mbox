From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-50141: ACPI: PRM: Find EFI_MEMORY_RUNTIME block for PRM handler and context

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ACPI: PRM: Find EFI_MEMORY_RUNTIME block for PRM handler and context

PRMT needs to find the correct type of block to translate the PA-VA
mapping for EFI runtime services.

The issue arises because the PRMT is finding a block of type
EFI_CONVENTIONAL_MEMORY, which is not appropriate for runtime services
as described in Section 2.2.2 (Runtime Services) of the UEFI
Specification [1]. Since the PRM handler is a type of runtime service,
this causes an exception when the PRM handler is called.

    [Firmware Bug]: Unable to handle paging request in EFI runtime service
    WARNING: CPU: 22 PID: 4330 at drivers/firmware/efi/runtime-wrappers.c:341
        __efi_queue_work+0x11c/0x170
    Call trace:

Let PRMT find a block with EFI_MEMORY_RUNTIME for PRM handler and PRM
context.

If no suitable block is found, a warning message will be printed, but
the procedure continues to manage the next PRM handler.

However, if the PRM handler is actually called without proper allocation,
it would result in a failure during error handling.

By using the correct memory types for runtime services, ensure that the
PRM handler and the context are properly mapped in the virtual address
space during runtime, preventing the paging request error.

The issue is really that only memory that has been remapped for runtime
by the firmware can be used by the PRM handler, and so the region needs
to have the EFI_MEMORY_RUNTIME attribute.

[ rjw: Subject and changelog edits ]

The Linux kernel CVE team has assigned CVE-2024-50141 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.14 with commit cefc7ca46235f01d5233e3abd4b79452af01d9e9 and fixed in 5.15.171 with commit 8df52929530839e878e6912e33348b54101e3250
	Issue introduced in 5.14 with commit cefc7ca46235f01d5233e3abd4b79452af01d9e9 and fixed in 6.1.115 with commit 8ce081ad842510f0e70fa6065a401660eac876d4
	Issue introduced in 5.14 with commit cefc7ca46235f01d5233e3abd4b79452af01d9e9 and fixed in 6.6.59 with commit 795b080d9aa127215a5baf088a22fa09341a0126
	Issue introduced in 5.14 with commit cefc7ca46235f01d5233e3abd4b79452af01d9e9 and fixed in 6.11.6 with commit 20e9fafb8bb6f545667d7916b0e81e68c0748810
	Issue introduced in 5.14 with commit cefc7ca46235f01d5233e3abd4b79452af01d9e9 and fixed in 6.12 with commit 088984c8d54c0053fc4ae606981291d741c5924b

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-50141
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/acpi/prmt.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/8df52929530839e878e6912e33348b54101e3250
	https://git.kernel.org/stable/c/8ce081ad842510f0e70fa6065a401660eac876d4
	https://git.kernel.org/stable/c/795b080d9aa127215a5baf088a22fa09341a0126
	https://git.kernel.org/stable/c/20e9fafb8bb6f545667d7916b0e81e68c0748810
	https://git.kernel.org/stable/c/088984c8d54c0053fc4ae606981291d741c5924b
