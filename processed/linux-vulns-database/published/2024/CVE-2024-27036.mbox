From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-27036: cifs: Fix writeback data corruption

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

cifs: Fix writeback data corruption

cifs writeback doesn't correctly handle the case where
cifs_extend_writeback() hits a point where it is considering an additional
folio, but this would overrun the wsize - at which point it drops out of
the xarray scanning loop and calls xas_pause().  The problem is that
xas_pause() advances the loop counter - thereby skipping that page.

What needs to happen is for xas_reset() to be called any time we decide we
don't want to process the page we're looking at, but rather send the
request we are building and start a new one.

Fix this by copying and adapting the netfslib writepages code as a
temporary measure, with cifs writeback intending to be offloaded to
netfslib in the near future.

This also fixes the issue with the use of filemap_get_folios_tag() causing
retry of a bunch of pages which the extender already dealt with.

This can be tested by creating, say, a 64K file somewhere not on cifs
(otherwise copy-offload may get underfoot), mounting a cifs share with a
wsize of 64000, copying the file to it and then comparing the original file
and the copy:

        dd if=/dev/urandom of=/tmp/64K bs=64k count=1
        mount //192.168.6.1/test /mnt -o user=...,pass=...,wsize=64000
        cp /tmp/64K /mnt/64K
        cmp /tmp/64K /mnt/64K

Without the fix, the cmp fails at position 64000 (or shortly thereafter).

The Linux kernel CVE team has assigned CVE-2024-27036 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.3 with commit d08089f649a0cfb2099c8551ac47eef0cc23fdf2 and fixed in 6.6.23 with commit e45deec35bf7f1f4f992a707b2d04a8c162f2240
	Issue introduced in 6.3 with commit d08089f649a0cfb2099c8551ac47eef0cc23fdf2 and fixed in 6.7.11 with commit 65f2ced695982ccd516196d0a9447d85dbe2eed5
	Issue introduced in 6.3 with commit d08089f649a0cfb2099c8551ac47eef0cc23fdf2 and fixed in 6.8.2 with commit 844b4e132f57f1333dc79feaa035075a096762e4
	Issue introduced in 6.3 with commit d08089f649a0cfb2099c8551ac47eef0cc23fdf2 and fixed in 6.9 with commit f3dc1bdb6b0b0693562c7c54a6c28bafa608ba3c

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-27036
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/smb/client/file.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e45deec35bf7f1f4f992a707b2d04a8c162f2240
	https://git.kernel.org/stable/c/65f2ced695982ccd516196d0a9447d85dbe2eed5
	https://git.kernel.org/stable/c/844b4e132f57f1333dc79feaa035075a096762e4
	https://git.kernel.org/stable/c/f3dc1bdb6b0b0693562c7c54a6c28bafa608ba3c
