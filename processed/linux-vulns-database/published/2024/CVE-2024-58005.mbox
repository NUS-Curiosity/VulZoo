From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-58005: tpm: Change to kvalloc() in eventlog/acpi.c

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

tpm: Change to kvalloc() in eventlog/acpi.c

The following failure was reported on HPE ProLiant D320:

[   10.693310][    T1] tpm_tis STM0925:00: 2.0 TPM (device-id 0x3, rev-id 0)
[   10.848132][    T1] ------------[ cut here ]------------
[   10.853559][    T1] WARNING: CPU: 59 PID: 1 at mm/page_alloc.c:4727 __alloc_pages_noprof+0x2ca/0x330
[   10.862827][    T1] Modules linked in:
[   10.866671][    T1] CPU: 59 UID: 0 PID: 1 Comm: swapper/0 Not tainted 6.12.0-lp155.2.g52785e2-default #1 openSUSE Tumbleweed (unreleased) 588cd98293a7c9eba9013378d807364c088c9375
[   10.882741][    T1] Hardware name: HPE ProLiant DL320 Gen12/ProLiant DL320 Gen12, BIOS 1.20 10/28/2024
[   10.892170][    T1] RIP: 0010:__alloc_pages_noprof+0x2ca/0x330
[   10.898103][    T1] Code: 24 08 e9 4a fe ff ff e8 34 36 fa ff e9 88 fe ff ff 83 fe 0a 0f 86 b3 fd ff ff 80 3d 01 e7 ce 01 00 75 09 c6 05 f8 e6 ce 01 01 <0f> 0b 45 31 ff e9 e5 fe ff ff f7 c2 00 00 08 00 75 42 89 d9 80 e1
[   10.917750][    T1] RSP: 0000:ffffb7cf40077980 EFLAGS: 00010246
[   10.923777][    T1] RAX: 0000000000000000 RBX: 0000000000040cc0 RCX: 0000000000000000
[   10.931727][    T1] RDX: 0000000000000000 RSI: 000000000000000c RDI: 0000000000040cc0

The above transcript shows that ACPI pointed a 16 MiB buffer for the log
events because RSI maps to the 'order' parameter of __alloc_pages_noprof().
Address the bug by moving from devm_kmalloc() to devm_add_action() and
kvmalloc() and devm_add_action().

The Linux kernel CVE team has assigned CVE-2024-58005 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.16 with commit 55a82ab3181be039c6440d3f2f69260ad6fe2988 and fixed in 5.10.235 with commit a676c0401de59548a5bc1b7aaf98f556ae8ea6db
	Issue introduced in 2.6.16 with commit 55a82ab3181be039c6440d3f2f69260ad6fe2988 and fixed in 5.15.179 with commit 0621d2599d6e02d05c85d6bbd58eaea2f15b3503
	Issue introduced in 2.6.16 with commit 55a82ab3181be039c6440d3f2f69260ad6fe2988 and fixed in 6.1.130 with commit 77779d1258a287f2c5c2c6aeae203e0996209c77
	Issue introduced in 2.6.16 with commit 55a82ab3181be039c6440d3f2f69260ad6fe2988 and fixed in 6.6.78 with commit 50365a6304a57266e8f4d3078060743c3b7a1e0d
	Issue introduced in 2.6.16 with commit 55a82ab3181be039c6440d3f2f69260ad6fe2988 and fixed in 6.12.14 with commit 422d7f4e8d817be467986589c7968d3ea402f7da
	Issue introduced in 2.6.16 with commit 55a82ab3181be039c6440d3f2f69260ad6fe2988 and fixed in 6.13.3 with commit 4c8bfe643bbd00b04ee8f9545ef33bf6a68c38db
	Issue introduced in 2.6.16 with commit 55a82ab3181be039c6440d3f2f69260ad6fe2988 and fixed in 6.14-rc1 with commit a3a860bc0fd6c07332e4911cf9a238d20de90173

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-58005
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/char/tpm/eventlog/acpi.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/a676c0401de59548a5bc1b7aaf98f556ae8ea6db
	https://git.kernel.org/stable/c/0621d2599d6e02d05c85d6bbd58eaea2f15b3503
	https://git.kernel.org/stable/c/77779d1258a287f2c5c2c6aeae203e0996209c77
	https://git.kernel.org/stable/c/50365a6304a57266e8f4d3078060743c3b7a1e0d
	https://git.kernel.org/stable/c/422d7f4e8d817be467986589c7968d3ea402f7da
	https://git.kernel.org/stable/c/4c8bfe643bbd00b04ee8f9545ef33bf6a68c38db
	https://git.kernel.org/stable/c/a3a860bc0fd6c07332e4911cf9a238d20de90173
