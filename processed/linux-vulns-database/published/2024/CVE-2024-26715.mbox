From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-26715: usb: dwc3: gadget: Fix NULL pointer dereference in dwc3_gadget_suspend

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

usb: dwc3: gadget: Fix NULL pointer dereference in dwc3_gadget_suspend

In current scenario if Plug-out and Plug-In performed continuously
there could be a chance while checking for dwc->gadget_driver in
dwc3_gadget_suspend, a NULL pointer dereference may occur.

Call Stack:

	CPU1:                           CPU2:
	gadget_unbind_driver            dwc3_suspend_common
	dwc3_gadget_stop                dwc3_gadget_suspend
                                        dwc3_disconnect_gadget

CPU1 basically clears the variable and CPU2 checks the variable.
Consider CPU1 is running and right before gadget_driver is cleared
and in parallel CPU2 executes dwc3_gadget_suspend where it finds
dwc->gadget_driver which is not NULL and resumes execution and then
CPU1 completes execution. CPU2 executes dwc3_disconnect_gadget where
it checks dwc->gadget_driver is already NULL because of which the
NULL pointer deference occur.

The Linux kernel CVE team has assigned CVE-2024-26715 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.6 with commit 9772b47a4c2916d645c551228b6085ea24acbe5d and fixed in 5.15.149 with commit 88936ceab6b426f1312327e9ef849c215c6007a7
	Issue introduced in 4.6 with commit 9772b47a4c2916d645c551228b6085ea24acbe5d and fixed in 6.1.79 with commit 57e2e42ccd3cd6183228269715ed032f44536751
	Issue introduced in 4.6 with commit 9772b47a4c2916d645c551228b6085ea24acbe5d and fixed in 6.6.18 with commit c7ebd8149ee519d27232e6e4940e9c02071b568b
	Issue introduced in 4.6 with commit 9772b47a4c2916d645c551228b6085ea24acbe5d and fixed in 6.7.6 with commit 36695d5eeeefe5a64b47d0336e7c8fc144e78182
	Issue introduced in 4.6 with commit 9772b47a4c2916d645c551228b6085ea24acbe5d and fixed in 6.8 with commit 61a348857e869432e6a920ad8ea9132e8d44c316
	Issue introduced in 3.16.81 with commit 8cca5c85393a7a490d4d7942c24d73d29cc77b3e
	Issue introduced in 4.4.178 with commit df2ca3271569367352835f981618e284fdc4ca94

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-26715
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/usb/dwc3/gadget.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/88936ceab6b426f1312327e9ef849c215c6007a7
	https://git.kernel.org/stable/c/57e2e42ccd3cd6183228269715ed032f44536751
	https://git.kernel.org/stable/c/c7ebd8149ee519d27232e6e4940e9c02071b568b
	https://git.kernel.org/stable/c/36695d5eeeefe5a64b47d0336e7c8fc144e78182
	https://git.kernel.org/stable/c/61a348857e869432e6a920ad8ea9132e8d44c316
