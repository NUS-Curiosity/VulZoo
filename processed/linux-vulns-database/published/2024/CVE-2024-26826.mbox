From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-26826: mptcp: fix data re-injection from stale subflow

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

mptcp: fix data re-injection from stale subflow

When the MPTCP PM detects that a subflow is stale, all the packet
scheduler must re-inject all the mptcp-level unacked data. To avoid
acquiring unneeded locks, it first try to check if any unacked data
is present at all in the RTX queue, but such check is currently
broken, as it uses TCP-specific helper on an MPTCP socket.

Funnily enough fuzzers and static checkers are happy, as the accessed
memory still belongs to the mptcp_sock struct, and even from a
functional perspective the recovery completed successfully, as
the short-cut test always failed.

A recent unrelated TCP change - commit d5fed5addb2b ("tcp: reorganize
tcp_sock fast path variables") - exposed the issue, as the tcp field
reorganization makes the mptcp code always skip the re-inection.

Fix the issue dropping the bogus call: we are on a slow path, the early
optimization proved once again to be evil.

The Linux kernel CVE team has assigned CVE-2024-26826 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.15 with commit 1e1d9d6f119c55c05e8ea78ed3e49046690abffd and fixed in 5.15.149 with commit 6f95120f898b40d13fd441225ef511307853c9c2
	Issue introduced in 5.15 with commit 1e1d9d6f119c55c05e8ea78ed3e49046690abffd and fixed in 6.1.79 with commit 6673d9f1c2cd984390550dbdf7d5ae07b20abbf8
	Issue introduced in 5.15 with commit 1e1d9d6f119c55c05e8ea78ed3e49046690abffd and fixed in 6.6.18 with commit b609c783c535493aa3fca22c7e40a120370b1ca5
	Issue introduced in 5.15 with commit 1e1d9d6f119c55c05e8ea78ed3e49046690abffd and fixed in 6.7.6 with commit 624902eab7abcb8731b333ec73f206d38d839cd8
	Issue introduced in 5.15 with commit 1e1d9d6f119c55c05e8ea78ed3e49046690abffd and fixed in 6.8 with commit b6c620dc43ccb4e802894e54b651cf81495e9598

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-26826
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/mptcp/protocol.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/6f95120f898b40d13fd441225ef511307853c9c2
	https://git.kernel.org/stable/c/6673d9f1c2cd984390550dbdf7d5ae07b20abbf8
	https://git.kernel.org/stable/c/b609c783c535493aa3fca22c7e40a120370b1ca5
	https://git.kernel.org/stable/c/624902eab7abcb8731b333ec73f206d38d839cd8
	https://git.kernel.org/stable/c/b6c620dc43ccb4e802894e54b651cf81495e9598
