From bippy-a5840b7849dd Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-38543: lib/test_hmm.c: handle src_pfns and dst_pfns allocation failure

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

lib/test_hmm.c: handle src_pfns and dst_pfns allocation failure

The kcalloc() in dmirror_device_evict_chunk() will return null if the
physical memory has run out.  As a result, if src_pfns or dst_pfns is
dereferenced, the null pointer dereference bug will happen.

Moreover, the device is going away.  If the kcalloc() fails, the pages
mapping a chunk could not be evicted.  So add a __GFP_NOFAIL flag in
kcalloc().

Finally, as there is no need to have physically contiguous memory, Switch
kcalloc() to kvcalloc() in order to avoid failing allocations.

The Linux kernel CVE team has assigned CVE-2024-38543 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.8 with commit b2ef9f5a5cb3 and fixed in 6.1.93 with commit 1a21fdeea502
	Issue introduced in 5.8 with commit b2ef9f5a5cb3 and fixed in 6.6.33 with commit 65e528a69cb3
	Issue introduced in 5.8 with commit b2ef9f5a5cb3 and fixed in 6.8.12 with commit ce47e8ead9a7
	Issue introduced in 5.8 with commit b2ef9f5a5cb3 and fixed in 6.9.3 with commit 3b20d18f475b
	Issue introduced in 5.8 with commit b2ef9f5a5cb3 and fixed in 6.10-rc1 with commit c2af060d1c18

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-38543
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	lib/test_hmm.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/1a21fdeea502658e315bd939409b755974f4fb64
	https://git.kernel.org/stable/c/65e528a69cb3ed4a286c45b4afba57461c8b5b33
	https://git.kernel.org/stable/c/ce47e8ead9a72834cc68431d53f8092ce69bebb7
	https://git.kernel.org/stable/c/3b20d18f475bd17309db640dbe7d7c7ebb5bc2bc
	https://git.kernel.org/stable/c/c2af060d1c18beaec56351cf9c9bcbbc5af341a3
