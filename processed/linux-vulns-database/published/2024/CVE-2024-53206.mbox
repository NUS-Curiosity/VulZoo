From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-53206: tcp: Fix use-after-free of nreq in reqsk_timer_handler().

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

tcp: Fix use-after-free of nreq in reqsk_timer_handler().

The cited commit replaced inet_csk_reqsk_queue_drop_and_put() with
__inet_csk_reqsk_queue_drop() and reqsk_put() in reqsk_timer_handler().

Then, oreq should be passed to reqsk_put() instead of req; otherwise
use-after-free of nreq could happen when reqsk is migrated but the
retry attempt failed (e.g. due to timeout).

Let's pass oreq to reqsk_put().

The Linux kernel CVE team has assigned CVE-2024-53206 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.15.170 with commit 8459d61fbf24967839a70235165673148c7c7f17 and fixed in 5.15.174 with commit 2dcc86fefe09ac853158afd96b60d544af115dc5
	Issue introduced in 6.1.115 with commit 5071beb59ee416e8ab456ac8647a4dabcda823b1 and fixed in 6.1.120 with commit 9a3c1ad93e6fba67b3a637cfa95a57a6685e4908
	Issue introduced in 6.6.59 with commit 997ae8da14f1639ce6fb66a063dab54031cd61b3 and fixed in 6.6.64 with commit 65ed89cad1f57034c256b016e89e8c0a4ec7c65b
	Issue introduced in 6.11.6 with commit 51e34db64f4e43c7b055ccf881b7f3e0c31bb26d and fixed in 6.11.11 with commit d0eb14cb8c08b00c36a3d5dc57a6f428b301f721
	Issue introduced in 6.12 with commit e8c526f2bdf1845bedaf6a478816a3d06fa78b8f and fixed in 6.12.2 with commit 6d845028609a4af0ad66f499ee0bd5789122b067
	Issue introduced in 6.12 with commit e8c526f2bdf1845bedaf6a478816a3d06fa78b8f and fixed in 6.13 with commit c31e72d021db2714df03df6c42855a1db592716c

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-53206
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/ipv4/inet_connection_sock.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/2dcc86fefe09ac853158afd96b60d544af115dc5
	https://git.kernel.org/stable/c/9a3c1ad93e6fba67b3a637cfa95a57a6685e4908
	https://git.kernel.org/stable/c/65ed89cad1f57034c256b016e89e8c0a4ec7c65b
	https://git.kernel.org/stable/c/d0eb14cb8c08b00c36a3d5dc57a6f428b301f721
	https://git.kernel.org/stable/c/6d845028609a4af0ad66f499ee0bd5789122b067
	https://git.kernel.org/stable/c/c31e72d021db2714df03df6c42855a1db592716c
