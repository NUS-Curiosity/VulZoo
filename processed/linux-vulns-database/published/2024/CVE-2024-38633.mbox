From bippy-7d53e8ef8be4 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-38633: serial: max3100: Update uart_driver_registered on driver removal

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

serial: max3100: Update uart_driver_registered on driver removal

The removal of the last MAX3100 device triggers the removal of
the driver. However, code doesn't update the respective global
variable and after insmod — rmmod — insmod cycle the kernel
oopses:

  max3100 spi-PRP0001:01: max3100_probe: adding port 0
  BUG: kernel NULL pointer dereference, address: 0000000000000408
  ...
  RIP: 0010:serial_core_register_port+0xa0/0x840
  ...
   max3100_probe+0x1b6/0x280 [max3100]
   spi_probe+0x8d/0xb0

Update the actual state so next time UART driver will be registered
again.

Hugo also noticed, that the error path in the probe also affected
by having the variable set, and not cleared. Instead of clearing it
move the assignment after the successfull uart_register_driver() call.

The Linux kernel CVE team has assigned CVE-2024-38633 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.30 with commit 7831d56b0a35 and fixed in 4.19.316 with commit 21a61a7fbcfd
	Issue introduced in 2.6.30 with commit 7831d56b0a35 and fixed in 5.4.278 with commit 9db4222ed8cd
	Issue introduced in 2.6.30 with commit 7831d56b0a35 and fixed in 5.10.219 with commit e8e2a4339dec
	Issue introduced in 2.6.30 with commit 7831d56b0a35 and fixed in 5.15.161 with commit 361a92c9038e
	Issue introduced in 2.6.30 with commit 7831d56b0a35 and fixed in 6.1.93 with commit b6eb7aff23e0
	Issue introduced in 2.6.30 with commit 7831d56b0a35 and fixed in 6.6.33 with commit e8a10089eddb
	Issue introduced in 2.6.30 with commit 7831d56b0a35 and fixed in 6.9.4 with commit fa84ca78b048
	Issue introduced in 2.6.30 with commit 7831d56b0a35 and fixed in 6.10-rc1 with commit 712a1fcb38dc

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-38633
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/tty/serial/max3100.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/21a61a7fbcfdd3493cede43ebc7c4dfae2147a8b
	https://git.kernel.org/stable/c/9db4222ed8cd3e50b81c8b910ae74c26427a4003
	https://git.kernel.org/stable/c/e8e2a4339decad7e59425b594a98613402652d72
	https://git.kernel.org/stable/c/361a92c9038e8c8c3996f8eeaa14522a8ad90752
	https://git.kernel.org/stable/c/b6eb7aff23e05f362e8c9b560f6ac5e727b70e00
	https://git.kernel.org/stable/c/e8a10089eddba40d4b2080c9d3fc2d2b2488f762
	https://git.kernel.org/stable/c/fa84ca78b048dfb00df0ef446f5c35e0a98ca6a0
	https://git.kernel.org/stable/c/712a1fcb38dc7cac6da63ee79a88708fbf9c45ec
