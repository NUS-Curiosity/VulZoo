From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-56665: bpf,perf: Fix invalid prog_array access in perf_event_detach_bpf_prog

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

bpf,perf: Fix invalid prog_array access in perf_event_detach_bpf_prog

Syzbot reported [1] crash that happens for following tracing scenario:

  - create tracepoint perf event with attr.inherit=1, attach it to the
    process and set bpf program to it
  - attached process forks -> chid creates inherited event

    the new child event shares the parent's bpf program and tp_event
    (hence prog_array) which is global for tracepoint

  - exit both process and its child -> release both events
  - first perf_event_detach_bpf_prog call will release tp_event->prog_array
    and second perf_event_detach_bpf_prog will crash, because
    tp_event->prog_array is NULL

The fix makes sure the perf_event_detach_bpf_prog checks prog_array
is valid before it tries to remove the bpf program from it.

[1] https://lore.kernel.org/bpf/Z1MR6dCIKajNS6nU@krava/T/#m91dbf0688221ec7a7fc95e896a7ef9ff93b0b8ad

The Linux kernel CVE team has assigned CVE-2024-56665 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.1.115 with commit 7a5c653ede645693422e43cccaa3e8f905d21c74 and fixed in 6.1.121 with commit 842e5af282453983586e2eae3c8eaf252de5f22f
	Issue introduced in 6.6.59 with commit 21db2f35fa97e4a3447f2edeb7b2569a8bfdc83b and fixed in 6.6.67 with commit c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d
	Issue introduced in 6.12 with commit 0ee288e69d033850bc87abe0f9cc3ada24763d7f and fixed in 6.12.6 with commit dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3
	Issue introduced in 6.12 with commit 0ee288e69d033850bc87abe0f9cc3ada24763d7f and fixed in 6.13 with commit 978c4486cca5c7b9253d3ab98a88c8e769cb9bbd
	Issue introduced in 5.15.170 with commit b4007d5fe38625b8a1b8edc0f385d86527651238
	Issue introduced in 6.11.6 with commit 585674b9d0d80bd7f428b1f88be13cf6d5d6f739

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-56665
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	kernel/trace/bpf_trace.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/842e5af282453983586e2eae3c8eaf252de5f22f
	https://git.kernel.org/stable/c/c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d
	https://git.kernel.org/stable/c/dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3
	https://git.kernel.org/stable/c/978c4486cca5c7b9253d3ab98a88c8e769cb9bbd
