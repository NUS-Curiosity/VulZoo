From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-39490: ipv6: sr: fix missing sk_buff release in seg6_input_core

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ipv6: sr: fix missing sk_buff release in seg6_input_core

The seg6_input() function is responsible for adding the SRH into a
packet, delegating the operation to the seg6_input_core(). This function
uses the skb_cow_head() to ensure that there is sufficient headroom in
the sk_buff for accommodating the link-layer header.
In the event that the skb_cow_header() function fails, the
seg6_input_core() catches the error but it does not release the sk_buff,
which will result in a memory leak.

This issue was introduced in commit af3b5158b89d ("ipv6: sr: fix BUG due
to headroom too small after SRH push") and persists even after commit
7a3f5b0de364 ("netfilter: add netfilter hooks to SRv6 data plane"),
where the entire seg6_input() code was refactored to deal with netfilter
hooks.

The proposed patch addresses the identified memory leak by requiring the
seg6_input_core() function to release the sk_buff in the event that
skb_cow_head() fails.

The Linux kernel CVE team has assigned CVE-2024-39490 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.12 with commit af3b5158b89d3bab9be881113417558c71b71ca4 and fixed in 5.15.161 with commit e8688218e38111ace457509d8f0cad75f79c1a7a
	Issue introduced in 4.12 with commit af3b5158b89d3bab9be881113417558c71b71ca4 and fixed in 6.1.93 with commit 8f1fc3b86eaea70be6abcae2e9aa7e7b99453864
	Issue introduced in 4.12 with commit af3b5158b89d3bab9be881113417558c71b71ca4 and fixed in 6.6.33 with commit f4df8c7670a73752201cbde215254598efdf6ce8
	Issue introduced in 4.12 with commit af3b5158b89d3bab9be881113417558c71b71ca4 and fixed in 6.9.4 with commit f5fec1588642e415a3d72e02140160661b303940
	Issue introduced in 4.12 with commit af3b5158b89d3bab9be881113417558c71b71ca4 and fixed in 6.10 with commit 5447f9708d9e4c17a647b16a9cb29e9e02820bd9

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-39490
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/ipv6/seg6_iptunnel.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e8688218e38111ace457509d8f0cad75f79c1a7a
	https://git.kernel.org/stable/c/8f1fc3b86eaea70be6abcae2e9aa7e7b99453864
	https://git.kernel.org/stable/c/f4df8c7670a73752201cbde215254598efdf6ce8
	https://git.kernel.org/stable/c/f5fec1588642e415a3d72e02140160661b303940
	https://git.kernel.org/stable/c/5447f9708d9e4c17a647b16a9cb29e9e02820bd9
