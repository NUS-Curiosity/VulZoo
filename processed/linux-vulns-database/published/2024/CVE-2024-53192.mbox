From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-53192: clk: clk-loongson2: Fix potential buffer overflow in flexible-array member access

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

clk: clk-loongson2: Fix potential buffer overflow in flexible-array member access

Flexible-array member `hws` in `struct clk_hw_onecell_data` is annotated
with the `counted_by()` attribute. This means that when memory is
allocated for this array, the _counter_, which in this case is member
`num` in the flexible structure, should be set to the maximum number of
elements the flexible array can contain, or fewer.

In this case, the total number of elements for the flexible array is
determined by variable `clks_num` when allocating heap space via
`devm_kzalloc()`, as shown below:

289         struct loongson2_clk_provider *clp;
	...
296         for (p = data; p->name; p++)
297                 clks_num++;
298
299         clp = devm_kzalloc(dev, struct_size(clp, clk_data.hws, clks_num),
300                            GFP_KERNEL);

So, `clp->clk_data.num` should be set to `clks_num` or less, and not
exceed `clks_num`, as is currently the case. Otherwise, if data is
written into `clp->clk_data.hws[clks_num]`, the instrumentation
provided by the compiler won't detect the overflow, leading to a
memory corruption bug at runtime.

Fix this issue by setting `clp->clk_data.num` to `clks_num`.

The Linux kernel CVE team has assigned CVE-2024-53192 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.10 with commit 9796ec0bd04bb0e70487127d44949ca0554df5d3 and fixed in 6.11.11 with commit b96fc194984d0c82de1ca2b4166b35b1298b216c
	Issue introduced in 6.10 with commit 9796ec0bd04bb0e70487127d44949ca0554df5d3 and fixed in 6.12.2 with commit 1bf8877150128c3abd9d233886a05f6966fbf0c7
	Issue introduced in 6.10 with commit 9796ec0bd04bb0e70487127d44949ca0554df5d3 and fixed in 6.13 with commit 02fb4f0084331ef72c28d0c70fcb15d1bea369ec

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-53192
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/clk/clk-loongson2.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/b96fc194984d0c82de1ca2b4166b35b1298b216c
	https://git.kernel.org/stable/c/1bf8877150128c3abd9d233886a05f6966fbf0c7
	https://git.kernel.org/stable/c/02fb4f0084331ef72c28d0c70fcb15d1bea369ec
