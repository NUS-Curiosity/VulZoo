From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-49987: bpftool: Fix undefined behavior in qsort(NULL, 0, ...)

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

bpftool: Fix undefined behavior in qsort(NULL, 0, ...)

When netfilter has no entry to display, qsort is called with
qsort(NULL, 0, ...). This results in undefined behavior, as UBSan
reports:

net.c:827:2: runtime error: null pointer passed as argument 1, which is declared to never be null

Although the C standard does not explicitly state whether calling qsort
with a NULL pointer when the size is 0 constitutes undefined behavior,
Section 7.1.4 of the C standard (Use of library functions) mentions:

"Each of the following statements applies unless explicitly stated
otherwise in the detailed descriptions that follow: If an argument to a
function has an invalid value (such as a value outside the domain of
the function, or a pointer outside the address space of the program, or
a null pointer, or a pointer to non-modifiable storage when the
corresponding parameter is not const-qualified) or a type (after
promotion) not expected by a function with variable number of
arguments, the behavior is undefined."

To avoid this, add an early return when nf_link_info is NULL to prevent
calling qsort with a NULL pointer.

The Linux kernel CVE team has assigned CVE-2024-49987 to this issue.


Affected and fixed versions
===========================

	Fixed in 6.6.55 with commit c2d9f9a7837ab29ccae0c42252f17d436bf0a501
	Fixed in 6.10.14 with commit 2e0f6f33f2aa87493b365a38a8fd87b8854b7734
	Fixed in 6.11.3 with commit c208b02827eb642758cef65641995fd3f38c89af
	Fixed in 6.12 with commit f04e2ad394e2755d0bb2d858ecb5598718bf00d5

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-49987
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	tools/bpf/bpftool/net.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/c2d9f9a7837ab29ccae0c42252f17d436bf0a501
	https://git.kernel.org/stable/c/2e0f6f33f2aa87493b365a38a8fd87b8854b7734
	https://git.kernel.org/stable/c/c208b02827eb642758cef65641995fd3f38c89af
	https://git.kernel.org/stable/c/f04e2ad394e2755d0bb2d858ecb5598718bf00d5
