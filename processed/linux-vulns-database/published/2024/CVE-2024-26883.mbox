From bippy-d175d3acf727 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-26883: bpf: Fix stackmap overflow check on 32-bit arches

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

bpf: Fix stackmap overflow check on 32-bit arches

The stackmap code relies on roundup_pow_of_two() to compute the number
of hash buckets, and contains an overflow check by checking if the
resulting value is 0. However, on 32-bit arches, the roundup code itself
can overflow by doing a 32-bit left-shift of an unsigned long value,
which is undefined behaviour, so it is not guaranteed to truncate
neatly. This was triggered by syzbot on the DEVMAP_HASH type, which
contains the same check, copied from the hashtab code.

The commit in the fixes tag actually attempted to fix this, but the fix
did not account for the UB, so the fix only works on CPUs where an
overflow does result in a neat truncation to zero, which is not
guaranteed. Checking the value before rounding does not have this
problem.

The Linux kernel CVE team has assigned CVE-2024-26883 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.19.177 with commit 063c722dd9d2 and fixed in 4.19.311 with commit d0e214acc591
	Issue introduced in 5.4.99 with commit 7e3a6b820535 and fixed in 5.4.273 with commit 21e5fa4688e1
	Issue introduced in 5.10.17 with commit 8032bf2af9ce and fixed in 5.10.214 with commit 15641007df0f
	Issue introduced in 5.11 with commit 6183f4d3a0a2 and fixed in 5.15.153 with commit ca1f06e72dec
	Issue introduced in 5.11 with commit 6183f4d3a0a2 and fixed in 6.1.83 with commit f06899582cce
	Issue introduced in 5.11 with commit 6183f4d3a0a2 and fixed in 6.6.23 with commit 7070b274c786
	Issue introduced in 5.11 with commit 6183f4d3a0a2 and fixed in 6.7.11 with commit 43f798b90364
	Issue introduced in 5.11 with commit 6183f4d3a0a2 and fixed in 6.8.2 with commit 0971126c8164
	Issue introduced in 5.11 with commit 6183f4d3a0a2 and fixed in 6.9 with commit 7a4b21250bf7
	Issue introduced in 4.9.258 with commit 253150830a01
	Issue introduced in 4.14.222 with commit 766107351731

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-26883
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	kernel/bpf/stackmap.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/d0e214acc59145ce25113f617311aa79dda39cb3
	https://git.kernel.org/stable/c/21e5fa4688e1a4d3db6b72216231b24232f75c1d
	https://git.kernel.org/stable/c/15641007df0f0d35fa28742b25c2a7db9dcd6895
	https://git.kernel.org/stable/c/ca1f06e72dec41ae4f76e7b1a8a97265447b46ae
	https://git.kernel.org/stable/c/f06899582ccee09bd85d0696290e3eaca9aa042d
	https://git.kernel.org/stable/c/7070b274c7866a4c5036f8d54fcaf315c64ac33a
	https://git.kernel.org/stable/c/43f798b9036491fb014b55dd61c4c5c3193267d0
	https://git.kernel.org/stable/c/0971126c8164abe2004b8536b49690a0d6005b0a
	https://git.kernel.org/stable/c/7a4b21250bf79eef26543d35bd390448646c536b
