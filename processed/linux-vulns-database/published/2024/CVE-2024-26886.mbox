From bippy-8e903de6a542 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-26886: Bluetooth: af_bluetooth: Fix deadlock

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

Bluetooth: af_bluetooth: Fix deadlock

Attemting to do sock_lock on .recvmsg may cause a deadlock as shown
bellow, so instead of using sock_sock this uses sk_receive_queue.lock
on bt_sock_ioctl to avoid the UAF:

INFO: task kworker/u9:1:121 blocked for more than 30 seconds.
      Not tainted 6.7.6-lemon #183
Workqueue: hci0 hci_rx_work
Call Trace:
 <TASK>
 __schedule+0x37d/0xa00
 schedule+0x32/0xe0
 __lock_sock+0x68/0xa0
 ? __pfx_autoremove_wake_function+0x10/0x10
 lock_sock_nested+0x43/0x50
 l2cap_sock_recv_cb+0x21/0xa0
 l2cap_recv_frame+0x55b/0x30a0
 ? psi_task_switch+0xeb/0x270
 ? finish_task_switch.isra.0+0x93/0x2a0
 hci_rx_work+0x33a/0x3f0
 process_one_work+0x13a/0x2f0
 worker_thread+0x2f0/0x410
 ? __pfx_worker_thread+0x10/0x10
 kthread+0xe0/0x110
 ? __pfx_kthread+0x10/0x10
 ret_from_fork+0x2c/0x50
 ? __pfx_kthread+0x10/0x10
 ret_from_fork_asm+0x1b/0x30
 </TASK>

The Linux kernel CVE team has assigned CVE-2024-26886 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.1.70 with commit 37f71e2c9f51 and fixed in 6.1.83 with commit cb8adca52f30
	Issue introduced in 6.1.70 with commit 37f71e2c9f51 and fixed in 6.1.118 with commit 0625d7c240b3
	Issue introduced in 6.6.9 with commit 1d576c3a5af8 and fixed in 6.6.23 with commit 64be3c615488
	Issue introduced in 6.7 with commit 2e07e8348ea4 and fixed in 6.7.11 with commit 817e8138ce86
	Issue introduced in 6.7 with commit 2e07e8348ea4 and fixed in 6.8.2 with commit 2c9e2df022ef
	Issue introduced in 6.7 with commit 2e07e8348ea4 and fixed in 6.9 with commit f7b94bdc1ec1
	Issue introduced in 5.10.206 with commit db1b14eec8c6
	Issue introduced in 5.15.146 with commit 2b16d960c79a

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-26886
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/bluetooth/af_bluetooth.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/cb8adca52f306563d958a863bb0cbae9c184d1ae
	https://git.kernel.org/stable/c/0625d7c240b307b78640dcd823cb738cb900a8ba
	https://git.kernel.org/stable/c/64be3c6154886200708da0dfe259705fb992416c
	https://git.kernel.org/stable/c/817e8138ce86001b2fa5c63d6ede756e205a01f7
	https://git.kernel.org/stable/c/2c9e2df022ef8b9d7fac58a04a2ef4ed25288955
	https://git.kernel.org/stable/c/f7b94bdc1ec107c92262716b073b3e816d4784fb
