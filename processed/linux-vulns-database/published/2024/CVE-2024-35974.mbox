From bippy-d175d3acf727 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-35974: block: fix q->blkg_list corruption during disk rebind

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

block: fix q->blkg_list corruption during disk rebind

Multiple gendisk instances can allocated/added for single request queue
in case of disk rebind. blkg may still stay in q->blkg_list when calling
blkcg_init_disk() for rebind, then q->blkg_list becomes corrupted.

Fix the list corruption issue by:

- add blkg_init_queue() to initialize q->blkg_list & q->blkcg_mutex only
- move calling blkg_init_queue() into blk_alloc_queue()

The list corruption should be started since commit f1c006f1c685 ("blk-cgroup:
synchronize pd_free_fn() from blkg_free_workfn() and blkcg_deactivate_policy()")
which delays removing blkg from q->blkg_list into blkg_free_workfn().

The Linux kernel CVE team has assigned CVE-2024-35974 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.18 with commit 1059699f87eb and fixed in 6.6.28 with commit 740ffad95ca8
	Issue introduced in 5.18 with commit 1059699f87eb and fixed in 6.8.7 with commit 858c489d81d6
	Issue introduced in 5.18 with commit 1059699f87eb and fixed in 6.9 with commit 8b8ace080319

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-35974
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	block/blk-cgroup.c
	block/blk-cgroup.h
	block/blk-core.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/740ffad95ca8033bd6e080ed337655b13b4d38ac
	https://git.kernel.org/stable/c/858c489d81d659af17a4d11cfaad2afb42e47a76
	https://git.kernel.org/stable/c/8b8ace080319a866f5dfe9da8e665ae51d971c54
