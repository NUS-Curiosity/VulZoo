From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-43835: virtio_net: Fix napi_skb_cache_put warning

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

virtio_net: Fix napi_skb_cache_put warning

After the commit bdacf3e34945 ("net: Use nested-BH locking for
napi_alloc_cache.") was merged, the following warning began to appear:

	 WARNING: CPU: 5 PID: 1 at net/core/skbuff.c:1451 napi_skb_cache_put+0x82/0x4b0

	  __warn+0x12f/0x340
	  napi_skb_cache_put+0x82/0x4b0
	  napi_skb_cache_put+0x82/0x4b0
	  report_bug+0x165/0x370
	  handle_bug+0x3d/0x80
	  exc_invalid_op+0x1a/0x50
	  asm_exc_invalid_op+0x1a/0x20
	  __free_old_xmit+0x1c8/0x510
	  napi_skb_cache_put+0x82/0x4b0
	  __free_old_xmit+0x1c8/0x510
	  __free_old_xmit+0x1c8/0x510
	  __pfx___free_old_xmit+0x10/0x10

The issue arises because virtio is assuming it's running in NAPI context
even when it's not, such as in the netpoll case.

To resolve this, modify virtnet_poll_tx() to only set NAPI when budget
is available. Same for virtnet_poll_cleantx(), which always assumed that
it was in a NAPI context.

The Linux kernel CVE team has assigned CVE-2024-43835 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.0 with commit df133f3f96257ee29696c0ed8bd198ec801dc810 and fixed in 4.19.322 with commit 19ac6f29bf64304ef04630c8ab56ecd2059d7aa1
	Issue introduced in 5.0 with commit df133f3f96257ee29696c0ed8bd198ec801dc810 and fixed in 5.4.284 with commit d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa
	Issue introduced in 5.0 with commit df133f3f96257ee29696c0ed8bd198ec801dc810 and fixed in 5.10.226 with commit 842a97b5e44f0c8a9fc356fe976e0e13ddcf7783
	Issue introduced in 5.0 with commit df133f3f96257ee29696c0ed8bd198ec801dc810 and fixed in 5.15.167 with commit cc7340f18e45886121c131227985d64ef666012f
	Issue introduced in 5.0 with commit df133f3f96257ee29696c0ed8bd198ec801dc810 and fixed in 6.1.109 with commit 6b5325f2457521bbece29499970c0117a648c620
	Issue introduced in 5.0 with commit df133f3f96257ee29696c0ed8bd198ec801dc810 and fixed in 6.6.50 with commit f5e9a22d19bb98a7e86034db85eb295e94187caa
	Issue introduced in 5.0 with commit df133f3f96257ee29696c0ed8bd198ec801dc810 and fixed in 6.10.3 with commit 468a729b78895893d0e580ceea49bed8ada2a2bd
	Issue introduced in 5.0 with commit df133f3f96257ee29696c0ed8bd198ec801dc810 and fixed in 6.11 with commit f8321fa75102246d7415a6af441872f6637c93ab

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-43835
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/virtio_net.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/19ac6f29bf64304ef04630c8ab56ecd2059d7aa1
	https://git.kernel.org/stable/c/d3af435e8ace119e58d8e21d3d2d6a4e7c4a4baa
	https://git.kernel.org/stable/c/842a97b5e44f0c8a9fc356fe976e0e13ddcf7783
	https://git.kernel.org/stable/c/cc7340f18e45886121c131227985d64ef666012f
	https://git.kernel.org/stable/c/6b5325f2457521bbece29499970c0117a648c620
	https://git.kernel.org/stable/c/f5e9a22d19bb98a7e86034db85eb295e94187caa
	https://git.kernel.org/stable/c/468a729b78895893d0e580ceea49bed8ada2a2bd
	https://git.kernel.org/stable/c/f8321fa75102246d7415a6af441872f6637c93ab
