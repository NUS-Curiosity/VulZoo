From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-26690: net: stmmac: protect updates of 64-bit statistics counters

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net: stmmac: protect updates of 64-bit statistics counters

As explained by a comment in <linux/u64_stats_sync.h>, write side of struct
u64_stats_sync must ensure mutual exclusion, or one seqcount update could
be lost on 32-bit platforms, thus blocking readers forever. Such lockups
have been observed in real world after stmmac_xmit() on one CPU raced with
stmmac_napi_poll_tx() on another CPU.

To fix the issue without introducing a new lock, split the statics into
three parts:

1. fields updated only under the tx queue lock,
2. fields updated only during NAPI poll,
3. fields updated only from interrupt context,

Updates to fields in the first two groups are already serialized through
other locks. It is sufficient to split the existing struct u64_stats_sync
so that each group has its own.

Note that tx_set_ic_bit is updated from both contexts. Split this counter
so that each context gets its own, and calculate their sum to get the total
value in stmmac_get_ethtool_stats().

For the third group, multiple interrupts may be processed by different CPUs
at the same time, but interrupts on the same CPU will not nest. Move fields
from this group to a newly created per-cpu struct stmmac_pcpu_stats.

The Linux kernel CVE team has assigned CVE-2024-26690 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.6 with commit 133466c3bbe171f826294161db203f7670bb30c8 and fixed in 6.6.18 with commit 9680b2ab54ba8d72581100e8c45471306101836e
	Issue introduced in 6.6 with commit 133466c3bbe171f826294161db203f7670bb30c8 and fixed in 6.7.6 with commit e6af0f082a4b87b99ad033003be2a904a1791b3f
	Issue introduced in 6.6 with commit 133466c3bbe171f826294161db203f7670bb30c8 and fixed in 6.8 with commit 38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-26690
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/ethernet/stmicro/stmmac/common.h
	drivers/net/ethernet/stmicro/stmmac/dwmac-sun8i.c
	drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c
	drivers/net/ethernet/stmicro/stmmac/dwmac_lib.c
	drivers/net/ethernet/stmicro/stmmac/dwxgmac2_dma.c
	drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c
	drivers/net/ethernet/stmicro/stmmac/stmmac_main.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/9680b2ab54ba8d72581100e8c45471306101836e
	https://git.kernel.org/stable/c/e6af0f082a4b87b99ad033003be2a904a1791b3f
	https://git.kernel.org/stable/c/38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8
