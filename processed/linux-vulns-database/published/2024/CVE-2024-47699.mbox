From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-47699: nilfs2: fix potential null-ptr-deref in nilfs_btree_insert()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

nilfs2: fix potential null-ptr-deref in nilfs_btree_insert()

Patch series "nilfs2: fix potential issues with empty b-tree nodes".

This series addresses three potential issues with empty b-tree nodes that
can occur with corrupted filesystem images, including one recently
discovered by syzbot.


This patch (of 3):

If a b-tree is broken on the device, and the b-tree height is greater than
2 (the level of the root node is greater than 1) even if the number of
child nodes of the b-tree root is 0, a NULL pointer dereference occurs in
nilfs_btree_prepare_insert(), which is called from nilfs_btree_insert().

This is because, when the number of child nodes of the b-tree root is 0,
nilfs_btree_do_lookup() does not set the block buffer head in any of
path[x].bp_bh, leaving it as the initial value of NULL, but if the level
of the b-tree root node is greater than 1, nilfs_btree_get_nonroot_node(),
which accesses the buffer memory of path[x].bp_bh, is called.

Fix this issue by adding a check to nilfs_btree_root_broken(), which
performs sanity checks when reading the root node from the device, to
detect this inconsistency.

Thanks to Lizhi Xu for trying to solve the bug and clarifying the cause
early on.

The Linux kernel CVE team has assigned CVE-2024-47699 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.30 with commit 17c76b0104e4a6513983777e1a17e0297a12b0c4 and fixed in 4.19.323 with commit 2b78e9df10fb7f4e9d3d7a18417dd72fbbc1dfd0
	Issue introduced in 2.6.30 with commit 17c76b0104e4a6513983777e1a17e0297a12b0c4 and fixed in 5.4.285 with commit 1d94dbdfbb64cc48d10dec65cc3c4fbf2497b343
	Issue introduced in 2.6.30 with commit 17c76b0104e4a6513983777e1a17e0297a12b0c4 and fixed in 5.10.227 with commit 24bf40740a3da6b4056721da34997ae6938f3da1
	Issue introduced in 2.6.30 with commit 17c76b0104e4a6513983777e1a17e0297a12b0c4 and fixed in 5.15.168 with commit 73d23ecf234b7a6d47fb883f2dabe10e3230b31d
	Issue introduced in 2.6.30 with commit 17c76b0104e4a6513983777e1a17e0297a12b0c4 and fixed in 6.1.113 with commit f68523e0f26faade18833fbef577a4295d8e2c94
	Issue introduced in 2.6.30 with commit 17c76b0104e4a6513983777e1a17e0297a12b0c4 and fixed in 6.6.54 with commit 21839b6fbc3c41b3e374ecbdb0cabbbb2c53cf34
	Issue introduced in 2.6.30 with commit 17c76b0104e4a6513983777e1a17e0297a12b0c4 and fixed in 6.10.13 with commit db73500d3f0e558eb642aae1d4782e7726b4a03f
	Issue introduced in 2.6.30 with commit 17c76b0104e4a6513983777e1a17e0297a12b0c4 and fixed in 6.11.2 with commit 3644554d308ddf2669e459a1551a7edf60b2d62b
	Issue introduced in 2.6.30 with commit 17c76b0104e4a6513983777e1a17e0297a12b0c4 and fixed in 6.12 with commit 9403001ad65ae4f4c5de368bdda3a0636b51d51a

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-47699
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/nilfs2/btree.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/2b78e9df10fb7f4e9d3d7a18417dd72fbbc1dfd0
	https://git.kernel.org/stable/c/1d94dbdfbb64cc48d10dec65cc3c4fbf2497b343
	https://git.kernel.org/stable/c/24bf40740a3da6b4056721da34997ae6938f3da1
	https://git.kernel.org/stable/c/73d23ecf234b7a6d47fb883f2dabe10e3230b31d
	https://git.kernel.org/stable/c/f68523e0f26faade18833fbef577a4295d8e2c94
	https://git.kernel.org/stable/c/21839b6fbc3c41b3e374ecbdb0cabbbb2c53cf34
	https://git.kernel.org/stable/c/db73500d3f0e558eb642aae1d4782e7726b4a03f
	https://git.kernel.org/stable/c/3644554d308ddf2669e459a1551a7edf60b2d62b
	https://git.kernel.org/stable/c/9403001ad65ae4f4c5de368bdda3a0636b51d51a
