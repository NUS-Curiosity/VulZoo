From bippy-c9c4e1df01b2 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-39503: netfilter: ipset: Fix race between namespace cleanup and gc in the list:set type

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

netfilter: ipset: Fix race between namespace cleanup and gc in the list:set type

Lion Ackermann reported that there is a race condition between namespace cleanup
in ipset and the garbage collection of the list:set type. The namespace
cleanup can destroy the list:set type of sets while the gc of the set type is
waiting to run in rcu cleanup. The latter uses data from the destroyed set which
thus leads use after free. The patch contains the following parts:

- When destroying all sets, first remove the garbage collectors, then wait
  if needed and then destroy the sets.
- Fix the badly ordered "wait then remove gc" for the destroy a single set
  case.
- Fix the missing rcu locking in the list:set type in the userspace test
  case.
- Use proper RCU list handlings in the list:set type.

The patch depends on c1193d9bbbd3 (netfilter: ipset: Add list flush to cancel_gc).

The Linux kernel CVE team has assigned CVE-2024-39503 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.4.269 with commit c7f2733e5011 and fixed in 5.4.279 with commit c0761d1f1ce1
	Issue introduced in 5.10.210 with commit a24d5f2ac8ef and fixed in 5.10.221 with commit 93b53c202b51
	Issue introduced in 5.15.149 with commit c2dc077d8f72 and fixed in 5.15.162 with commit 0f1bb77c6d83
	Issue introduced in 6.1.79 with commit 653bc5e6d999 and fixed in 6.1.95 with commit 390b353d1a1d
	Issue introduced in 6.6.18 with commit b93a6756a01f and fixed in 6.6.35 with commit 2ba35b37f780
	Issue introduced in 6.8 with commit 97f7cf1cd80e and fixed in 6.9.6 with commit 90ae20d47de6
	Issue introduced in 6.8 with commit 97f7cf1cd80e and fixed in 6.10 with commit 4e7aaa6b82d6
	Issue introduced in 6.7.6 with commit 970709a67696

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-39503
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/netfilter/ipset/ip_set_core.c
	net/netfilter/ipset/ip_set_list_set.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/c0761d1f1ce1d5b85b5e82bbb714df12de1aa8c3
	https://git.kernel.org/stable/c/93b53c202b51a69e42ca57f5a183f7e008e19f83
	https://git.kernel.org/stable/c/0f1bb77c6d837c9513943bc7c08f04c5cc5c6568
	https://git.kernel.org/stable/c/390b353d1a1da3e9c6c0fd14fe650d69063c95d6
	https://git.kernel.org/stable/c/2ba35b37f780c6410bb4bba9c3072596d8576702
	https://git.kernel.org/stable/c/90ae20d47de602198eb69e6cd7a3db3420abfc08
	https://git.kernel.org/stable/c/4e7aaa6b82d63e8ddcbfb56b4fd3d014ca586f10
