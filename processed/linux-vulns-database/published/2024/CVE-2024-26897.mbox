From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-26897: wifi: ath9k: delay all of ath9k_wmi_event_tasklet() until init is complete

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

wifi: ath9k: delay all of ath9k_wmi_event_tasklet() until init is complete

The ath9k_wmi_event_tasklet() used in ath9k_htc assumes that all the data
structures have been fully initialised by the time it runs. However, because of
the order in which things are initialised, this is not guaranteed to be the
case, because the device is exposed to the USB subsystem before the ath9k driver
initialisation is completed.

We already committed a partial fix for this in commit:
8b3046abc99e ("ath9k_htc: fix NULL pointer dereference at ath9k_htc_tx_get_packet()")

However, that commit only aborted the WMI_TXSTATUS_EVENTID command in the event
tasklet, pairing it with an "initialisation complete" bit in the TX struct. It
seems syzbot managed to trigger the race for one of the other commands as well,
so let's just move the existing synchronisation bit to cover the whole
tasklet (setting it at the end of ath9k_htc_probe_device() instead of inside
ath9k_tx_init()).

The Linux kernel CVE team has assigned CVE-2024-26897 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.10.136 with commit 78c8397132dd4735ac6a7b5a651302f0b9f264ad and fixed in 5.10.214 with commit 1bc5461a21c56a36e2a7d81e152b90ce019a3905
	Issue introduced in 5.15.17 with commit 735aefae7b68025cd04c482a940c0f6fc6797a63 and fixed in 5.15.153 with commit f8ff4b4df71e87f609be0cc37d92e918107f9b90
	Issue introduced in 5.17 with commit 8b3046abc99eefe11438090bcc4ec3a3994b55d0 and fixed in 6.1.83 with commit 74d0639261dd795dce958d1b14815bdcbb48a715
	Issue introduced in 5.17 with commit 8b3046abc99eefe11438090bcc4ec3a3994b55d0 and fixed in 6.6.23 with commit a015fbf698c8957aa5fbeefc5c59dd2cf3107298
	Issue introduced in 5.17 with commit 8b3046abc99eefe11438090bcc4ec3a3994b55d0 and fixed in 6.7.11 with commit ac90e22e735bac44f74b5161fb096fbeb0ff8bc2
	Issue introduced in 5.17 with commit 8b3046abc99eefe11438090bcc4ec3a3994b55d0 and fixed in 6.8.2 with commit 4afa0246656d5680c8a4c3fb37ba6570c4ab819b
	Issue introduced in 5.17 with commit 8b3046abc99eefe11438090bcc4ec3a3994b55d0 and fixed in 6.9 with commit 24355fcb0d4cbcb6ddda262596558e8cfba70f11
	Issue introduced in 5.16.3 with commit 7bbc1a50a7963f14048f0e54b0b73159f86d4ea3

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-26897
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/wireless/ath/ath9k/htc.h
	drivers/net/wireless/ath/ath9k/htc_drv_init.c
	drivers/net/wireless/ath/ath9k/htc_drv_txrx.c
	drivers/net/wireless/ath/ath9k/wmi.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/1bc5461a21c56a36e2a7d81e152b90ce019a3905
	https://git.kernel.org/stable/c/f8ff4b4df71e87f609be0cc37d92e918107f9b90
	https://git.kernel.org/stable/c/74d0639261dd795dce958d1b14815bdcbb48a715
	https://git.kernel.org/stable/c/a015fbf698c8957aa5fbeefc5c59dd2cf3107298
	https://git.kernel.org/stable/c/ac90e22e735bac44f74b5161fb096fbeb0ff8bc2
	https://git.kernel.org/stable/c/4afa0246656d5680c8a4c3fb37ba6570c4ab819b
	https://git.kernel.org/stable/c/24355fcb0d4cbcb6ddda262596558e8cfba70f11
