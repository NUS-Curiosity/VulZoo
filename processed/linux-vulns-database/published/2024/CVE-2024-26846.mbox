From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-26846: nvme-fc: do not wait in vain when unloading module

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

nvme-fc: do not wait in vain when unloading module

The module exit path has race between deleting all controllers and
freeing 'left over IDs'. To prevent double free a synchronization
between nvme_delete_ctrl and ida_destroy has been added by the initial
commit.

There is some logic around trying to prevent from hanging forever in
wait_for_completion, though it does not handling all cases. E.g.
blktests is able to reproduce the situation where the module unload
hangs forever.

If we completely rely on the cleanup code executed from the
nvme_delete_ctrl path, all IDs will be freed eventually. This makes
calling ida_destroy unnecessary. We only have to ensure that all
nvme_delete_ctrl code has been executed before we leave
nvme_fc_exit_module. This is done by flushing the nvme_delete_wq
workqueue.

While at it, remove the unused nvme_fc_wq workqueue too.

The Linux kernel CVE team has assigned CVE-2024-26846 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.10.211 with commit 4f2c95015ec2a1899161be6c0bdaecedd5a7bfb2
	Fixed in 5.15.150 with commit 0bf567d6d9ffe09e059bbdfb4d07143cef42c75c
	Fixed in 6.1.80 with commit 085195aa90a924c79e35569bcdad860d764a8e17
	Fixed in 6.6.19 with commit baa6b7eb8c66486bd64608adc63fe03b30d3c0b9
	Fixed in 6.7.7 with commit c0882c366418bf9c19e1ba7f270fe377a9bf5d67
	Fixed in 6.8 with commit 70fbfc47a392b98e5f8dba70c6efc6839205c982

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-26846
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/nvme/host/fc.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/4f2c95015ec2a1899161be6c0bdaecedd5a7bfb2
	https://git.kernel.org/stable/c/0bf567d6d9ffe09e059bbdfb4d07143cef42c75c
	https://git.kernel.org/stable/c/085195aa90a924c79e35569bcdad860d764a8e17
	https://git.kernel.org/stable/c/baa6b7eb8c66486bd64608adc63fe03b30d3c0b9
	https://git.kernel.org/stable/c/c0882c366418bf9c19e1ba7f270fe377a9bf5d67
	https://git.kernel.org/stable/c/70fbfc47a392b98e5f8dba70c6efc6839205c982
