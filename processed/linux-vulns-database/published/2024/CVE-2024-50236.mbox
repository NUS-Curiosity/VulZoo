From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-50236: wifi: ath10k: Fix memory leak in management tx

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

wifi: ath10k: Fix memory leak in management tx

In the current logic, memory is allocated for storing the MSDU context
during management packet TX but this memory is not being freed during
management TX completion. Similar leaks are seen in the management TX
cleanup logic.

Kmemleak reports this problem as below,

unreferenced object 0xffffff80b64ed250 (size 16):
  comm "kworker/u16:7", pid 148, jiffies 4294687130 (age 714.199s)
  hex dump (first 16 bytes):
    00 2b d8 d8 80 ff ff ff c4 74 e9 fd 07 00 00 00  .+.......t......
  backtrace:
    [<ffffffe6e7b245dc>] __kmem_cache_alloc_node+0x1e4/0x2d8
    [<ffffffe6e7adde88>] kmalloc_trace+0x48/0x110
    [<ffffffe6bbd765fc>] ath10k_wmi_tlv_op_gen_mgmt_tx_send+0xd4/0x1d8 [ath10k_core]
    [<ffffffe6bbd3eed4>] ath10k_mgmt_over_wmi_tx_work+0x134/0x298 [ath10k_core]
    [<ffffffe6e78d5974>] process_scheduled_works+0x1ac/0x400
    [<ffffffe6e78d60b8>] worker_thread+0x208/0x328
    [<ffffffe6e78dc890>] kthread+0x100/0x1c0
    [<ffffffe6e78166c0>] ret_from_fork+0x10/0x20

Free the memory during completion and cleanup to fix the leak.

Protect the mgmt_pending_tx idr_remove() operation in
ath10k_wmi_tlv_op_cleanup_mgmt_tx_send() using ar->data_lock similar to
other instances.

Tested-on: WCN3990 hw1.0 SNOC WLAN.HL.2.0-01387-QCAHLSWMTPLZ-1

The Linux kernel CVE team has assigned CVE-2024-50236 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.19 with commit dc405152bb64d4ae01c9ac669de25b2d1fb6fc2d and fixed in 4.19.323 with commit eff818238bedb9c2484c251ec46f9f160911cdc0
	Issue introduced in 4.19 with commit dc405152bb64d4ae01c9ac669de25b2d1fb6fc2d and fixed in 5.4.285 with commit 6fc9af3df6ca7f3c94774d20f62dc7b49616026d
	Issue introduced in 4.19 with commit dc405152bb64d4ae01c9ac669de25b2d1fb6fc2d and fixed in 5.10.229 with commit 4112450da7d67b59ccedc2208bae622db17dbcb8
	Issue introduced in 4.19 with commit dc405152bb64d4ae01c9ac669de25b2d1fb6fc2d and fixed in 5.15.171 with commit 705be2dc45c7f852e211e16bc41a916fab741983
	Issue introduced in 4.19 with commit dc405152bb64d4ae01c9ac669de25b2d1fb6fc2d and fixed in 6.1.116 with commit 6cc23898e6ba47e976050d3c080b4d2c1add3748
	Issue introduced in 4.19 with commit dc405152bb64d4ae01c9ac669de25b2d1fb6fc2d and fixed in 6.6.60 with commit 5f5a939759c79e7385946c85e62feca51a18d816
	Issue introduced in 4.19 with commit dc405152bb64d4ae01c9ac669de25b2d1fb6fc2d and fixed in 6.11.7 with commit 2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b
	Issue introduced in 4.19 with commit dc405152bb64d4ae01c9ac669de25b2d1fb6fc2d and fixed in 6.12 with commit e15d84b3bba187aa372dff7c58ce1fd5cb48a076
	Issue introduced in 4.19.129 with commit 2bc8b1816cf4908ae0a04c3e87e167d2dcb60f38

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-50236
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/wireless/ath/ath10k/wmi-tlv.c
	drivers/net/wireless/ath/ath10k/wmi.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/eff818238bedb9c2484c251ec46f9f160911cdc0
	https://git.kernel.org/stable/c/6fc9af3df6ca7f3c94774d20f62dc7b49616026d
	https://git.kernel.org/stable/c/4112450da7d67b59ccedc2208bae622db17dbcb8
	https://git.kernel.org/stable/c/705be2dc45c7f852e211e16bc41a916fab741983
	https://git.kernel.org/stable/c/6cc23898e6ba47e976050d3c080b4d2c1add3748
	https://git.kernel.org/stable/c/5f5a939759c79e7385946c85e62feca51a18d816
	https://git.kernel.org/stable/c/2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b
	https://git.kernel.org/stable/c/e15d84b3bba187aa372dff7c58ce1fd5cb48a076
