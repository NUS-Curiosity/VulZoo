From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-50115: KVM: nSVM: Ignore nCR3[4:0] when loading PDPTEs from memory

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

KVM: nSVM: Ignore nCR3[4:0] when loading PDPTEs from memory

Ignore nCR3[4:0] when loading PDPTEs from memory for nested SVM, as bits
4:0 of CR3 are ignored when PAE paging is used, and thus VMRUN doesn't
enforce 32-byte alignment of nCR3.

In the absolute worst case scenario, failure to ignore bits 4:0 can result
in an out-of-bounds read, e.g. if the target page is at the end of a
memslot, and the VMM isn't using guard pages.

Per the APM:

  The CR3 register points to the base address of the page-directory-pointer
  table. The page-directory-pointer table is aligned on a 32-byte boundary,
  with the low 5 address bits 4:0 assumed to be 0.

And the SDM's much more explicit:

  4:0    Ignored

Note, KVM gets this right when loading PDPTRs, it's only the nSVM flow
that is broken.

The Linux kernel CVE team has assigned CVE-2024-50115 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.2 with commit e4e517b4be019787ada4cbbce2f04570c21b0cbd and fixed in 5.10.229 with commit 76ce386feb14ec9a460784fcd495d8432acce7a5
	Issue introduced in 3.2 with commit e4e517b4be019787ada4cbbce2f04570c21b0cbd and fixed in 5.15.170 with commit 58cb697d80e669c56197f703e188867c8c54c494
	Issue introduced in 3.2 with commit e4e517b4be019787ada4cbbce2f04570c21b0cbd and fixed in 6.1.115 with commit 6876793907cbe19d42e9edc8c3315a21e06c32ae
	Issue introduced in 3.2 with commit e4e517b4be019787ada4cbbce2f04570c21b0cbd and fixed in 6.6.59 with commit 2c4adc9b192a0815fe58a62bc0709449416cc884
	Issue introduced in 3.2 with commit e4e517b4be019787ada4cbbce2f04570c21b0cbd and fixed in 6.11.6 with commit 426682afec71ea3f889b972d038238807b9443e4
	Issue introduced in 3.2 with commit e4e517b4be019787ada4cbbce2f04570c21b0cbd and fixed in 6.12 with commit f559b2e9c5c5308850544ab59396b7d53cfc67bd

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-50115
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/x86/kvm/svm/nested.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/76ce386feb14ec9a460784fcd495d8432acce7a5
	https://git.kernel.org/stable/c/58cb697d80e669c56197f703e188867c8c54c494
	https://git.kernel.org/stable/c/6876793907cbe19d42e9edc8c3315a21e06c32ae
	https://git.kernel.org/stable/c/2c4adc9b192a0815fe58a62bc0709449416cc884
	https://git.kernel.org/stable/c/426682afec71ea3f889b972d038238807b9443e4
	https://git.kernel.org/stable/c/f559b2e9c5c5308850544ab59396b7d53cfc67bd
