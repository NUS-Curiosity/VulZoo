From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-47060: KVM: Stop looking for coalesced MMIO zones if the bus is destroyed

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

KVM: Stop looking for coalesced MMIO zones if the bus is destroyed

Abort the walk of coalesced MMIO zones if kvm_io_bus_unregister_dev()
fails to allocate memory for the new instance of the bus.  If it can't
instantiate a new bus, unregister_dev() destroys all devices _except_ the
target device.   But, it doesn't tell the caller that it obliterated the
bus and invoked the destructor for all devices that were on the bus.  In
the coalesced MMIO case, this can result in a deleted list entry
dereference due to attempting to continue iterating on coalesced_zones
after future entries (in the walk) have been deleted.

Opportunistically add curly braces to the for-loop, which encompasses
many lines but sneaks by without braces due to the guts being a single
if statement.

The Linux kernel CVE team has assigned CVE-2021-47060 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.4.66 with commit 41b2ea7a6a11e2b1a7f2c29e1675a709a6b2b98d and fixed in 5.4.119 with commit 7d1bc32d6477ff96a32695ea4be8144e4513ab2d
	Issue introduced in 5.9 with commit f65886606c2d3b562716de030706dfe1bea4ed5e and fixed in 5.10.37 with commit 2a20592baff59c5351c5200ec667e1a2aa22af85
	Issue introduced in 5.9 with commit f65886606c2d3b562716de030706dfe1bea4ed5e and fixed in 5.11.21 with commit 168e82f640ed1891a700bdb43e37da354b2ab63c
	Issue introduced in 5.9 with commit f65886606c2d3b562716de030706dfe1bea4ed5e and fixed in 5.12.4 with commit 50cbad42bfea8c052b7ca590bd4126cdc898713c
	Issue introduced in 5.9 with commit f65886606c2d3b562716de030706dfe1bea4ed5e and fixed in 5.13 with commit 5d3c4c79384af06e3c8e25b7770b6247496b4417
	Issue introduced in 4.4.238 with commit f0dfffce3f4ffd5f822568a4a6fb34c010e939d1
	Issue introduced in 4.9.238 with commit 840e124f89a5127e7eb97ebf377f4b8ca745c070
	Issue introduced in 4.14.200 with commit 40a023f681befd9b2862a3c16fb306a38b359ae5
	Issue introduced in 4.19.148 with commit 19184bd06f488af62924ff1747614a8cb284ad63
	Issue introduced in 5.8.10 with commit 68c125324b5e1d1d22805653735442923d896a1d

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-47060
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	include/linux/kvm_host.h
	virt/kvm/coalesced_mmio.c
	virt/kvm/kvm_main.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/7d1bc32d6477ff96a32695ea4be8144e4513ab2d
	https://git.kernel.org/stable/c/2a20592baff59c5351c5200ec667e1a2aa22af85
	https://git.kernel.org/stable/c/168e82f640ed1891a700bdb43e37da354b2ab63c
	https://git.kernel.org/stable/c/50cbad42bfea8c052b7ca590bd4126cdc898713c
	https://git.kernel.org/stable/c/5d3c4c79384af06e3c8e25b7770b6247496b4417
