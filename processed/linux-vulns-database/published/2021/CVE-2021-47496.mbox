From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-47496: net/tls: Fix flipped sign in tls_err_abort() calls

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net/tls: Fix flipped sign in tls_err_abort() calls

sk->sk_err appears to expect a positive value, a convention that ktls
doesn't always follow and that leads to memory corruption in other code.
For instance,

    [kworker]
    tls_encrypt_done(..., err=<negative error from crypto request>)
      tls_err_abort(.., err)
        sk->sk_err = err;

    [task]
    splice_from_pipe_feed
      ...
        tls_sw_do_sendpage
          if (sk->sk_err) {
            ret = -sk->sk_err;  // ret is positive

    splice_from_pipe_feed (continued)
      ret = actor(...)  // ret is still positive and interpreted as bytes
                        // written, resulting in underflow of buf->len and
                        // sd->len, leading to huge buf->offset and bogus
                        // addresses computed in later calls to actor()

Fix all tls_err_abort() callers to pass a negative error code
consistently and centralize the error-prone sign flip there, throwing in
a warning to catch future misuse and uninlining the function so it
really does only warn once.

The Linux kernel CVE team has assigned CVE-2021-47496 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.17 with commit c46234ebb4d1eee5e09819f49169e51cfc6eb909 and fixed in 5.4.157 with commit e0cfd5159f314d6b304d030363650b06a2299cbb
	Issue introduced in 4.17 with commit c46234ebb4d1eee5e09819f49169e51cfc6eb909 and fixed in 5.10.77 with commit f3dec7e7ace38224f82cf83f0049159d067c2e19
	Issue introduced in 4.17 with commit c46234ebb4d1eee5e09819f49169e51cfc6eb909 and fixed in 5.14.16 with commit e41473543f75f7dbc5d605007e6f883f1bd13b9a
	Issue introduced in 4.17 with commit c46234ebb4d1eee5e09819f49169e51cfc6eb909 and fixed in 5.15 with commit da353fac65fede6b8b4cfe207f0d9408e3121105

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-47496
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	include/net/tls.h
	net/tls/tls_sw.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e0cfd5159f314d6b304d030363650b06a2299cbb
	https://git.kernel.org/stable/c/f3dec7e7ace38224f82cf83f0049159d067c2e19
	https://git.kernel.org/stable/c/e41473543f75f7dbc5d605007e6f883f1bd13b9a
	https://git.kernel.org/stable/c/da353fac65fede6b8b4cfe207f0d9408e3121105
