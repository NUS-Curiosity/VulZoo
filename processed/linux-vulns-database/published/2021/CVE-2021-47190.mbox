From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-47190: perf bpf: Avoid memory leak from perf_env__insert_btf()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

perf bpf: Avoid memory leak from perf_env__insert_btf()

perf_env__insert_btf() doesn't insert if a duplicate BTF id is
encountered and this causes a memory leak. Modify the function to return
a success/error value and then free the memory if insertion didn't
happen.

v2. Adds a return -1 when the insertion error occurs in
    perf_env__fetch_btf. This doesn't affect anything as the result is
    never checked.

The Linux kernel CVE team has assigned CVE-2021-47190 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.1 with commit 3792cb2ff43b1b193136a03ce1336462a827d792 and fixed in 5.4.162 with commit 642fc22210a5e59d40b1e4d56d21ec3effd401f2
	Issue introduced in 5.1 with commit 3792cb2ff43b1b193136a03ce1336462a827d792 and fixed in 5.10.82 with commit 11589d3144bc4e272e0aae46ce8156162e99babc
	Issue introduced in 5.1 with commit 3792cb2ff43b1b193136a03ce1336462a827d792 and fixed in 5.15.5 with commit ab7c3d8d81c511ddfb27823fb07081c96422b56e
	Issue introduced in 5.1 with commit 3792cb2ff43b1b193136a03ce1336462a827d792 and fixed in 5.16 with commit 4924b1f7c46711762fd0e65c135ccfbcfd6ded1f

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-47190
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	tools/perf/util/bpf-event.c
	tools/perf/util/env.c
	tools/perf/util/env.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/642fc22210a5e59d40b1e4d56d21ec3effd401f2
	https://git.kernel.org/stable/c/11589d3144bc4e272e0aae46ce8156162e99babc
	https://git.kernel.org/stable/c/ab7c3d8d81c511ddfb27823fb07081c96422b56e
	https://git.kernel.org/stable/c/4924b1f7c46711762fd0e65c135ccfbcfd6ded1f
