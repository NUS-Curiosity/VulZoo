From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-47254: gfs2: Fix use-after-free in gfs2_glock_shrink_scan

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

gfs2: Fix use-after-free in gfs2_glock_shrink_scan

The GLF_LRU flag is checked under lru_lock in gfs2_glock_remove_from_lru() to
remove the glock from the lru list in __gfs2_glock_put().

On the shrink scan path, the same flag is cleared under lru_lock but because
of cond_resched_lock(&lru_lock) in gfs2_dispose_glock_lru(), progress on the
put side can be made without deleting the glock from the lru list.

Keep GLF_LRU across the race window opened by cond_resched_lock(&lru_lock) to
ensure correct behavior on both sides - clear GLF_LRU after list_del under
lru_lock.

The Linux kernel CVE team has assigned CVE-2021-47254 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.4.274 with commit 38ce329534500bf4ae71f81df6a37a406cf187b4
	Fixed in 4.9.274 with commit 92869945cc5b78ee8a1ef90336fe070893e3458a
	Fixed in 4.14.238 with commit 0364742decb0f02bc183404868b82896f7992595
	Fixed in 4.19.196 with commit 094bf5670e762afa243d2c41a5c4ab71c7447bf4
	Fixed in 5.4.127 with commit 86fd5b27db743a0ce0cc245e3a34813b2aa6ec1d
	Fixed in 5.10.45 with commit a61156314b66456ab6a291ed5deba1ebd002ab3c
	Fixed in 5.12.12 with commit e87ef30fe73e7e10d2c85bdcc778dcec24dca553
	Fixed in 5.13 with commit 1ab19c5de4c537ec0d9b21020395a5b5a6c059b2

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-47254
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/gfs2/glock.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/38ce329534500bf4ae71f81df6a37a406cf187b4
	https://git.kernel.org/stable/c/92869945cc5b78ee8a1ef90336fe070893e3458a
	https://git.kernel.org/stable/c/0364742decb0f02bc183404868b82896f7992595
	https://git.kernel.org/stable/c/094bf5670e762afa243d2c41a5c4ab71c7447bf4
	https://git.kernel.org/stable/c/86fd5b27db743a0ce0cc245e3a34813b2aa6ec1d
	https://git.kernel.org/stable/c/a61156314b66456ab6a291ed5deba1ebd002ab3c
	https://git.kernel.org/stable/c/e87ef30fe73e7e10d2c85bdcc778dcec24dca553
	https://git.kernel.org/stable/c/1ab19c5de4c537ec0d9b21020395a5b5a6c059b2
