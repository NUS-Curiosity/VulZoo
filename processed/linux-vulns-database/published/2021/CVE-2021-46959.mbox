From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-46959: spi: Fix use-after-free with devm_spi_alloc_*

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

spi: Fix use-after-free with devm_spi_alloc_*

We can't rely on the contents of the devres list during
spi_unregister_controller(), as the list is already torn down at the
time we perform devres_find() for devm_spi_release_controller. This
causes devices registered with devm_spi_alloc_{master,slave}() to be
mistakenly identified as legacy, non-devm managed devices and have their
reference counters decremented below 0.

------------[ cut here ]------------
WARNING: CPU: 1 PID: 660 at lib/refcount.c:28 refcount_warn_saturate+0x108/0x174
[<b0396f04>] (refcount_warn_saturate) from [<b03c56a4>] (kobject_put+0x90/0x98)
[<b03c5614>] (kobject_put) from [<b0447b4c>] (put_device+0x20/0x24)
 r4:b6700140
[<b0447b2c>] (put_device) from [<b07515e8>] (devm_spi_release_controller+0x3c/0x40)
[<b07515ac>] (devm_spi_release_controller) from [<b045343c>] (release_nodes+0x84/0xc4)
 r5:b6700180 r4:b6700100
[<b04533b8>] (release_nodes) from [<b0454160>] (devres_release_all+0x5c/0x60)
 r8:b1638c54 r7:b117ad94 r6:b1638c10 r5:b117ad94 r4:b163dc10
[<b0454104>] (devres_release_all) from [<b044e41c>] (__device_release_driver+0x144/0x1ec)
 r5:b117ad94 r4:b163dc10
[<b044e2d8>] (__device_release_driver) from [<b044f70c>] (device_driver_detach+0x84/0xa0)
 r9:00000000 r8:00000000 r7:b117ad94 r6:b163dc54 r5:b1638c10 r4:b163dc10
[<b044f688>] (device_driver_detach) from [<b044d274>] (unbind_store+0xe4/0xf8)

Instead, determine the devm allocation state as a flag on the
controller which is guaranteed to be stable during cleanup.

The Linux kernel CVE team has assigned CVE-2021-46959 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.4.248 with commit a4add022c1552b0d51a0b89a4781919d6ebac4f9 and fixed in 4.4.271 with commit 62bb2c7f2411a0045c24831f11ecacfc35610815
	Issue introduced in 4.9.248 with commit 0870525cf94bc27907e94ce99afb6d7239ffd2f5 and fixed in 4.9.271 with commit 8bf96425c90f5c1dcf3b7b9df568019a1d4b8a0e
	Issue introduced in 4.14.212 with commit 8c45a1c6c951bbe7f95db78fcab46f7337364468 and fixed in 4.14.233 with commit 8e029707f50a82c53172359c686b2536ab54e58c
	Issue introduced in 4.19.163 with commit 234b432c7b6184b2d6c5ba2c55f0dd5023c0edf0 and fixed in 4.19.191 with commit 28a5529068c51cdf0295ab1e11a99a3a909a03e4
	Issue introduced in 5.4.80 with commit 3e04a4976addbedcad326f47b0dd4efc570a1fac and fixed in 5.4.119 with commit 001c8e83646ad3b847b18f6ac55a54367d917d74
	Issue introduced in 5.10 with commit 5e844cc37a5cbaa460e68f9a989d321d63088a89 and fixed in 5.10.37 with commit c7fabe372a9031acd00498bc718ce27c253abfd1
	Issue introduced in 5.10 with commit 5e844cc37a5cbaa460e68f9a989d321d63088a89 and fixed in 5.11.21 with commit cee78aa24578edac8cf00513dca618c0acc17cd7
	Issue introduced in 5.10 with commit 5e844cc37a5cbaa460e68f9a989d321d63088a89 and fixed in 5.12.4 with commit 8735248ebb918d25427965f0db07939ed0473ec6
	Issue introduced in 5.10 with commit 5e844cc37a5cbaa460e68f9a989d321d63088a89 and fixed in 5.13 with commit 794aaf01444d4e765e2b067cba01cc69c1c68ed9
	Issue introduced in 5.9.11 with commit bd1a5b2307279029faaddbecf2f2ac25eaef8dc6

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-46959
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/spi/spi.c
	include/linux/spi/spi.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/62bb2c7f2411a0045c24831f11ecacfc35610815
	https://git.kernel.org/stable/c/8bf96425c90f5c1dcf3b7b9df568019a1d4b8a0e
	https://git.kernel.org/stable/c/8e029707f50a82c53172359c686b2536ab54e58c
	https://git.kernel.org/stable/c/28a5529068c51cdf0295ab1e11a99a3a909a03e4
	https://git.kernel.org/stable/c/001c8e83646ad3b847b18f6ac55a54367d917d74
	https://git.kernel.org/stable/c/c7fabe372a9031acd00498bc718ce27c253abfd1
	https://git.kernel.org/stable/c/cee78aa24578edac8cf00513dca618c0acc17cd7
	https://git.kernel.org/stable/c/8735248ebb918d25427965f0db07939ed0473ec6
	https://git.kernel.org/stable/c/794aaf01444d4e765e2b067cba01cc69c1c68ed9
