From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-47429: powerpc/64s: Fix unrecoverable MCE calling async handler from NMI

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

powerpc/64s: Fix unrecoverable MCE calling async handler from NMI

The machine check handler is not considered NMI on 64s. The early
handler is the true NMI handler, and then it schedules the
machine_check_exception handler to run when interrupts are enabled.

This works fine except the case of an unrecoverable MCE, where the true
NMI is taken when MSR[RI] is clear, it can not recover, so it calls
machine_check_exception directly so something might be done about it.

Calling an async handler from NMI context can result in irq state and
other things getting corrupted. This can also trigger the BUG at
  arch/powerpc/include/asm/interrupt.h:168
  BUG_ON(!arch_irq_disabled_regs(regs) && !(regs->msr & MSR_EE));

Fix this by making an _async version of the handler which is called
in the normal case, and a NMI version that is called for unrecoverable
interrupts.

The Linux kernel CVE team has assigned CVE-2021-47429 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.14 with commit 2b43dd7653cca47d297756980846ebbfe8887fa1 and fixed in 5.14.12 with commit d7a8e38999fbd6910516e44cb43f9f4317e54f73
	Issue introduced in 5.14 with commit 2b43dd7653cca47d297756980846ebbfe8887fa1 and fixed in 5.15 with commit f08fb25bc66986b0952724530a640d9970fa52c1

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-47429
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/powerpc/include/asm/interrupt.h
	arch/powerpc/kernel/exceptions-64s.S
	arch/powerpc/kernel/traps.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/d7a8e38999fbd6910516e44cb43f9f4317e54f73
	https://git.kernel.org/stable/c/f08fb25bc66986b0952724530a640d9970fa52c1
