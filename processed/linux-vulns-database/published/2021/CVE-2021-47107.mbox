From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-47107: NFSD: Fix READDIR buffer overflow

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

NFSD: Fix READDIR buffer overflow

If a client sends a READDIR count argument that is too small (say,
zero), then the buffer size calculation in the new init_dirlist
helper functions results in an underflow, allowing the XDR stream
functions to write beyond the actual buffer.

This calculation has always been suspect. NFSD has never sanity-
checked the READDIR count argument, but the old entry encoders
managed the problem correctly.

With the commits below, entry encoding changed, exposing the
underflow to the pointer arithmetic in xdr_reserve_space().

Modern NFS clients attempt to retrieve as much data as possible
for each READDIR request. Also, we have no unit tests that
exercise the behavior of READDIR at the lower bound of @count
values. Thus this case was missed during testing.

The Linux kernel CVE team has assigned CVE-2021-47107 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.13 with commit 7f87fc2d34d475225e78b7f5c4eabb121f4282b2 and fixed in 5.15.12 with commit eabc0aab98e5218ceecd82069b0d6fdfff5ee885
	Issue introduced in 5.13 with commit 7f87fc2d34d475225e78b7f5c4eabb121f4282b2 and fixed in 5.16 with commit 53b1119a6e5028b125f431a0116ba73510d82a72

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-47107
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/nfsd/nfs3proc.c
	fs/nfsd/nfsproc.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/9e291a6a28d32545ed2fd959a8165144d1724df1
	https://git.kernel.org/stable/c/eabc0aab98e5218ceecd82069b0d6fdfff5ee885
	https://git.kernel.org/stable/c/53b1119a6e5028b125f431a0116ba73510d82a72
