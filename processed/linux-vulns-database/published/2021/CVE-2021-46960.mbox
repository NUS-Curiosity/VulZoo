From bippy-851b3ed3d212 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-46960: cifs: Return correct error code from smb2_get_enc_key

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

cifs: Return correct error code from smb2_get_enc_key

Avoid a warning if the error percolates back up:

[440700.376476] CIFS VFS: \\otters.example.com crypt_message: Could not get encryption key
[440700.386947] ------------[ cut here ]------------
[440700.386948] err = 1
[440700.386977] WARNING: CPU: 11 PID: 2733 at /build/linux-hwe-5.4-p6lk6L/linux-hwe-5.4-5.4.0/lib/errseq.c:74 errseq_set+0x5c/0x70
...
[440700.397304] CPU: 11 PID: 2733 Comm: tar Tainted: G           OE     5.4.0-70-generic #78~18.04.1-Ubuntu
...
[440700.397334] Call Trace:
[440700.397346]  __filemap_set_wb_err+0x1a/0x70
[440700.397419]  cifs_writepages+0x9c7/0xb30 [cifs]
[440700.397426]  do_writepages+0x4b/0xe0
[440700.397444]  __filemap_fdatawrite_range+0xcb/0x100
[440700.397455]  filemap_write_and_wait+0x42/0xa0
[440700.397486]  cifs_setattr+0x68b/0xf30 [cifs]
[440700.397493]  notify_change+0x358/0x4a0
[440700.397500]  utimes_common+0xe9/0x1c0
[440700.397510]  do_utimes+0xc5/0x150
[440700.397520]  __x64_sys_utimensat+0x88/0xd0

The Linux kernel CVE team has assigned CVE-2021-46960 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.11 with commit 61cfac6f267d and fixed in 4.14.233 with commit e94851629c49
	Issue introduced in 4.11 with commit 61cfac6f267d and fixed in 4.19.191 with commit e486f8397f3f
	Issue introduced in 4.11 with commit 61cfac6f267d and fixed in 5.4.118 with commit 93f3339b22ba
	Issue introduced in 4.11 with commit 61cfac6f267d and fixed in 5.10.36 with commit aaa0faa5c28a
	Issue introduced in 4.11 with commit 61cfac6f267d and fixed in 5.11.20 with commit f59a9242942f
	Issue introduced in 4.11 with commit 61cfac6f267d and fixed in 5.12.3 with commit b399c1a3ea0b
	Issue introduced in 4.11 with commit 61cfac6f267d and fixed in 5.13 with commit 83728cbf366e

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-46960
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/cifs/smb2ops.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e94851629c49c65b4fbb29a5725ddfd7988f8f20
	https://git.kernel.org/stable/c/e486f8397f3f14a7cadc166138141fdb14379a54
	https://git.kernel.org/stable/c/93f3339b22ba17e66f0808737467b70ba087eaec
	https://git.kernel.org/stable/c/aaa0faa5c28a91c362352d6b35dc3ed10df56fb0
	https://git.kernel.org/stable/c/f59a9242942fef0de7b926e438ba4eae65d4b4dd
	https://git.kernel.org/stable/c/b399c1a3ea0b9d10047ff266d65533df7f15532f
	https://git.kernel.org/stable/c/83728cbf366e334301091d5b808add468ab46b27
