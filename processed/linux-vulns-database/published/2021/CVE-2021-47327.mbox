From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-47327: iommu/arm-smmu: Fix arm_smmu_device refcount leak when arm_smmu_rpm_get fails

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

iommu/arm-smmu: Fix arm_smmu_device refcount leak when arm_smmu_rpm_get fails

arm_smmu_rpm_get() invokes pm_runtime_get_sync(), which increases the
refcount of the "smmu" even though the return value is less than 0.

The reference counting issue happens in some error handling paths of
arm_smmu_rpm_get() in its caller functions. When arm_smmu_rpm_get()
fails, the caller functions forget to decrease the refcount of "smmu"
increased by arm_smmu_rpm_get(), causing a refcount leak.

Fix this issue by calling pm_runtime_resume_and_get() instead of
pm_runtime_get_sync() in arm_smmu_rpm_get(), which can keep the refcount
balanced in case of failure.

The Linux kernel CVE team has assigned CVE-2021-47327 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.4.134 with commit 3761ae0d0e549f2acdaf11f49df4ed06d256b20f
	Fixed in 5.10.52 with commit c4007596fbdabc29f858dc2e1990858a146b60b2
	Fixed in 5.12.19 with commit fbf4daa6f4105e01fbd3868006f65c163365c1e3
	Fixed in 5.13.4 with commit fe92c058199067ae90cf2a901ddf3c271893557a
	Fixed in 5.14 with commit 1adf30f198c26539a62d761e45af72cde570413d

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-47327
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/iommu/arm/arm-smmu/arm-smmu.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/3761ae0d0e549f2acdaf11f49df4ed06d256b20f
	https://git.kernel.org/stable/c/c4007596fbdabc29f858dc2e1990858a146b60b2
	https://git.kernel.org/stable/c/fbf4daa6f4105e01fbd3868006f65c163365c1e3
	https://git.kernel.org/stable/c/fe92c058199067ae90cf2a901ddf3c271893557a
	https://git.kernel.org/stable/c/1adf30f198c26539a62d761e45af72cde570413d
