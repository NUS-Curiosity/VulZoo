From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-47603: audit: improve robustness of the audit queue handling

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

audit: improve robustness of the audit queue handling

If the audit daemon were ever to get stuck in a stopped state the
kernel's kauditd_thread() could get blocked attempting to send audit
records to the userspace audit daemon.  With the kernel thread
blocked it is possible that the audit queue could grow unbounded as
certain audit record generating events must be exempt from the queue
limits else the system enter a deadlock state.

This patch resolves this problem by lowering the kernel thread's
socket sending timeout from MAX_SCHEDULE_TIMEOUT to HZ/10 and tweaks
the kauditd_send_queue() function to better manage the various audit
queues when connection problems occur between the kernel and the
audit daemon.  With this patch, the backlog may temporarily grow
beyond the defined limits when the audit daemon is stopped and the
system is under heavy audit pressure, but kauditd_thread() will
continue to make progress and drain the queues as it would for other
connection problems.  For example, with the audit daemon put into a
stopped state and the system configured to audit every syscall it
was still possible to shutdown the system without a kernel panic,
deadlock, etc.; granted, the system was slow to shutdown but that is
to be expected given the extreme pressure of recording every syscall.

The timeout value of HZ/10 was chosen primarily through
experimentation and this developer's "gut feeling".  There is likely
no one perfect value, but as this scenario is limited in scope (root
privileges would be needed to send SIGSTOP to the audit daemon), it
is likely not worth exposing this as a tunable at present.  This can
always be done at a later date if it proves necessary.

The Linux kernel CVE team has assigned CVE-2021-47603 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.11 with commit 5b52330bbfe63b3305765354d6046c9f7f89c011 and fixed in 4.14.259 with commit 75fdb751f84727d614deea0571a1490c3225d83a
	Issue introduced in 4.11 with commit 5b52330bbfe63b3305765354d6046c9f7f89c011 and fixed in 4.19.222 with commit 8389f50ceb854cb437fefb9330d5024ed3c7c1f5
	Issue introduced in 4.11 with commit 5b52330bbfe63b3305765354d6046c9f7f89c011 and fixed in 5.4.168 with commit 0d3277eabd542fb662be23696e5ec9f390d688e1
	Issue introduced in 4.11 with commit 5b52330bbfe63b3305765354d6046c9f7f89c011 and fixed in 5.10.88 with commit 4cc6badff97f74d0fce65f9784b5df3b64e4250b
	Issue introduced in 4.11 with commit 5b52330bbfe63b3305765354d6046c9f7f89c011 and fixed in 5.15.11 with commit a5f4d17daf2e6cd7c1d9676b476147f6b4ac53f2
	Issue introduced in 4.11 with commit 5b52330bbfe63b3305765354d6046c9f7f89c011 and fixed in 5.16 with commit f4b3ee3c85551d2d343a3ba159304066523f730f
	Issue introduced in 4.10.7 with commit a0c48115cd2343231585f2f5e609b2ac9aa4e0af

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-47603
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	kernel/audit.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/75fdb751f84727d614deea0571a1490c3225d83a
	https://git.kernel.org/stable/c/8389f50ceb854cb437fefb9330d5024ed3c7c1f5
	https://git.kernel.org/stable/c/0d3277eabd542fb662be23696e5ec9f390d688e1
	https://git.kernel.org/stable/c/4cc6badff97f74d0fce65f9784b5df3b64e4250b
	https://git.kernel.org/stable/c/a5f4d17daf2e6cd7c1d9676b476147f6b4ac53f2
	https://git.kernel.org/stable/c/f4b3ee3c85551d2d343a3ba159304066523f730f
