From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-47564: net: marvell: prestera: fix double free issue on err path

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net: marvell: prestera: fix double free issue on err path

fix error path handling in prestera_bridge_port_join() that
cases prestera driver to crash (see below).

 Trace:
   Internal error: Oops: 96000044 [#1] SMP
   Modules linked in: prestera_pci prestera uio_pdrv_genirq
   CPU: 1 PID: 881 Comm: ip Not tainted 5.15.0 #1
   pstate: 60000005 (nZCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
   pc : prestera_bridge_destroy+0x2c/0xb0 [prestera]
   lr : prestera_bridge_port_join+0x2cc/0x350 [prestera]
   sp : ffff800011a1b0f0
   ...
   x2 : ffff000109ca6c80 x1 : dead000000000100 x0 : dead000000000122
    Call trace:
   prestera_bridge_destroy+0x2c/0xb0 [prestera]
   prestera_bridge_port_join+0x2cc/0x350 [prestera]
   prestera_netdev_port_event.constprop.0+0x3c4/0x450 [prestera]
   prestera_netdev_event_handler+0xf4/0x110 [prestera]
   raw_notifier_call_chain+0x54/0x80
   call_netdevice_notifiers_info+0x54/0xa0
   __netdev_upper_dev_link+0x19c/0x380

The Linux kernel CVE team has assigned CVE-2021-47564 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.10 with commit e1189d9a5fbec8153dbe03f3589bc2baa96694e2 and fixed in 5.10.83 with commit 5dca8eff4627315df98feec09fff9dfe3356325e
	Issue introduced in 5.10 with commit e1189d9a5fbec8153dbe03f3589bc2baa96694e2 and fixed in 5.15.6 with commit 03e5203d2161a00afe4d97d206d2293e40b2f253
	Issue introduced in 5.10 with commit e1189d9a5fbec8153dbe03f3589bc2baa96694e2 and fixed in 5.16 with commit e8d032507cb7912baf1d3e0af54516f823befefd

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-47564
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/ethernet/marvell/prestera/prestera_switchdev.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/5dca8eff4627315df98feec09fff9dfe3356325e
	https://git.kernel.org/stable/c/03e5203d2161a00afe4d97d206d2293e40b2f253
	https://git.kernel.org/stable/c/e8d032507cb7912baf1d3e0af54516f823befefd
