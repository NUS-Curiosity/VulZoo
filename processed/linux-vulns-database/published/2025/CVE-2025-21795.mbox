From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-21795: NFSD: fix hang in nfsd4_shutdown_callback

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

NFSD: fix hang in nfsd4_shutdown_callback

If nfs4_client is in courtesy state then there is no point to send
the callback. This causes nfsd4_shutdown_callback to hang since
cl_cb_inflight is not 0. This hang lasts about 15 minutes until TCP
notifies NFSD that the connection was dropped.

This patch modifies nfsd4_run_cb_work to skip the RPC call if
nfs4_client is in courtesy state.

The Linux kernel CVE team has assigned CVE-2025-21795 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.10.220 with commit 67ef9e5fd737eab2495f2586df7e9ea30caa1b77 and fixed in 5.10.235 with commit abed68027ea3ab893ac85cc46a00e2e64a324239
	Issue introduced in 5.15.154 with commit 26540b8940a2e21582afa61a6fb8af87310bac72 and fixed in 5.15.179 with commit efa8a261c575f816c7e79a87aeb3ef8a0bd6b221
	Issue introduced in 5.19 with commit 66af25799940b26efd41ea6e648f75c41a48a2c2 and fixed in 6.1.129 with commit 38d345f612503b850c2973e5a879f88e441b34d7
	Issue introduced in 5.19 with commit 66af25799940b26efd41ea6e648f75c41a48a2c2 and fixed in 6.6.79 with commit 23ad7797c74cd8f7f90617f1e59a8703e2b43908
	Issue introduced in 5.19 with commit 66af25799940b26efd41ea6e648f75c41a48a2c2 and fixed in 6.12.16 with commit cedfbb92cf97a6bff3d25633001d9c44442ee854
	Issue introduced in 5.19 with commit 66af25799940b26efd41ea6e648f75c41a48a2c2 and fixed in 6.13.4 with commit e88d2451cd42e025465d6b51fd716a47b0b3800d
	Issue introduced in 5.19 with commit 66af25799940b26efd41ea6e648f75c41a48a2c2 and fixed in 6.14-rc3 with commit 036ac2778f7b28885814c6fbc07e156ad1624d03

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-21795
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/nfsd/nfs4callback.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/abed68027ea3ab893ac85cc46a00e2e64a324239
	https://git.kernel.org/stable/c/efa8a261c575f816c7e79a87aeb3ef8a0bd6b221
	https://git.kernel.org/stable/c/38d345f612503b850c2973e5a879f88e441b34d7
	https://git.kernel.org/stable/c/23ad7797c74cd8f7f90617f1e59a8703e2b43908
	https://git.kernel.org/stable/c/cedfbb92cf97a6bff3d25633001d9c44442ee854
	https://git.kernel.org/stable/c/e88d2451cd42e025465d6b51fd716a47b0b3800d
	https://git.kernel.org/stable/c/036ac2778f7b28885814c6fbc07e156ad1624d03
