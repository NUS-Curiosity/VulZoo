From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-21653: net_sched: cls_flow: validate TCA_FLOW_RSHIFT attribute

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net_sched: cls_flow: validate TCA_FLOW_RSHIFT attribute

syzbot found that TCA_FLOW_RSHIFT attribute was not validated.
Right shitfing a 32bit integer is undefined for large shift values.

UBSAN: shift-out-of-bounds in net/sched/cls_flow.c:329:23
shift exponent 9445 is too large for 32-bit type 'u32' (aka 'unsigned int')
CPU: 1 UID: 0 PID: 54 Comm: kworker/u8:3 Not tainted 6.13.0-rc3-syzkaller-00180-g4f619d518db9 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024
Workqueue: ipv6_addrconf addrconf_dad_work
Call Trace:
 <TASK>
  __dump_stack lib/dump_stack.c:94 [inline]
  dump_stack_lvl+0x241/0x360 lib/dump_stack.c:120
  ubsan_epilogue lib/ubsan.c:231 [inline]
  __ubsan_handle_shift_out_of_bounds+0x3c8/0x420 lib/ubsan.c:468
  flow_classify+0x24d5/0x25b0 net/sched/cls_flow.c:329
  tc_classify include/net/tc_wrapper.h:197 [inline]
  __tcf_classify net/sched/cls_api.c:1771 [inline]
  tcf_classify+0x420/0x1160 net/sched/cls_api.c:1867
  sfb_classify net/sched/sch_sfb.c:260 [inline]
  sfb_enqueue+0x3ad/0x18b0 net/sched/sch_sfb.c:318
  dev_qdisc_enqueue+0x4b/0x290 net/core/dev.c:3793
  __dev_xmit_skb net/core/dev.c:3889 [inline]
  __dev_queue_xmit+0xf0e/0x3f50 net/core/dev.c:4400
  dev_queue_xmit include/linux/netdevice.h:3168 [inline]
  neigh_hh_output include/net/neighbour.h:523 [inline]
  neigh_output include/net/neighbour.h:537 [inline]
  ip_finish_output2+0xd41/0x1390 net/ipv4/ip_output.c:236
  iptunnel_xmit+0x55d/0x9b0 net/ipv4/ip_tunnel_core.c:82
  udp_tunnel_xmit_skb+0x262/0x3b0 net/ipv4/udp_tunnel_core.c:173
  geneve_xmit_skb drivers/net/geneve.c:916 [inline]
  geneve_xmit+0x21dc/0x2d00 drivers/net/geneve.c:1039
  __netdev_start_xmit include/linux/netdevice.h:5002 [inline]
  netdev_start_xmit include/linux/netdevice.h:5011 [inline]
  xmit_one net/core/dev.c:3590 [inline]
  dev_hard_start_xmit+0x27a/0x7d0 net/core/dev.c:3606
  __dev_queue_xmit+0x1b73/0x3f50 net/core/dev.c:4434

The Linux kernel CVE team has assigned CVE-2025-21653 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.25 with commit e5dfb815181fcb186d6080ac3a091eadff2d98fe and fixed in 5.4.290 with commit 9858f4afeb2e59506e714176bd3e135539a3eeec
	Issue introduced in 2.6.25 with commit e5dfb815181fcb186d6080ac3a091eadff2d98fe and fixed in 5.10.234 with commit 43658e4a5f2770ad94e93362885ff51c10cf3179
	Issue introduced in 2.6.25 with commit e5dfb815181fcb186d6080ac3a091eadff2d98fe and fixed in 5.15.177 with commit a313d6e6d5f3a631cae5a241c392c28868aa5c5e
	Issue introduced in 2.6.25 with commit e5dfb815181fcb186d6080ac3a091eadff2d98fe and fixed in 6.1.125 with commit 2011749ca96460386844dfc7e0fde53ebee96f3c
	Issue introduced in 2.6.25 with commit e5dfb815181fcb186d6080ac3a091eadff2d98fe and fixed in 6.6.72 with commit e54beb9aed2a90dddf4c5d68fcfc9a01f3e40a61
	Issue introduced in 2.6.25 with commit e5dfb815181fcb186d6080ac3a091eadff2d98fe and fixed in 6.12.10 with commit 6fde663f7321418996645ee602a473457640542f
	Issue introduced in 2.6.25 with commit e5dfb815181fcb186d6080ac3a091eadff2d98fe and fixed in 6.13 with commit a039e54397c6a75b713b9ce7894a62e06956aa92

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-21653
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/sched/cls_flow.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/9858f4afeb2e59506e714176bd3e135539a3eeec
	https://git.kernel.org/stable/c/43658e4a5f2770ad94e93362885ff51c10cf3179
	https://git.kernel.org/stable/c/a313d6e6d5f3a631cae5a241c392c28868aa5c5e
	https://git.kernel.org/stable/c/2011749ca96460386844dfc7e0fde53ebee96f3c
	https://git.kernel.org/stable/c/e54beb9aed2a90dddf4c5d68fcfc9a01f3e40a61
	https://git.kernel.org/stable/c/6fde663f7321418996645ee602a473457640542f
	https://git.kernel.org/stable/c/a039e54397c6a75b713b9ce7894a62e06956aa92
