From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-21654: ovl: support encoding fid from inode with no alias

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ovl: support encoding fid from inode with no alias

Dmitry Safonov reported that a WARN_ON() assertion can be trigered by
userspace when calling inotify_show_fdinfo() for an overlayfs watched
inode, whose dentry aliases were discarded with drop_caches.

The WARN_ON() assertion in inotify_show_fdinfo() was removed, because
it is possible for encoding file handle to fail for other reason, but
the impact of failing to encode an overlayfs file handle goes beyond
this assertion.

As shown in the LTP test case mentioned in the link below, failure to
encode an overlayfs file handle from a non-aliased inode also leads to
failure to report an fid with FAN_DELETE_SELF fanotify events.

As Dmitry notes in his analyzis of the problem, ovl_encode_fh() fails
if it cannot find an alias for the inode, but this failure can be fixed.
ovl_encode_fh() seldom uses the alias and in the case of non-decodable
file handles, as is often the case with fanotify fid info,
ovl_encode_fh() never needs to use the alias to encode a file handle.

Defer finding an alias until it is actually needed so ovl_encode_fh()
will not fail in the common case of FAN_DELETE_SELF fanotify events.

The Linux kernel CVE team has assigned CVE-2025-21654 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.6 with commit 16aac5ad1fa94894b798dd522c5c3a6a0628d7f0 and fixed in 6.6.74 with commit f0c0ac84de17c37e6e84da65fb920f91dada55ad
	Issue introduced in 6.6 with commit 16aac5ad1fa94894b798dd522c5c3a6a0628d7f0 and fixed in 6.12.10 with commit 3c7c90274ae339e1ad443c9be1c67a20b80b9c76
	Issue introduced in 6.6 with commit 16aac5ad1fa94894b798dd522c5c3a6a0628d7f0 and fixed in 6.13 with commit c45beebfde34aa71afbc48b2c54cdda623515037

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-21654
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/overlayfs/export.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/f0c0ac84de17c37e6e84da65fb920f91dada55ad
	https://git.kernel.org/stable/c/3c7c90274ae339e1ad443c9be1c67a20b80b9c76
	https://git.kernel.org/stable/c/c45beebfde34aa71afbc48b2c54cdda623515037
