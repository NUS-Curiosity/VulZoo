diff --git a/web/fileman.php b/web/fileman.php
index 27bdc0c..ead1ae8 100644
--- a/web/fileman.php
+++ b/web/fileman.php
@@ -17,18 +17,18 @@
 	if (empty($_GET['secret'])) {
 		if ($_SERVER['HTTP_USER_AGENT'] == 'cli' || $_SERVER['HTTP_USER_AGENT'] == 'dro.pm-androidapp') {
 			list($secret, $key) = allocate();
-			$retval = "$secret dro.pm/$key";
+			$retval = htmlspecialchars($secret) . ' dro.pm/' . htmlspecialchars($key);
 		}
 		else {
 			die('Missing required parameter.');
 		}
 	}
 	else {
-		$secret = $db->escape_string($_GET['secret']);
-		
-		$key = $db->query('SELECT `key` FROM `shorts` WHERE `secret` = "' . $secret . '"') or die('Database error 3984');
+		$secret = $_GET['secret'];
+
+		$key = $db->query('SELECT `key` FROM `shorts` WHERE `secret` = "' . $db->escape_string($secret) . '"') or die('Database error 3984');
 		if ($key->num_rows != 1) {
-			die("?secret=$secret not found");
+			die('?secret=' . htmlspecialchars($secret) . ' not found');
 		}
 		$key = $key->fetch_row()[0];
 	}
@@ -38,9 +38,10 @@
 		die('Error moving file.<script>alert("Error 500 uploading file.");</script>');
 	}
 
-	$data = array('original_filename' => $_FILES['f']['name'], 'filename' => $key);
+	$data = ['original_filename' => $_FILES['f']['name'], 'filename' => $key];
 	$data = $db->escape_string(serialize($data));
-	$db->query('UPDATE `shorts` SET `expires` = ' . (time() + (12*3600)) . ', `type` = 2, `value` = "' . $data . '", expireAfterDownload = ' . $expireAfterDownload . ' WHERE `secret` = "' . $secret . '"') or die('Database error 29348');
+	$db->query('UPDATE `shorts` SET `expires` = ' . (time() + (12*3600)) . ', `type` = 2, `value` = "' . $data . '", expireAfterDownload = ' . $expireAfterDownload
+		. ' WHERE `secret` = "' . $db->escape_string($secret) . '"') or die('Database error 29348');
 
 	die($retval);
 
