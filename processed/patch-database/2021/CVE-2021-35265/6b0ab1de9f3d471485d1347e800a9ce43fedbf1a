diff --git a/application/maxsite/common/core/format.php b/application/maxsite/common/core/format.php
index 3b9a6e52..94803607 100644
--- a/application/maxsite/common/core/format.php
+++ b/application/maxsite/common/core/format.php
@@ -80,7 +80,8 @@ function mso_menu_build($menu = '', $select_css = 'selected', $add_link_admin =
 	}
 
 	// определим текущий url
-	$current_url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
+	$current_url = mso_current_url(true);
+	// $current_url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
 
 	$out = '';
 
diff --git a/application/maxsite/common/core/url.php b/application/maxsite/common/core/url.php
index 8a40ecf7..4ccbe5a4 100644
--- a/application/maxsite/common/core/url.php
+++ b/application/maxsite/common/core/url.php
@@ -44,7 +44,7 @@ function mso_segment_array()
 	if (isset($_SERVER['REQUEST_URI']) and $_SERVER['REQUEST_URI']) {
 		// http://localhost/page/privet?get=hello
 		$url = getinfo('site_protocol');
-		$url .= $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
+		$url .= $_SERVER['HTTP_HOST'] . mso_clean_str($_SERVER['REQUEST_URI']);
 		$url = str_replace($CI->config->config['base_url'], '', $url); // page/privet?get=hello
 
 		if (strpos($url, '?') !== FALSE) {
@@ -78,7 +78,7 @@ function mso_url_get()
 {
 	$CI = &get_instance();
 	if (isset($_SERVER['REQUEST_URI']) and $_SERVER['REQUEST_URI'] and (strpos($_SERVER['REQUEST_URI'], '?') !== FALSE)) {
-		$url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
+		$url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . mso_clean_str($_SERVER['REQUEST_URI']);
 		$url = str_replace($CI->config->config['base_url'], "", $url);
 		$url = explode('?', $url);
 
@@ -221,7 +221,9 @@ function mso_get_permalink_page($id = 0, $prefix = 'page/')
 // если $absolute = true, то возвращается текущий урл как есть
 function mso_current_url($absolute = false, $explode = false, $delete_request = false)
 {
-	$url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
+	$url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . mso_clean_str($_SERVER['REQUEST_URI']);
+	
+	//pr($url);
 
 	if ($delete_request) {
 		// отделим по «?»
diff --git a/application/maxsite/plugins/global_cache/index.php b/application/maxsite/plugins/global_cache/index.php
index 08fd1152..3770188e 100644
--- a/application/maxsite/plugins/global_cache/index.php
+++ b/application/maxsite/plugins/global_cache/index.php
@@ -65,7 +65,7 @@ function global_cache_uninstall($args = array())
 # если $dir = true, то добавляем каталог html
 function global_cache_key($dir = true)
 {
-	$cache_key = $_SERVER['REQUEST_URI'];
+	$cache_key =  mso_clean_str($_SERVER['REQUEST_URI']); //$_SERVER['REQUEST_URI'];
 	$cache_key = str_replace('/', '-', $cache_key);
 	$cache_key = mso_slug(' ' . $cache_key);
 	
diff --git a/application/maxsite/plugins/sape/index.php b/application/maxsite/plugins/sape/index.php
index b254b6a7..9dde1a28 100644
--- a/application/maxsite/plugins/sape/index.php
+++ b/application/maxsite/plugins/sape/index.php
@@ -78,7 +78,7 @@ function sape_init($args = array())
 			// таким образом обнаружить продажную ссылку будет невозможно
 			if (isset($_SERVER['argv']) and $_SERVER['argv']) // есть какие-то параметры - делаем редирект
 			{
-				$url = $_SERVER['REQUEST_URI']; // /?nono  /about/?momo
+				$url =  mso_clean_str($_SERVER['REQUEST_URI']); // $_SERVER['REQUEST_URI']; // /?nono  /about/?momo
 				
 				$url = explode('?', $url);
 				if (isset($url[0])) $url = $url[0];
