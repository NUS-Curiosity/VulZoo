diff --git a/.gitignore b/.gitignore
index 4aa1d556b..165971773 100644
--- a/.gitignore
+++ b/.gitignore
@@ -58,3 +58,4 @@ HOWTO-web2py-devel
 *.sublime-project
 *.sublime-workspace
 .idea/*
+site-packages/
diff --git a/gluon/tools.py b/gluon/tools.py
index 746c9ddb0..f2b044614 100644
--- a/gluon/tools.py
+++ b/gluon/tools.py
@@ -1541,6 +1541,12 @@ def get_vars_next(self):
         next = current.request.vars._next
         if isinstance(next, (list, tuple)):
             next = next[0]
+        if next and self.settings.prevent_open_redirect_attacks:
+            # Prevent an attacker from adding an arbitrary url after the
+            # _next variable in the request.
+            items = next.split('/')
+            if '//' in next and items[2] != current.request.env.http_host:
+                next = None            
         return next
 
     def _get_user_id(self):
@@ -2513,10 +2519,6 @@ def login(self,
 
         ### use session for federated login
         snext = self.get_vars_next()
-        if snext and self.settings.prevent_open_redirect_attacks:
-            items = snext.split('/')
-            if '//' in snext and items[2] != request.env.http_host:
-                snext = None
 
         if snext:
             session._auth_next = snext
