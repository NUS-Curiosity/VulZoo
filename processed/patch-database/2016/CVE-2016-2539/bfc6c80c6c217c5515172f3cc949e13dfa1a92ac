diff --git a/mods/_core/modules/install_modules.php b/mods/_core/modules/install_modules.php
index 3ad709f56..69fcd5a79 100644
--- a/mods/_core/modules/install_modules.php
+++ b/mods/_core/modules/install_modules.php
@@ -18,6 +18,8 @@
 require(AT_INCLUDE_PATH.'../mods/_core/modules/classes/ModuleListParser.class.php');
 require_once(AT_INCLUDE_PATH.'../mods/_core/file_manager/filemanager.inc.php');
 // delete all folders and files in $dir
+
+
 function clear_dir($dir)
 {
 	if ($dh = opendir($dir)) 
@@ -154,8 +156,15 @@ function clear_dir($dir)
 
 			if (!$msg->containsErrors())
 			{
-				header('Location: module_install_step_1.php?mod='.urlencode($module_folder).SEP.'new=1');
-				exit;
+			        if($_POST['csrftoken'] != $_SESSION['token']){
+                        $msg->addError('ACCESS_DENIED');
+                    } else {
+                    
+                        header('Location: module_install_step_1.php?mod='.urlencode($module_folder).SEP.'new=1');                        
+                        exit;
+                    }
+				//header('Location: module_install_step_1.php?mod='.urlencode($module_folder).SEP.'new=1');
+				//exit;
 			}
 		}
 		
@@ -181,8 +190,13 @@ function clear_dir($dir)
 	$dir_name = str_replace(array('.','..'), '', $_POST['mod']);
 
 	if (isset($_POST['install_manually'])) {
-		header('Location: '.AT_BASE_HREF.'mods/_core/modules/module_install_step_2.php?mod='.urlencode($dir_name).SEP.'new=1'.SEP.'mod_in=1');
-		exit;
+	// Check for potential  CSRF
+        if($_POST['csrftoken'] != $_SESSION['token']){
+                $msg->addError('ACCESS_DENIED');
+        } else {
+            header('Location: '.AT_BASE_HREF.'mods/_core/modules/module_install_step_2.php?mod='.urlencode($dir_name).SEP.'new=1'.SEP.'mod_in=1');
+            exit;
+        }
 	}
 
 } else if (isset($_POST['install_manually'])) {
@@ -255,16 +269,18 @@ function validate_filename() {
 
     // Add $module_list_array as the last parameter, to sort by the common key
     // Sorts by original $module_list_array by reference, then returns true|false
-    $sort_by_version = array_multisort($version, SORT_DESC, $module_list_array);
+    //$sort_by_version = array_multisort($version, SORT_DESC, $module_list_array);
 
 // Create menu for filter ATutor versions
-function select_atversion(){ 
+function select_atversion($v=0){ 
     global $sort_versions;
     $menu = '<form action="'.$_SERVER['PHP_SELF'].'" method="post">'; 
     $menu.= '<select name="atversions">';
     $menu.= '<option value="0">'._AT("all").'</option>';
     foreach($sort_versions as $version){
-        if($version == VERSION){
+        if($version == $v){
+            $menu .= '<option value="'.$version.'" selected="selected">'.$version.'</option>';
+        }else if($version == VERSION){
             $menu .= '<option value="'.$version.'" selected="selected">'.$version.'</option>';
         }else{
             $menu .= '<option value="'.$version.'" >'.$version.'</option>';
diff --git a/themes/default/admin/modules/install_modules.tmpl.php b/themes/default/admin/modules/install_modules.tmpl.php
index f181d7039..562e0f4f2 100644
--- a/themes/default/admin/modules/install_modules.tmpl.php
+++ b/themes/default/admin/modules/install_modules.tmpl.php
@@ -8,6 +8,7 @@
 
 		<div class="row">
 			<input type="hidden" name="MAX_FILE_SIZE" value="52428800" />
+			<input type="hidden" name="csrftoken"  value="<?php echo $_SESSION['token'];?>" />
 			<input type="file" name="modulefile"  size="50" />
 		</div>
 		
@@ -26,6 +27,7 @@
 {
 ?>
 <form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post" name="installform">
+<input type="hidden" name="csrftoken"  value="<?php echo $_SESSION['token'];?>" />
 <table class="data" summary="">
 <thead>
 <tr>
@@ -82,10 +84,23 @@
     <div class="row">
     <?php echo _AT('old_module_notes'); ?>
     </div>
-<?php echo select_atversion(); ?>
+<?php 
+
+if(isset($_POST['atversions'])){
+    $v = htmlspecialchars($_POST['atversions']);
+    $_SESSION['atversion'] = $_POST['atversions'];
+} elseif(isset($_SESSION['atversion'] )){
+    $v = substr($_SESSION['atversion'], 0, 3);
+} else {
+    $v = substr(VERSION, 0, 3);
+}
+echo select_atversion($v); 
+
+?>
 </div>
 </fieldset>
 <form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post" name="form">
+<input type="hidden" name="csrftoken"  value="<?php echo $_SESSION['token'];?>" />
 <table class="data" summary="">
 <thead>
 	<tr>
