diff --git a/contrib/icd10/2022-Code Descriptions.zip b/contrib/icd10/2022-Code Descriptions.zip
deleted file mode 100644
index f900f8c618a..00000000000
Binary files a/contrib/icd10/2022-Code Descriptions.zip and /dev/null differ
diff --git a/contrib/icd10/2023 Code Descriptions in Tabular Order.zip b/contrib/icd10/2023 Code Descriptions in Tabular Order.zip
new file mode 100644
index 00000000000..792a6a9876f
Binary files /dev/null and b/contrib/icd10/2023 Code Descriptions in Tabular Order.zip differ
diff --git a/contrib/icd10/Zip File 3 2022 ICD-10-PCS Codes File.zip b/contrib/icd10/Zip File 3 2022 ICD-10-PCS Codes File.zip
deleted file mode 100644
index e29da6803e4..00000000000
Binary files a/contrib/icd10/Zip File 3 2022 ICD-10-PCS Codes File.zip and /dev/null differ
diff --git a/contrib/icd10/Zip File 3 2023 ICD-10-PCS Codes File.zip b/contrib/icd10/Zip File 3 2023 ICD-10-PCS Codes File.zip
new file mode 100644
index 00000000000..02773b119d6
Binary files /dev/null and b/contrib/icd10/Zip File 3 2023 ICD-10-PCS Codes File.zip differ
diff --git a/interface/billing/edit_payment.php b/interface/billing/edit_payment.php
index 9dac48c8c41..cc3ab49ae07 100644
--- a/interface/billing/edit_payment.php
+++ b/interface/billing/edit_payment.php
@@ -141,7 +141,7 @@
                     "'";
 
                 $where = "$where1 AND pay_amount > 0";
-                if (isset($_POST["Payment$CountRow"]) && $_POST["Payment$CountRow"] * 1 > 0) {
+                if (!empty($_POST["Payment$CountRow"])) {
                     if (trim($_POST['type_name']) == 'insurance') {
                         if (trim($_POST["HiddenIns$CountRow"]) == 1) {
                             $AccountCode = "IPP";
@@ -227,7 +227,7 @@
                 //==============================================================================================================================
 
                 $where = "$where1 AND (memo LIKE 'Deductable%' OR memo LIKE 'Deductible%')";
-                if (isset($_POST["Deductible$CountRow"]) && $_POST["Deductible$CountRow"] * 1 > 0) {
+                if (!empty($_POST["Deductible$CountRow"])) {
                     $resPayment = sqlStatement("SELECT  * from ar_activity $where");
                     if (sqlNumRows($resPayment) > 0) {
                         sqlStatement("update ar_activity set deleted = NOW() $where");
@@ -259,7 +259,7 @@
                 //==============================================================================================================================
 
                 $where = "$where1 AND pay_amount < 0";
-                if (isset($_POST["Takeback$CountRow"]) && $_POST["Takeback$CountRow"] * 1 > 0) {
+                if (!empty($_POST["Takeback$CountRow"])) {
                     $resPayment = sqlStatement("SELECT  * from ar_activity $where");
                     if (sqlNumRows($resPayment) > 0) {
                         sqlStatement("update ar_activity set deleted = NOW() $where");
@@ -337,7 +337,10 @@
         }
 
         if ($_REQUEST['global_amount'] == 'yes') {
-            sqlStatement("update ar_session set global_amount=? where session_id =?", [(isset($_POST["HidUnappliedAmount"]) ? trim($_POST["HidUnappliedAmount"]) * 1 : ''), $payment_id]);
+            sqlStatement(
+                "update ar_session set global_amount=? where session_id =?",
+                [(isset($_POST["HidUnappliedAmount"]) ? floatval($_POST["HidUnappliedAmount"]) : 0), $payment_id]
+            );
         } elseif ($_REQUEST['global_reset'] == '-0.00') {
             sqlStatement("update ar_session set global_amount=? where session_id =?", [0, $payment_id]);
         }
@@ -354,7 +357,7 @@
 //==============================================================================
 //Search Code
 //===============================================================================
-$payment_id = ($payment_id ?? null) * 1 > 0 ? $payment_id : $_REQUEST['payment_id'];
+$payment_id = !empty($payment_id) ? (int) $payment_id : (int) $_REQUEST['payment_id'];
 $ResultSearchSub = sqlStatement(
     "SELECT DISTINCT encounter, code_type, code, modifier, pid " .
     "FROM ar_activity WHERE deleted IS NULL AND session_id = ? " .
@@ -625,7 +628,7 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis
         }
         ?>
         <?php
-        if ($payment_id * 1 == 0) {
+        if (empty($payment_id)) {
             $onclick = "top.restoreSession();return SavePayment();";
         } else {
             $onclick = "return false;";
@@ -633,14 +636,14 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis
         ?>
         <form class="form" name='new_payment' method='post' action="edit_payment.php" onsubmit='<?php echo $onclick; ?>'>
             <?php
-            if ($payment_id * 1 > 0) { ?>
+            if (!empty($payment_id)) { ?>
             <fieldset>
                 <?php
                 require_once("payment_master.inc.php");  //Check/cash details are entered here.
                 ?>
                 <?php }//End of if($payment_id*1>0) ?>
                 <?php
-                if ($payment_id * 1 > 0) {//Distribution rows already in the database are displayed.
+                if (!empty($payment_id)) {//Distribution rows already in the database are displayed.
                     ?>
                     <?php //
                     $resCount = sqlStatement(
@@ -884,8 +887,7 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis
                                         [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]
                                     );
                                     $rowPayment = sqlFetchArray($resPayment);
-                                    $PaymentDB = $rowPayment['pay_amount'] ?? null * 1;
-                                    $PaymentDB = $PaymentDB == 0 ? '' : $PaymentDB;
+                                    $PaymentDB = floatval($rowPayment['pay_amount'] ?? null);
 
                                     $resPayment = sqlStatement(
                                         "SELECT pay_amount FROM ar_activity WHERE " .
@@ -894,8 +896,7 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis
                                         [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]
                                     );
                                     $rowPayment = sqlFetchArray($resPayment);
-                                    $TakebackDB = ($rowPayment['pay_amount'] ?? null) * -1;
-                                    $TakebackDB = $TakebackDB == 0 ? '' : $TakebackDB;
+                                    $TakebackDB = floatval($rowPayment['pay_amount'] ?? null);
 
                                     $resPayment = sqlStatement(
                                         "SELECT adj_amount FROM ar_activity WHERE " .
@@ -904,8 +905,7 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis
                                         [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]
                                     );
                                     $rowPayment = sqlFetchArray($resPayment);
-                                    $AdjAmountDB = $rowPayment['adj_amount'] * 1;
-                                    $AdjAmountDB = $AdjAmountDB == 0 ? '' : $AdjAmountDB;
+                                    $AdjAmountDB = floatval($rowPayment['adj_amount'] ?? null);
 
                                     $resPayment = sqlStatement(
                                         "SELECT memo FROM ar_activity WHERE " .
@@ -943,7 +943,6 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis
                                     } else {
                                         $AllowedDB = 0;
                                     }
-                                    $AllowedDB = $AllowedDB === 0 ? '' : $AllowedDB;
 
                                     if ($Ins == 1) {
                                         $bgcolor = '#ddddff';
@@ -1072,8 +1071,8 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis
                     <input type='hidden' name='global_amount' id='global_amount' value='' />
                     <input type='hidden' name='DeletePaymentDistributionId' id='DeletePaymentDistributionId' value='' />
                     <input type="hidden" name="ActionStatus" id="ActionStatus" value="<?php echo attr($Message ?? ''); ?>" />
-                    <input type='hidden' name='CountIndexAbove' id='CountIndexAbove' value='<?php echo attr($CountIndexAbove * 1); ?>' />
-                    <input type='hidden' name='CountIndexBelow' id='CountIndexBelow' value='<?php echo attr($CountIndexBelow * 1); ?>' />
+                    <input type='hidden' name='CountIndexAbove' id='CountIndexAbove' value='<?php echo (int) attr($CountIndexAbove); ?>' />
+                    <input type='hidden' name='CountIndexBelow' id='CountIndexBelow' value='<?php echo (int) attr($CountIndexBelow); ?>' />
                     <input type="hidden" name="ParentPage" id="ParentPage" value="<?php echo attr($_REQUEST['ParentPage'] ?? ''); ?>" />
                 </div>
         </form>
diff --git a/interface/billing/payment_pat_sel.inc.php b/interface/billing/payment_pat_sel.inc.php
index b11224e5870..fb60d01eb06 100644
--- a/interface/billing/payment_pat_sel.inc.php
+++ b/interface/billing/payment_pat_sel.inc.php
@@ -25,7 +25,7 @@
 //===============================================================================
 if (isset($_POST["mode"])) {
     if (
-           ($_POST["mode"] == "search") || ($_POST["default_search_patient"] == "default_search_patient") &&
+           ($_POST["mode"] == "search") || (($_POST["default_search_patient"] ?? null) == "default_search_patient") &&
            isset($_REQUEST['hidden_patient_code']) &&
            (int)$_REQUEST['hidden_patient_code'] > 0
     ) {
@@ -46,9 +46,9 @@
         $res = sqlStatement("SELECT fname,lname,mname FROM patient_data
                          where pid =?", array($hidden_patient_code));
         $row = sqlFetchArray($res);
-        $fname = $row['fname'];
-        $lname = $row['lname'];
-        $mname = $row['mname'];
+        $fname = $row['fname'] ?? '';
+        $lname = $row['lname'] ?? '';
+        $mname = $row['mname'] ?? '';
         $NameNew = $lname . ' ' . $fname . ' ' . $mname;
     }
 }
diff --git a/interface/billing/search_payments.php b/interface/billing/search_payments.php
index 36d4bca145e..ec038ba4155 100644
--- a/interface/billing/search_payments.php
+++ b/interface/billing/search_payments.php
@@ -533,7 +533,7 @@ function SearchPayingEntityAction() {
                                             </td>
                                             <td>
                                                 <!--<a class='iframe medium_modal' href="edit_payment.php?payment_id=<?php echo htmlspecialchars($RowSearch['session_id']); ?>"><?php echo $Payer == '' ? '&nbsp;' : htmlspecialchars($Payer); ?></a>-->
-                                                <a class="medium_modal" data-target="#myModal1" data-toggle="modal" onclick="loadiframe('edit_payment.php?payment_id=<?php echo attr_url($RowSearch['session_id']); ?>"><?php echo $Payer == '' ? '&nbsp;' : text($Payer); ?></a><!--link to iframe-->
+                                                <a class="medium_modal" href='edit_payment.php?payment_id=<?php echo attr_url($RowSearch['session_id']); ?>')"><?php echo $Payer == '' ? '&nbsp;' : text($Payer); ?></a><!--link to iframe-->
                                             </td>
                                             <td>
                                                 <a class="medium_modal" href='edit_payment.php?payment_id=<?php echo attr_url($RowSearch['session_id']); ?>'><?php echo $RowSearch['payer_id'] * 1 > 0 ? text($RowSearch['payer_id']) : '&nbsp;'; ?></a>
@@ -608,10 +608,5 @@ function SearchPayingEntityAction() {
         </div>
     </div><!--end of container div-->
 <?php $oemr_ui->oeBelowContainerDiv(); ?>
-<script>
-function loadiframe(htmlHref) { //load iframe
-    document.getElementById('targetiframe1').src = htmlHref;
-}
-</script>
 </body>
 </html>
diff --git a/interface/billing/sl_eob_invoice.php b/interface/billing/sl_eob_invoice.php
index 0368c55d8d8..9e151cdd6f7 100644
--- a/interface/billing/sl_eob_invoice.php
+++ b/interface/billing/sl_eob_invoice.php
@@ -69,10 +69,10 @@ function setins(istr) {
             return true;
         }
 
-        function goEncounterSummary(pid) {
+        function goEncounterSummary(e, pid) {
             if(pid) {
                 if(typeof opener.toEncSummary  === 'function') {
-                    opener.toEncSummary(pid);
+                    opener.toEncSummary(e, pid);
                 }
             }
             doClose();
@@ -295,7 +295,7 @@ function updateFields(payField, adjField, balField, coPayField, isFirstProcCode)
     $payer_type = $matches[1];
 }
 
-if (!empty($_POST['form_save']) || !empty($_POST['form_cancel']) || !empty($_POST['isLastClosed'])) {
+if (!empty($_POST['form_save']) || !empty($_POST['form_cancel']) || !empty($_POST['isLastClosed']) || !empty($_POST['billing_note'])) {
     if (!empty($_POST['form_save'])) {
         if (!CsrfUtils::verifyCsrfToken($_POST["csrf_token_form"])) {
             CsrfUtils::csrfNotVerified();
@@ -426,7 +426,7 @@ function updateFields(payField, adjField, balField, coPayField, isFirstProcCode)
     if (!$debug && !$save_stay && !$_POST['isLastClosed']) {
         echo "doClose();\n";
     }
-    if (!$debug && ($save_stay || $_POST['isLastClosed'])) {
+    if (!$debug && ($save_stay || $_POST['isLastClosed'] || $_POST['billing_note'])) {
         if ($_POST['isLastClosed']) {
             // save last closed level
             $form_done = 0 + $_POST['form_done'];
@@ -438,6 +438,12 @@ function updateFields(payField, adjField, balField, coPayField, isFirstProcCode)
                 SLEOB::arSetupSecondary($patient_id, $encounter_id, $debug);
             }
         }
+
+        if ($_POST['billing_note']) {
+            // save last closed level
+            sqlStatement("UPDATE form_encounter SET billing_note = ? WHERE pid = ? AND encounter = ?", array($_POST['billing_note'], $patient_id, $encounter_id));
+        }
+
         // will reload page w/o reposting
         echo "location.replace(location)\n";
     }
@@ -513,7 +519,7 @@ function updateFields(payField, adjField, balField, coPayField, isFirstProcCode)
                 <div class="form-row">
                     <div class="form-group col-lg">
                         <label class="col-form-label" for="billing_note"><?php echo xlt('Billing Note'); ?>:</label>
-                        <textarea name="billing_note" id="billing_note" class="form-control" cols="5" rows="2" readonly><?php echo text(($pdrow['billing_note'] ?? '')) . "\n" . text(($bnrow['billing_note'] ?? '')); ?></textarea>
+                        <textarea name="billing_note" id="billing_note" class="form-control" cols="5" rows="2"><?php echo text(($pdrow['billing_note'] ?? '')) . "\n" . text(($bnrow['billing_note'] ?? '')); ?></textarea>
                     </div>
                 </div>
                 <div class="form-row">
@@ -767,7 +773,7 @@ class="form-control"
                     </div>
                     <?php if ($from_posting) { ?>
                         <button type='button' class="btn btn-secondary btn-view float-right" name='form_goto' id="btn-goto"
-                            onclick="goEncounterSummary(<?php echo attr_js($patient_id) ?>)"><?php echo xlt("Past Encounters"); ?></button>
+                            onclick="goEncounterSummary(event, <?php echo attr_js($patient_id) ?>)"><?php echo xlt("Past Encounters"); ?></button>
                     <?php } ?>
                 </div>
             </div>
diff --git a/interface/forms/LBF/printable.php b/interface/forms/LBF/printable.php
index 6f94c5f8f9c..e0d3670a654 100644
--- a/interface/forms/LBF/printable.php
+++ b/interface/forms/LBF/printable.php
@@ -108,15 +108,6 @@
         'keep_table_proportions' => true
     );
     $pdf = new mPDF($config_mpdf);
-    $pdf->SetHTMLHeader('
-		<div style="text-align: right; font-weight: bold;">
-			' . $patientname . ' DOB: ' . oeFormatShortDate($patientdob["DOB"]) . ' DOS: ' . oeFormatShortDate($dateofservice) . '
-		</div>');
-    $pdf->SetHTMLFooter('
-			<div style="float: right; width:33% text-align: left;">' . oeFormatDateTime(date("Y-m-d H:i:s")) . '</div>
-			<div style="float: right; width:33%; text-align: center; ">{PAGENO}/{nbpg}</div>
-			<div style="float: right; width:33%; text-align: right; ">' . $patientname . '</div>
-			');
     $pdf->SetDisplayMode('real');
     if ($_SESSION['language_direction'] == 'rtl') {
         $pdf->SetDirectionality('rtl');
@@ -280,13 +271,14 @@
 $logo = '';
 $ma_logo_path = "sites/" . $_SESSION['site_id'] . "/images/ma_logo.png";
 if (is_file("$webserver_root/$ma_logo_path")) {
-    // Would use max-height here but html2pdf does not support it.
-    // TODO - now use mPDF, so should test if still need this fix
-    $logo = "<img src='$web_root/$ma_logo_path' style='height:" . attr(round($FONTSIZE * 5.14)) . "pt' />";
-} else {
-    $logo = "<!-- '$ma_logo_path' does not exist. -->";
+    $logo = "$web_root/$ma_logo_path";
 }
+
 echo genFacilityTitle($formtitle, -1, $logo);
+
+if ($PDF_OUTPUT) {
+    echo genPatientHeaderFooter($pid, $DOS = $dateofservice);
+}
 ?>
 
 <?php if ($isblankform) { ?>
diff --git a/interface/forms/fee_sheet/new.php b/interface/forms/fee_sheet/new.php
index a7537b31aef..8a1f3de5bb5 100644
--- a/interface/forms/fee_sheet/new.php
+++ b/interface/forms/fee_sheet/new.php
@@ -512,7 +512,16 @@ function echoProductLines()
     if ($_POST['form_checksum'] != $current_checksum) {
         $alertmsg = xl('Someone else has just changed this visit. Please cancel this page and try again.');
         $comment = "CHECKSUM ERROR, expecting '{$_POST['form_checksum']}'";
-        EventAuditLogger::instance()->newEvent("checksum", $_SESSION['authUser'], $_SESSION['authProvider'], 1, $comment, $pid);
+        EventAuditLogger::instance()->newEvent(
+            "checksum",
+            $_SESSION['authUser'],
+            $_SESSION['authProvider'],
+            1,
+            $comment,
+            $pid,
+            'open-emr',
+            'fee sheet'
+        );
     }
 }
 
diff --git a/interface/forms/fee_sheet/review/fee_sheet_ajax.php b/interface/forms/fee_sheet/review/fee_sheet_ajax.php
index 577d220c1bc..e226feca696 100644
--- a/interface/forms/fee_sheet/review/fee_sheet_ajax.php
+++ b/interface/forms/fee_sheet/review/fee_sheet_ajax.php
@@ -14,6 +14,7 @@
 require_once("fee_sheet_queries.php");
 
 use OpenEMR\Common\Acl\AclMain;
+use OpenEMR\Common\Csrf\CsrfUtils;
 
 if (!AclMain::aclCheckCore('acct', 'bill')) {
     header("HTTP/1.0 403 Forbidden");
@@ -21,6 +22,10 @@
     return false;
 }
 
+if (!CsrfUtils::verifyCsrfToken($_REQUEST["csrf_token_form"])) {
+    CsrfUtils::csrfNotVerified();
+}
+
 if (isset($_REQUEST['pid'])) {
     $req_pid = $_REQUEST['pid'];
 }
@@ -62,7 +67,7 @@
     }
 
     $retval['issues'] = $issues;
-    echo json_encode($retval);
+    echo text(json_encode($retval));
     return;
 }
 
@@ -73,7 +78,7 @@
 
     $diags = array();
     foreach ($json_diags as $diag) {
-        $diags[] = new code_info($diag->{'code'}, $diag->{'code_type'}, $diag->{'description'});
+        $diags[] = new code_info($diag->code, $diag->code_type, $diag->description);
     }
 
     $procs = array();
@@ -82,7 +87,16 @@
     }
 
     foreach ($json_procs as $proc) {
-        $procs[] = new procedure($proc->{'code'}, $proc->{'code_type'}, $proc->{'description'}, $proc->{'fee'}, $proc->{'justify'}, $proc->{'modifiers'}, $proc->{'units'}, 0);
+        $procs[] = new procedure(
+            $proc->code,
+            $proc->code_type,
+            $proc->description,
+            $proc->fee,
+            $proc->justify,
+            $proc->modifiers,
+            $proc->units,
+            0
+        );
     }
 
     $database->StartTrans();
diff --git a/interface/forms/fee_sheet/review/fee_sheet_review_view_model.js b/interface/forms/fee_sheet/review/fee_sheet_review_view_model.js
index b04092e5f38..be542a06d38 100644
--- a/interface/forms/fee_sheet/review/fee_sheet_review_view_model.js
+++ b/interface/forms/fee_sheet/review/fee_sheet_review_view_model.js
@@ -111,7 +111,8 @@ function request_encounter_data(model_data, mode, prev_encounter) {
         pid: pid,
         encounter: enc,
         mode: mode,
-        task: "retrieve"
+        task: "retrieve",
+        csrf_token_form: csrf_token_js
     };
     if (prev_encounter != null) {
         request.prev_encounter = prev_encounter;
@@ -205,7 +206,8 @@ function add_review(data, event) {
             encounter: enc,
             task: 'add_diags',
             diags: JSON.stringify(diag_list),
-            procs: JSON.stringify(proc_list)
+            procs: JSON.stringify(proc_list),
+            csrf_token_form: csrf_token_js
         },
         function (data) {
             refresh_codes();
diff --git a/interface/forms/fee_sheet/review/initialize_review.php b/interface/forms/fee_sheet/review/initialize_review.php
index b1cfcabfd6c..7c4ffe3ca2f 100644
--- a/interface/forms/fee_sheet/review/initialize_review.php
+++ b/interface/forms/fee_sheet/review/initialize_review.php
@@ -12,6 +12,8 @@
  * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3
  */
 
+use OpenEMR\Common\Csrf\CsrfUtils;
+
 if (!$isBilled) {
     require_once("code_check.php");
     ?>
@@ -22,8 +24,11 @@
     var review_tag = <?php echo xlj('Review'); ?>;
     var justify_click_title = <?php echo xlj('Click to choose diagnoses to justify.'); ?>;
     var fee_sheet_options = [];
-    var diag_code_types = <?php echo diag_code_types('json');?>;  // This is a list of diagnosis code types to present for as options in the justify dialog, for now, only "internal codes" included.
+    // This is a list of diagnosis code types to present for as options in the justify dialog,
+    // for now, only "internal codes" included.
+    var diag_code_types = <?php echo diag_code_types('json');?>;
     var ippf_specific = <?php echo $GLOBALS['ippf_specific'] ? 'true' : 'false'; ?>;
+    var csrf_token_js = <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>;
 </script>
 <script>
     function fee_sheet_option(code,code_type,description,fee)
diff --git a/interface/forms/track_anything/create.php b/interface/forms/track_anything/create.php
index fcbdf0908ad..382d51840e7 100644
--- a/interface/forms/track_anything/create.php
+++ b/interface/forms/track_anything/create.php
@@ -132,11 +132,11 @@
 // user clicked some buttons...
 $the_item = isset($_POST['typeid']) ? trim($_POST['typeid']) : '';
 if ($the_item) {
-    $add        = $_POST['add'];
-    $edit       = $_POST['edit'];
-    $delete     = $_POST['delete'];
-    $deactivate = $_POST['deact'];
-    $activate   = $_POST['act'];
+    $add        = $_POST['add'] ?? null;
+    $edit       = $_POST['edit'] ?? null;
+    $delete     = $_POST['delete'] ?? null;
+    $deactivate = $_POST['deact'] ?? null;
+    $activate   = $_POST['act'] ?? null;
 
     // add a new item to track
     //------------------------
diff --git a/interface/forms/track_anything/history.php b/interface/forms/track_anything/history.php
index 241484d2430..6ee76036654 100644
--- a/interface/forms/track_anything/history.php
+++ b/interface/forms/track_anything/history.php
@@ -19,8 +19,8 @@
 use OpenEMR\Core\Header;
 
 $returnurl = 'encounter_top.php';
-if (!$formid) {
-    $formid = $_POST['formid']; // call from track_anything encounter
+if (empty($formid)) {
+    $formid = $_POST['formid'] ?? null; // call from track_anything encounter
     $fromencounter = 1;
     if (!$formid) {
         $formid = $_GET['formid']; // call from demographic-widget "track_anything_fragement.php"
@@ -28,13 +28,13 @@
     }
 }
 
-if ($_POST['fromencounter'] != '') {
+if (!empty($_POST['fromencounter'])) {
     $fromencounter = $_POST['fromencounter'];
 }
 
 // get $_POSTed vars
 //----------------------
-$ASC_DESC = $_POST['ASC_DESC'];
+$ASC_DESC = $_POST['ASC_DESC'] ?? null;
 
 if (!$ASC_DESC) {
     $ASC_DESC = "DESC"; # order DESC by default
@@ -71,6 +71,9 @@
 
 <?php Header::setupHeader('dygraphs'); ?>
 
+<title><?php echo xlt('Tracker')?></title>
+
+
 <link rel="stylesheet" href="style.css">
 
 <script>
@@ -305,8 +308,17 @@ function plot_graph(checkedBoxes, theitems, thetrack, thedates, thevalues, track
         echo "<td class='check'>";
         for ($row_b = 0; $row_b < $row_lc; $row_b++) {
             if (is_numeric($value_local[$col_i][$row_b])) {
-                $localplot_c[$col_i]++; // count more than 1 to show graph-button
-                $globalplot_c[$col_i]++;
+                if (empty($localplot_c[$col_i])) {
+                    $localplot_c[$col_i] = 1;
+                } else {
+                    $localplot_c[$col_i]++; // count more than 1 to show graph-button
+                }
+
+                if (empty($globalplot_c[$col_i])) {
+                    $globalplot_c[$col_i] = 1;
+                } else {
+                    $globalplot_c[$col_i]++;
+                }
             }
         }
 
diff --git a/interface/forms/track_anything/new.php b/interface/forms/track_anything/new.php
index e26c78bd9c7..de97fa131ab 100644
--- a/interface/forms/track_anything/new.php
+++ b/interface/forms/track_anything/new.php
@@ -26,14 +26,14 @@
 }
 
 // get vars posted by FORMs
-if (!$formid) {
-    $formid = $_GET['id'];
+if (empty($formid)) {
+    $formid = $_GET['id'] ?? null;
     if (!$formid) {
-        $formid = $_POST['formid'];
+        $formid = $_POST['formid'] ?? null;
     }
 }
 
-$myprocedureid =  $_POST['procedure2track'];
+$myprocedureid =  $_POST['procedure2track'] ?? null;
 
 echo "<html><head>";
 ?>
@@ -60,7 +60,7 @@
     // this is a new Track
 
     // check if procedure is selcted
-    if ($_POST['bn_select']) {
+    if ($_POST['bn_select'] ?? null) {
         // "save"-Button was clicked, saving Form into db
 
         // save inbto db
@@ -119,7 +119,7 @@
     // this is an existing Track
     //----------------------------------------------------
     // get submitted item-Ids
-    $mylist = $_POST['liste'];
+    $mylist = $_POST['liste'] ?? null;
     #echo $mylist;
     $length = count($mylist ?? []);
     $thedate = $_POST['datetime'] ?? null;
@@ -156,9 +156,9 @@
     // ---------------------------
 
     // getting old entries from <form>
-    $old_id     = $_POST['old_id'];
-    $old_time   = $_POST['old_time'];
-    $old_value  = $_POST['old_value'];
+    $old_id     = $_POST['old_id'] ?? null;
+    $old_time   = $_POST['old_time'] ?? null;
+    $old_value  = $_POST['old_value'] ?? null;
 
     $how_many = count($old_time ?? []);
     // do this for each data row
diff --git a/interface/forms/vitals/C_FormVitals.class.php b/interface/forms/vitals/C_FormVitals.class.php
index 7cca9e8da74..bccb46458a4 100644
--- a/interface/forms/vitals/C_FormVitals.class.php
+++ b/interface/forms/vitals/C_FormVitals.class.php
@@ -295,7 +295,7 @@ public function default_action()
             $vitalsHistoryLookback = array_slice($results, 0, $maxHistoryCols);
             $hasMoreVitals = true;
         } else {
-            $vitalsHistoryLookback = $results;
+            $vitalsHistoryLookback = $results ?? null;
         }
 
         $data = [
@@ -450,7 +450,7 @@ public function populate_object(&$obj)
 
                 if (empty($value)) {
                     $details->clear_interpretation();
-                } else if (isset($interpretationList[$value])) {
+                } elseif (isset($interpretationList[$value])) {
                     $interpretation = $interpretationList[$value];
 
                     // we save off both the code and the text value here which duplicates the data.  However, since
diff --git a/interface/forms/vitals/growthchart/chart.php b/interface/forms/vitals/growthchart/chart.php
index 009e30b1614..9db0aba0ca9 100644
--- a/interface/forms/vitals/growthchart/chart.php
+++ b/interface/forms/vitals/growthchart/chart.php
@@ -403,7 +403,7 @@ function convertpoint($coord)
 }
 
 
-if ($_GET['html'] == 1) {
+if ($_GET['html'] ?? null == 1) {
     //build the html css page if selected
     cssHeader();
     cssPage($chartCss1, $chartCss2);
@@ -419,6 +419,163 @@ function convertpoint($coord)
 
     // plot the data points
     foreach ($datapoints as $data) {
+        if (!empty($data)) {
+            list($date, $height, $weight, $head_circ) = explode('-', $data);
+            if ($date == "") {
+                continue;
+            }
+
+            // only plot if we have both weight and heights. Skip if either is 0.
+            // Rational is only well visit will need both, sick visit only needs weight
+            // for some clinic.
+            if ($weight == 0 || $height == 0) {
+                continue;
+            }
+
+            // get age of patient at this data-point
+            // to get data from function getPatientAgeYMD including $age,$age_in_months, $ageinYMD
+            extract(getPatientAgeYMD($dob, $date));
+            if ($charttype == 'birth') {
+                // for birth style chart, we use the age in months
+                $age = $age_in_months;
+            }
+
+            // exclude data points that do not belong on this chart
+            // for example, a data point for a 18 month old can be excluded
+            // from that patient's 2-20 yr chart
+            $daysold = getPatientAgeInDays($dob, $date);
+            if ($daysold >= (365 * 2) && $charttype == "birth") {
+                continue;
+            }
+
+            if ($daysold <= (365 * 2) && $charttype == "2-20") {
+                continue;
+            }
+
+            // calculate the x-axis (Age) value
+            $x = $dot_x + $delta_x * ($age - $ageOffset);
+
+            // Draw Height dot
+            $y1 = $dot_y1 - $delta_y1 * ((int) $height - $heightOffset);
+            $point = convertpoint(array($x,$y1));
+            echo("<div id='" . attr($point[2]) . "' class='graphic' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'><img src='reddot.gif' /></div>\n");
+
+            // Draw Weight bullseye
+            $y2 = $dot_y2 - $delta_y2 * ((int) $weight - $weightOffset);
+            $point = convertpoint(array($x,$y2));
+            echo("<div id='" . attr($point[2]) . "' class='graphic' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'><img src='redbox.gif' /></div>\n");
+
+            if ($charttype == "birth") {
+                // Draw Head circumference
+                $HC_x = $HC_dot_x + $HC_delta_x * $age;
+                $HC_y = $HC_dot_y - $HC_delta_y * ((int) $head_circ - 11);
+                $point = convertpoint(array($HC_x,$HC_y));
+                echo("<div id='" . attr($point[2]) . "' class='graphic' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'><img src='bluedot.gif' /></div>\n");
+                // Draw Wt and Ht graph at the bottom half
+                $WT = $WT_y - $WT_delta_y * ((int) $weight - $WToffset);
+                $HT = $HT_x + $HT_delta_x * ((int) $height - $HToffset);
+                $point = convertpoint(array($HT,$WT));
+                echo("<div id='" . attr($point[2]) . "' class='graphic' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'><img src='reddot.gif' /></div>\n");
+            } elseif ($charttype == "2-20") {
+                // Draw BMI
+                $bmi = $weight / $height / $height * 703;
+                $bmi_x = $bmi_dot_x + $bmi_delta_x * ($age - 2);
+                $bmi_y = $bmi_dot_y - $bmi_delta_y * ($bmi - 10);
+                $point = convertpoint(array($bmi_x,$bmi_y));
+                echo("<div id='" . attr($point[2]) . "' class='graphic' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'><img src='bluedot.gif' /></div>\n");
+            }
+
+            // fill in data tables
+
+            $datestr = substr($date, 0, 4) . "/" . substr($date, 4, 2) . "/" . substr($date, 6, 2);
+
+            //birth to 24 mos chart has 8 rows to fill.
+            if ($count < 8 && $charttype == "birth") {
+                $point = convertpoint(array($datatable_x,$datatable_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($datestr) . "</div>\n");
+                $point = convertpoint(array($datatable_x + $datatable_age_offset,$datatable_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($ageinYMD) . "</div>\n");
+                $point = convertpoint(array($datatable_x + $datatable_weight_offset,$datatable_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsWt($weight)) . "</div>\n");
+                $point = convertpoint(array($datatable_x + $datatable_height_offset,$datatable_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($height)) . "</div>\n");
+                $point = convertpoint(array($datatable_x + $datatable_hc_offset,$datatable_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($head_circ)) . "</div>\n");
+                $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable "row pointer"
+            }
+
+            // 2 to 20 year-old chart has 7 rows to fill.
+            if ($count < 7  && $charttype == "2-20") {
+                $point = convertpoint(array($datatable_x,$datatable_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($datestr) . "</div>\n");
+                $point = convertpoint(array($datatable_x + $datatable_age_offset,$datatable_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($ageinYMD) . "</div>\n");
+                $point = convertpoint(array($datatable_x + $datatable_weight_offset,$datatable_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsWt($weight)) . "</div>\n");
+                $point = convertpoint(array($datatable_x + $datatable_height_offset,$datatable_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($height)) . "</div>\n");
+                $point = convertpoint(array($datatable_x + $datatable_bmi_offset,$datatable_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(substr($bmi, 0, 5)) . "</div>\n");
+                $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable "row pointer"
+            }
+
+            // Head Circumference chart has 5 rows to fill in
+            if ($count < 5 && $charttype == "birth") {
+                $point = convertpoint(array($datatable2_x,$datatable2_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($datestr) . "</div>\n");
+                $point = convertpoint(array($datatable2_x + $datatable2_age_offset,$datatable2_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($ageinYMD) . "</div>\n");
+                $point = convertpoint(array($datatable2_x + $datatable2_weight_offset,$datatable2_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsWt($weight)) . "</div>\n");
+                $point = convertpoint(array($datatable2_x + $datatable2_height_offset,$datatable2_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($height)) . "</div>\n");
+                $point = convertpoint(array($datatable2_x + $datatable2_hc_offset,$datatable2_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($head_circ)) . "</div>\n");
+                $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 "row pointer"
+            }
+
+            // BMI chart has 14 rows to fill in.
+            if ($count < 14 && $charttype == "2-20") {
+                $point = convertpoint(array($datatable2_x,$datatable2_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($datestr) . "</div>\n");
+                $point = convertpoint(array($datatable2_x + $datatable2_age_offset,$datatable2_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($ageinYMD) . "</div>\n");
+                $point = convertpoint(array($datatable2_x + $datatable2_weight_offset,$datatable2_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsWt($weight)) . "</div>\n");
+                $point = convertpoint(array($datatable2_x + $datatable2_height_offset,$datatable2_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($height)) . "</div>\n");
+                $point = convertpoint(array($datatable2_x + $datatable2_bmi_offset,$datatable2_y));
+                echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(substr($bmi, 0, 5)) . "</div>\n");
+                $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 "row pointer"
+            }
+
+            $count++;
+        }
+    }
+
+    cssFooter();
+    exit;
+}
+
+// Done creating CSS HTML output
+/******************************/
+
+
+// create the graph
+$im     = imagecreatefrompng($chartpath . $chart);
+$color1 = imagecolorallocate($im, 0, 0, 255); //blue - color scheme imagecolorallocate($im, Red, Green, Blue)
+$color  = imagecolorallocate($im, 255, 51, 51); //red
+
+// draw the patient's name
+imagestring($im, 12, $name_x, $name_y, $name, $color);
+imagestring($im, 12, $name_x1, $name_y1, $name, $color);
+
+// counter to limit the number of data points plotted
+$count = 0;
+
+// plot the data points
+foreach ($datapoints as $data) {
+    if (!empty($data)) {
         list($date, $height, $weight, $head_circ) = explode('-', $data);
         if ($date == "") {
             continue;
@@ -432,7 +589,7 @@ function convertpoint($coord)
         }
 
         // get age of patient at this data-point
-        // to get data from function getPatientAgeYMD including $age,$age_in_months, $ageinYMD
+        // to get data from function getPatientAgeYMD including $age, $ageinYMD, $age_in_months
         extract(getPatientAgeYMD($dob, $date));
         if ($charttype == 'birth') {
             // for birth style chart, we use the age in months
@@ -443,11 +600,11 @@ function convertpoint($coord)
         // for example, a data point for a 18 month old can be excluded
         // from that patient's 2-20 yr chart
         $daysold = getPatientAgeInDays($dob, $date);
-        if ($daysold >= (365 * 2) && $charttype == "birth") {
+        if ($daysold > (365 * 2) && $charttype == "birth") {
             continue;
         }
 
-        if ($daysold <= (365 * 2) && $charttype == "2-20") {
+        if ($daysold < (365 * 2) && $charttype == "2-20") {
             continue;
         }
 
@@ -455,33 +612,29 @@ function convertpoint($coord)
         $x = $dot_x + $delta_x * ($age - $ageOffset);
 
         // Draw Height dot
-        $y1 = $dot_y1 - $delta_y1 * ($height - $heightOffset);
-        $point = convertpoint(array($x,$y1));
-        echo("<div id='" . attr($point[2]) . "' class='graphic' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'><img src='reddot.gif' /></div>\n");
+        $y1 = $dot_y1 - $delta_y1 * ((int) $height - $heightOffset);
+        imagefilledellipse($im, (int) $x, (int) $y1, 10, 10, $color);
 
         // Draw Weight bullseye
-        $y2 = $dot_y2 - $delta_y2 * ($weight - $weightOffset);
-        $point = convertpoint(array($x,$y2));
-        echo("<div id='" . attr($point[2]) . "' class='graphic' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'><img src='redbox.gif' /></div>\n");
+        $y2 = $dot_y2 - $delta_y2 * ((int) $weight - $weightOffset);
+        imageellipse($im, (int) $x, (int) $y2, 12, 12, $color); // outter ring
+        imagefilledellipse($im, (int) $x, (int) $y2, 5, 5, $color); //center dot
 
         if ($charttype == "birth") {
             // Draw Head circumference
             $HC_x = $HC_dot_x + $HC_delta_x * $age;
-            $HC_y = $HC_dot_y - $HC_delta_y * ($head_circ - 11);
-            $point = convertpoint(array($HC_x,$HC_y));
-            echo("<div id='" . attr($point[2]) . "' class='graphic' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'><img src='bluedot.gif' /></div>\n");
+            $HC_y = $HC_dot_y - $HC_delta_y * ((int) $head_circ - 11);
+            imagefilledellipse($im, $HC_x, $HC_y, 10, 10, $color1);
             // Draw Wt and Ht graph at the bottom half
-            $WT = $WT_y - $WT_delta_y * ($weight - $WToffset);
-            $HT = $HT_x + $HT_delta_x * ($height - $HToffset);
-            $point = convertpoint(array($HT,$WT));
-            echo("<div id='" . attr($point[2]) . "' class='graphic' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'><img src='reddot.gif' /></div>\n");
+            $WT = $WT_y - $WT_delta_y * ((int) $weight - $WToffset);
+            $HT = $HT_x + $HT_delta_x * ((int) $height - $HToffset);
+            imagefilledellipse($im, $HT, $WT, 10, 10, $color);
         } elseif ($charttype == "2-20") {
             // Draw BMI
             $bmi = $weight / $height / $height * 703;
             $bmi_x = $bmi_dot_x + $bmi_delta_x * ($age - 2);
             $bmi_y = $bmi_dot_y - $bmi_delta_y * ($bmi - 10);
-            $point = convertpoint(array($bmi_x,$bmi_y));
-            echo("<div id='" . attr($point[2]) . "' class='graphic' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'><img src='bluedot.gif' /></div>\n");
+            imagefilledellipse($im, (int) $bmi_x, (int) $bmi_y, 10, 10, $color1);
         }
 
         // fill in data tables
@@ -490,195 +643,46 @@ function convertpoint($coord)
 
         //birth to 24 mos chart has 8 rows to fill.
         if ($count < 8 && $charttype == "birth") {
-            $point = convertpoint(array($datatable_x,$datatable_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($datestr) . "</div>\n");
-            $point = convertpoint(array($datatable_x + $datatable_age_offset,$datatable_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($ageinYMD) . "</div>\n");
-            $point = convertpoint(array($datatable_x + $datatable_weight_offset,$datatable_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsWt($weight)) . "</div>\n");
-            $point = convertpoint(array($datatable_x + $datatable_height_offset,$datatable_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($height)) . "</div>\n");
-            $point = convertpoint(array($datatable_x + $datatable_hc_offset,$datatable_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($head_circ)) . "</div>\n");
+            imagestring($im, 2, $datatable_x, $datatable_y, $datestr, $color);
+            imagestring($im, 2, ($datatable_x + $datatable_age_offset), $datatable_y, $ageinYMD, $color);
+            imagestring($im, 2, ($datatable_x + $datatable_weight_offset), $datatable_y, unitsWt($weight), $color);
+            imagestring($im, 2, ($datatable_x + $datatable_height_offset), $datatable_y, unitsDist($height), $color);
+            imagestring($im, 2, ($datatable_x + $datatable_hc_offset), $datatable_y, unitsDist($head_circ), $color);
             $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable "row pointer"
         }
 
         // 2 to 20 year-old chart has 7 rows to fill.
         if ($count < 7  && $charttype == "2-20") {
-            $point = convertpoint(array($datatable_x,$datatable_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($datestr) . "</div>\n");
-            $point = convertpoint(array($datatable_x + $datatable_age_offset,$datatable_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($ageinYMD) . "</div>\n");
-            $point = convertpoint(array($datatable_x + $datatable_weight_offset,$datatable_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsWt($weight)) . "</div>\n");
-            $point = convertpoint(array($datatable_x + $datatable_height_offset,$datatable_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($height)) . "</div>\n");
-            $point = convertpoint(array($datatable_x + $datatable_bmi_offset,$datatable_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(substr($bmi, 0, 5)) . "</div>\n");
+            imagestring($im, 2, $datatable_x, $datatable_y, $datestr, $color);
+            imagestring($im, 2, ($datatable_x + $datatable_age_offset), $datatable_y, $ageinYMD, $color);
+            imagestring($im, 2, ($datatable_x + $datatable_weight_offset), $datatable_y, unitsWt($weight), $color);
+            imagestring($im, 2, ($datatable_x + $datatable_height_offset), $datatable_y, unitsDist($height), $color);
+            imagestring($im, 2, ($datatable_x + $datatable_bmi_offset), $datatable_y, substr($bmi, 0, 5), $color);
             $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable "row pointer"
         }
 
         // Head Circumference chart has 5 rows to fill in
         if ($count < 5 && $charttype == "birth") {
-            $point = convertpoint(array($datatable2_x,$datatable2_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($datestr) . "</div>\n");
-            $point = convertpoint(array($datatable2_x + $datatable2_age_offset,$datatable2_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($ageinYMD) . "</div>\n");
-            $point = convertpoint(array($datatable2_x + $datatable2_weight_offset,$datatable2_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsWt($weight)) . "</div>\n");
-            $point = convertpoint(array($datatable2_x + $datatable2_height_offset,$datatable2_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($height)) . "</div>\n");
-            $point = convertpoint(array($datatable2_x + $datatable2_hc_offset,$datatable2_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($head_circ)) . "</div>\n");
+            imagestring($im, 2, $datatable2_x, $datatable2_y, $datestr, $color);
+            imagestring($im, 2, ($datatable2_x + $datatable2_age_offset), $datatable2_y, $ageinYMD, $color);
+            imagestring($im, 2, ($datatable2_x + $datatable2_weight_offset), $datatable2_y, unitsWt($weight), $color);
+            imagestring($im, 2, ($datatable2_x + $datatable2_height_offset), $datatable2_y, unitsDist($height), $color);
+            imagestring($im, 2, ($datatable2_x + $datatable2_hc_offset), $datatable2_y, unitsDist($head_circ), $color);
             $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 "row pointer"
         }
 
         // BMI chart has 14 rows to fill in.
         if ($count < 14 && $charttype == "2-20") {
-            $point = convertpoint(array($datatable2_x,$datatable2_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($datestr) . "</div>\n");
-            $point = convertpoint(array($datatable2_x + $datatable2_age_offset,$datatable2_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text($ageinYMD) . "</div>\n");
-            $point = convertpoint(array($datatable2_x + $datatable2_weight_offset,$datatable2_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsWt($weight)) . "</div>\n");
-            $point = convertpoint(array($datatable2_x + $datatable2_height_offset,$datatable2_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(unitsDist($height)) . "</div>\n");
-            $point = convertpoint(array($datatable2_x + $datatable2_bmi_offset,$datatable2_y));
-            echo("<div id='" . attr($point[2]) . "' class='label_custom' style='position: absolute; top: " . attr($point[1]) . "pt; left: " . attr($point[0]) . "pt;'>" . text(substr($bmi, 0, 5)) . "</div>\n");
+            imagestring($im, 2, $datatable2_x, $datatable2_y, $datestr, $color);
+            imagestring($im, 2, ($datatable2_x + $datatable2_age_offset), $datatable2_y, $ageinYMD, $color);
+            imagestring($im, 2, ($datatable2_x + $datatable2_weight_offset), $datatable2_y, unitsWt($weight), $color);
+            imagestring($im, 2, ($datatable2_x + $datatable2_height_offset), $datatable2_y, unitsDist($height), $color);
+            imagestring($im, 2, ($datatable2_x + $datatable2_bmi_offset), $datatable2_y, substr($bmi, 0, 5), $color);
             $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 "row pointer"
         }
 
         $count++;
     }
-
-    cssFooter();
-    exit;
-}
-
-// Done creating CSS HTML output
-/******************************/
-
-
-// create the graph
-$im     = imagecreatefrompng($chartpath . $chart);
-$color1 = imagecolorallocate($im, 0, 0, 255); //blue - color scheme imagecolorallocate($im, Red, Green, Blue)
-$color  = imagecolorallocate($im, 255, 51, 51); //red
-
-// draw the patient's name
-imagestring($im, 12, $name_x, $name_y, $name, $color);
-imagestring($im, 12, $name_x1, $name_y1, $name, $color);
-
-// counter to limit the number of data points plotted
-$count = 0;
-
-// plot the data points
-foreach ($datapoints as $data) {
-    list($date, $height, $weight, $head_circ) = explode('-', $data);
-    if ($date == "") {
-        continue;
-    }
-
-    // only plot if we have both weight and heights. Skip if either is 0.
-    // Rational is only well visit will need both, sick visit only needs weight
-    // for some clinic.
-    if ($weight == 0 || $height == 0) {
-        continue;
-    }
-
-    // get age of patient at this data-point
-    // to get data from function getPatientAgeYMD including $age, $ageinYMD, $age_in_months
-    extract(getPatientAgeYMD($dob, $date));
-    if ($charttype == 'birth') {
-        // for birth style chart, we use the age in months
-        $age = $age_in_months;
-    }
-
-    // exclude data points that do not belong on this chart
-    // for example, a data point for a 18 month old can be excluded
-    // from that patient's 2-20 yr chart
-    $daysold = getPatientAgeInDays($dob, $date);
-    if ($daysold > (365 * 2) && $charttype == "birth") {
-        continue;
-    }
-
-    if ($daysold < (365 * 2) && $charttype == "2-20") {
-        continue;
-    }
-
-    // calculate the x-axis (Age) value
-    $x = $dot_x + $delta_x * ($age - $ageOffset);
-
-    // Draw Height dot
-    $y1 = $dot_y1 - $delta_y1 * ($height - $heightOffset);
-    imagefilledellipse($im, $x, $y1, 10, 10, $color);
-
-    // Draw Weight bullseye
-    $y2 = $dot_y2 - $delta_y2 * ($weight - $weightOffset);
-    imageellipse($im, $x, $y2, 12, 12, $color); // outter ring
-    imagefilledellipse($im, $x, $y2, 5, 5, $color); //center dot
-
-    if ($charttype == "birth") {
-        // Draw Head circumference
-        $HC_x = $HC_dot_x + $HC_delta_x * $age;
-        $HC_y = $HC_dot_y - $HC_delta_y * ($head_circ - 11);
-        imagefilledellipse($im, $HC_x, $HC_y, 10, 10, $color1);
-        // Draw Wt and Ht graph at the bottom half
-        $WT = $WT_y - $WT_delta_y * ($weight - $WToffset);
-        $HT = $HT_x + $HT_delta_x * ($height - $HToffset);
-        imagefilledellipse($im, $HT, $WT, 10, 10, $color);
-    } elseif ($charttype == "2-20") {
-        // Draw BMI
-        $bmi = $weight / $height / $height * 703;
-        $bmi_x = $bmi_dot_x + $bmi_delta_x * ($age - 2);
-        $bmi_y = $bmi_dot_y - $bmi_delta_y * ($bmi - 10);
-        imagefilledellipse($im, $bmi_x, $bmi_y, 10, 10, $color1);
-    }
-
-    // fill in data tables
-
-    $datestr = substr($date, 0, 4) . "/" . substr($date, 4, 2) . "/" . substr($date, 6, 2);
-
-    //birth to 24 mos chart has 8 rows to fill.
-    if ($count < 8 && $charttype == "birth") {
-        imagestring($im, 2, $datatable_x, $datatable_y, $datestr, $color);
-        imagestring($im, 2, ($datatable_x + $datatable_age_offset), $datatable_y, $ageinYMD, $color);
-        imagestring($im, 2, ($datatable_x + $datatable_weight_offset), $datatable_y, unitsWt($weight), $color);
-        imagestring($im, 2, ($datatable_x + $datatable_height_offset), $datatable_y, unitsDist($height), $color);
-        imagestring($im, 2, ($datatable_x + $datatable_hc_offset), $datatable_y, unitsDist($head_circ), $color);
-        $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable "row pointer"
-    }
-
-    // 2 to 20 year-old chart has 7 rows to fill.
-    if ($count < 7  && $charttype == "2-20") {
-        imagestring($im, 2, $datatable_x, $datatable_y, $datestr, $color);
-        imagestring($im, 2, ($datatable_x + $datatable_age_offset), $datatable_y, $ageinYMD, $color);
-        imagestring($im, 2, ($datatable_x + $datatable_weight_offset), $datatable_y, unitsWt($weight), $color);
-        imagestring($im, 2, ($datatable_x + $datatable_height_offset), $datatable_y, unitsDist($height), $color);
-        imagestring($im, 2, ($datatable_x + $datatable_bmi_offset), $datatable_y, substr($bmi, 0, 5), $color);
-        $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable "row pointer"
-    }
-
-    // Head Circumference chart has 5 rows to fill in
-    if ($count < 5 && $charttype == "birth") {
-        imagestring($im, 2, $datatable2_x, $datatable2_y, $datestr, $color);
-        imagestring($im, 2, ($datatable2_x + $datatable2_age_offset), $datatable2_y, $ageinYMD, $color);
-        imagestring($im, 2, ($datatable2_x + $datatable2_weight_offset), $datatable2_y, unitsWt($weight), $color);
-        imagestring($im, 2, ($datatable2_x + $datatable2_height_offset), $datatable2_y, unitsDist($height), $color);
-        imagestring($im, 2, ($datatable2_x + $datatable2_hc_offset), $datatable2_y, unitsDist($head_circ), $color);
-        $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 "row pointer"
-    }
-
-    // BMI chart has 14 rows to fill in.
-    if ($count < 14 && $charttype == "2-20") {
-        imagestring($im, 2, $datatable2_x, $datatable2_y, $datestr, $color);
-        imagestring($im, 2, ($datatable2_x + $datatable2_age_offset), $datatable2_y, $ageinYMD, $color);
-        imagestring($im, 2, ($datatable2_x + $datatable2_weight_offset), $datatable2_y, unitsWt($weight), $color);
-        imagestring($im, 2, ($datatable2_x + $datatable2_height_offset), $datatable2_y, unitsDist($height), $color);
-        imagestring($im, 2, ($datatable2_x + $datatable2_bmi_offset), $datatable2_y, substr($bmi, 0, 5), $color);
-        $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 "row pointer"
-    }
-
-    $count++;
 }
 
 if ($_GET['pdf'] == 1) {
diff --git a/interface/forms/vitals/templates/vitals/vitals.html.twig b/interface/forms/vitals/templates/vitals/vitals.html.twig
index 04946d824f1..6c7b238cef1 100644
--- a/interface/forms/vitals/templates/vitals/vitals.html.twig
+++ b/interface/forms/vitals/templates/vitals/vitals.html.twig
@@ -52,6 +52,14 @@
         <div class="col-sm-12">
             <form id="vitalsForm" name="vitals" method="post" action="{{ FORM_ACTION|attr }}/interface/forms/vitals/save.php">
                 <input type="hidden" name="csrf_token_form" value="{{ CSRF_TOKEN_FORM|attr }}" />
+                <div class="row">
+                    <div class="col-md-auto p-3 font-weight-bold text-right">
+                        <label for="date">{{ "Date"|xlt }}</label>
+                    </div>
+                    <div class="col-md-auto p-2">
+                        <input title="{{ 'Date and time of this observation'|xla }}" type='text' size='14' class='form-control datetimepicker oe-patient-background' name='date' id='date' value='{{ vitals.get_date|dateToTime|date("Y-m-d H:i")|attr }}' />
+                    </div>
+                </div>
                 <div id="chart" class="chart-dygraphs" style="margin-left: -15px"></div>
                     <div class="table-responsive">
 
@@ -61,9 +69,7 @@
                                 <tr>
                                     <th class="text-left"><span class="vitals-title">{{ "Name"|xlt }}</span></th>
                                     <th class="text-left">{{ "Unit"|xlt }}</th>
-                                    <th class='currentvalues p-2' title="{{ 'Date and time of this observation'|xla }}">
-                                        <input type='text' size='14' class='form-control datetimepicker oe-patient-background' name='date' id='date' value='{{ vitals.get_date|dateToTime|date("Y-m-d H:i")|attr }}' />
-                                    </th>
+                                    <th class="editonly">{{ "Value"|xlt }}</th>
                                     <th class="editonly">{{ "Abn"|xlt }}</th>
                                     <th class="editonly">{{ "Actions"|xlt }}</th>
                                     {% for result in vitalsHistoryLookback %}
diff --git a/interface/patient_file/printed_fee_sheet.php b/interface/patient_file/printed_fee_sheet.php
index b9738244cef..f7983306387 100644
--- a/interface/patient_file/printed_fee_sheet.php
+++ b/interface/patient_file/printed_fee_sheet.php
@@ -356,9 +356,9 @@ function printlog_before_print() {
 $logo = '';
 $ma_logo_path = "sites/" . $_SESSION['site_id'] . "/images/ma_logo.png";
 if (is_file("$webserver_root/$ma_logo_path")) {
-    $logo = "<img src='$web_root/$ma_logo_path' style='height:" . round(9 * 5.14) . "pt' />";
+    $logo = "$web_root/$ma_logo_path";
 } else {
-    $logo = "<!-- '$ma_logo_path' does not exist. -->";
+    $logo = "";
 }
 
 // Loop on array of PIDS
diff --git a/interface/patient_file/report/custom_report.php b/interface/patient_file/report/custom_report.php
index 52704d3d9f8..bd2de1c1db1 100644
--- a/interface/patient_file/report/custom_report.php
+++ b/interface/patient_file/report/custom_report.php
@@ -63,10 +63,10 @@
         'default_font' => 'dejavusans',
         'margin_left' => $GLOBALS['pdf_left_margin'],
         'margin_right' => $GLOBALS['pdf_right_margin'],
-        'margin_top' => $GLOBALS['pdf_top_margin'],
-        'margin_bottom' => $GLOBALS['pdf_bottom_margin'],
-        'margin_header' => '',
-        'margin_footer' => '',
+        'margin_top' => $GLOBALS['pdf_top_margin'] * 1.5,
+        'margin_bottom' => $GLOBALS['pdf_bottom_margin'] * 1.5,
+        'margin_header' => $GLOBALS['pdf_top_margin'],
+        'margin_footer' => $GLOBALS['pdf_bottom_margin'],
         'orientation' => $GLOBALS['pdf_layout'],
         'shrink_tables_to_fit' => 1,
         'use_kwt' => true,
@@ -235,10 +235,8 @@ function zip_content($source, $destination, $content = '', $create = true)
 
             if ($printable) {
                 /*******************************************************************
-                 * $titleres = getPatientData($pid, "fname,lname,providerID");
                  * $sql = "SELECT * FROM facility ORDER BY billing_location DESC LIMIT 1";
                  *******************************************************************/
-                $titleres = getPatientData($pid, "fname,lname,providerID,DATE_FORMAT(DOB,'%m/%d/%Y') as DOB_TS");
                 $facility = null;
                 if ($_SESSION['pc_facility']) {
                     $facility = $facilityService->getById($_SESSION['pc_facility']);
@@ -248,9 +246,9 @@ function zip_content($source, $destination, $content = '', $create = true)
 
                 /******************************************************************/
                 // Setup Headers and Footers for mPDF only Download
-                // in HTML view it's just one line at the top of page 1
-                echo '<page_header class="custom-tag text-right"> ' . xlt("PATIENT") . ':' . text($titleres['lname']) . ', ' . text($titleres['fname']) . ' - ' . text($titleres['DOB_TS']) . '</page_header>    ';
-                echo '<page_footer class="custom-tag text-right">' . xlt('Generated on') . ' ' . text(oeFormatShortDate()) . ' - ' . text($facility['name']) . ' ' . text($facility['phone']) . '</page_footer>';
+                if ($PDF_OUTPUT) {
+                    echo genPatientHeaderFooter($pid);
+                }
 
                 // Use logo if it exists as 'practice_logo.gif' in the site dir
                 // old code used the global custom dir which is no longer a valid
@@ -262,21 +260,12 @@ function zip_content($source, $destination, $content = '', $create = true)
                     $practice_logo = $plogo[$k];
                 }
 
-                echo "<div class='table-responsive'><table class='table'><tbody><tr><td>";
+                $logo = "";
                 if (file_exists($practice_logo)) {
-                    $logo_path = $GLOBALS['OE_SITE_WEBROOT'] . "/images/" . basename($practice_logo);
-                    echo "<img class='h-auto' style='max-width:250px;' src='$logo_path'>"; // keep size within reason
-                    echo "</td><td>";
+                    $logo = $GLOBALS['OE_SITE_WEBROOT'] . "/images/" . basename($practice_logo);
                 }
-                ?>
-                <h5><?php echo text($facility['name']); ?></h5>
-                <?php echo text($facility['street']); ?><br />
-                <?php echo text($facility['city']); ?>, <?php echo text($facility['state']); ?><?php echo text($facility['postal_code']); ?><br clear='all'>
-                <?php echo text($facility['phone']); ?><br />
-
-                <a href="javascript:window.close();"><span class='title'><?php echo xlt('Patient') . ": " . text($titleres['fname']) . " " . text($titleres['lname']); ?></span></a><br />
-                <span class='text'><?php echo xlt('Generated on'); ?>: <?php echo text(oeFormatShortDate()); ?></span>
-                <?php echo "</td></tr></tbody></table></div>"; ?>
+
+                echo genFacilityTitle(getPatientName($pid), $_SESSION['pc_facility'], $logo);?>
 
             <?php } else { // not printable
                 ?>
diff --git a/interface/patient_file/summary/create_portallogin.php b/interface/patient_file/summary/create_portallogin.php
index 49fbb8937c0..30a64d52f77 100644
--- a/interface/patient_file/summary/create_portallogin.php
+++ b/interface/patient_file/summary/create_portallogin.php
@@ -10,19 +10,28 @@
  * @author    Paul Simon <paul@zhservices.com>
  * @author    Brady Miller <brady.g.miller@gmail.com>
  * @author    Tyler Wrenn <tyler@tylerwrenn.com>
+ * @author    Stephen Nielson <snielson@discoverandchange.com>
+ * @author    Stephen Waite <stephen.waite@open-emr.org
  * @copyright Copyright (c) 2011 Z&H Consultancy Services Private Limited <sam@zhservices.com>
  * @copyright Copyright (c) 2018-2019 Brady Miller <brady.g.miller@gmail.com>
  * @copyright Copyright (c) 2020 Tyler Wrenn <tyler@tylerwrenn.com>
+ * @copyright Copyright (c) 2022 Discover and Change, Inc <snielson@discoverandchange.com>
+ * @copyright Copyright (c) 2022 Stephen Waite <stephen.waite@open-emr.org
  * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3
  */
 
 require_once("../../globals.php");
 require_once('../../../library/amc.php');
 
-use OpenEMR\Common\Auth\AuthHash;
-use OpenEMR\Common\Csrf\CsrfUtils;
-use OpenEMR\Common\Twig\TwigContainer;
-use OpenEMR\Common\Utils\RandomGenUtils;
+use OpenEMR\Common\ {
+    Auth\AuthHash,
+    Csrf\CsrfUtils,
+    Logging\EventAuditLogger,
+    Twig\TwigContainer,
+    Utils\RandomGenUtils,
+};
+use OpenEMR\Events\Patient\Summary\PortalCredentialsTemplateDataFilterEvent;
+use OpenEMR\Events\Patient\Summary\PortalCredentialsUpdatedEvent;
 use OpenEMR\FHIR\Config\ServerConfig;
 use Twig\Environment;
 
@@ -122,13 +131,22 @@ function displayLogin($patient_id, $message, $emailFlag)
         error_log('OpenEMR Error : OpenEMR is not working because unable to create a hash.');
         die("OpenEMR Error : OpenEMR is not working because unable to create a hash.");
     }
-    array_push($query_parameters, $hash);
 
+    array_push($query_parameters, $hash);
     array_push($query_parameters, $pid);
+
+    EventAuditLogger::instance()->newEvent(
+        "patient-access",
+        $_SESSION['authUser'],
+        $_SESSION['authProvider'],
+        1,
+        "updated credentials",
+        $pid,
+        'open-emr',
+        'dashboard'
+    );
     if (sqlNumRows($res)) {
-        // TODO: @adunsulag is there a reason why we don't audit the fact that the patient credentials were created and updated?
-        // That seems like a pretty important security event we want to be aware of.
-        sqlStatementNoLog("UPDATE patient_access_onsite SET portal_username=?,portal_login_username=?,portal_pwd=?,portal_pwd_status=0 WHERE pid=?", $query_parameters);
+        sqlStatementNoLog("UPDATE patient_access_onsite SET portal_username=?, portal_login_username=?, portal_pwd=?, portal_pwd_status=0 WHERE pid=?", $query_parameters);
     } else {
         sqlStatementNoLog("INSERT INTO patient_access_onsite SET portal_username=?,portal_login_username=?,portal_pwd=?,portal_pwd_status=0,pid=?", $query_parameters);
     }
@@ -160,6 +178,12 @@ function displayLogin($patient_id, $message, $emailFlag)
     // need to track that credentials were created
 } else {
     $credMessage = '';
+    if (
+        empty($GLOBALS['enforce_signin_email'])
+        && empty($row['portal_username'])
+    ) {
+        $trustedUserName = $row['fname'] . $row['id'];
+    }
 }
 
 echo $twig->render('patient/portal_login/print.html.twig', [
diff --git a/interface/patient_file/summary/demographics.php b/interface/patient_file/summary/demographics.php
index f7afb806ed8..e337edb37fa 100644
--- a/interface/patient_file/summary/demographics.php
+++ b/interface/patient_file/summary/demographics.php
@@ -158,39 +158,85 @@ function get_document_by_catg($pid, $doc_catg)
     return ($result['id'] ?? false);
 }
 
-function portalAuthorized($pid)
+function isPortalEnabled(): bool
 {
-    if (!$GLOBALS['portal_onsite_two_enable'] && !$GLOBALS['portal_onsite_two_address']) {
+    if (
+        !$GLOBALS['portal_onsite_two_enable']
+    ) {
         return false;
     }
 
-    $return = [
-        'isAllowed' => false
-        ,'allowed' => [
-                'api' => false
-                ,'portal' => false
-        ],
-        'credentials' => [
-                'created' => false
-                ,'date' => null
-        ]
-    ];
-
-    $portalStatus = sqlQuery("SELECT allow_patient_portal,prevent_portal_apps FROM patient_data WHERE pid = ?", [$pid]);
-    $return['allowed']['portal'] = $portalStatus['allow_patient_portal'] == 'YES';
-    $return['allowed']['api'] = strtoupper($portalStatus['prevent_portal_apps']) != 'YES';
-    if ($return['allowed']['portal'] || $return['allowed']['api']) {
-        $return['isAllowed'] = true;
-        $portalLogin = sqlQuery("SELECT pid,date_created FROM `patient_access_onsite` WHERE `pid`=?", [$pid]);
-        if ($portalLogin) {
-            $return['credentials']['date'] = $portalLogin['date_created'];
-            $return['credentials']['created'] = true;
-        }
-        return $return;
+    return true;
+}
+
+function isPortalSiteAddressValid(): bool
+{
+    if (
+        // maybe can use filter_var() someday but the default value in GLOBALS
+        // fails with FILTER_VALIDATE_URL
+        !isset($GLOBALS['portal_onsite_two_address'])
+    ) {
+        return false;
+    }
+
+    return true;
+}
+
+function isPortalAllowed($pid): bool
+{
+    $return = false;
+
+    $portalStatus = sqlQuery("SELECT allow_patient_portal FROM patient_data WHERE pid = ?", [$pid]);
+    if ($portalStatus['allow_patient_portal'] == 'YES') {
+        $return = true;
     }
     return $return;
 }
 
+function isApiAllowed($pid): bool
+{
+    $return = false;
+
+    $apiStatus = sqlQuery("SELECT prevent_portal_apps FROM patient_data WHERE pid = ?", [$pid]);
+    if (strtoupper($apiStatus['prevent_portal_apps'] ?? '') != 'YES') {
+        $return = true;
+    }
+    return $return;
+}
+
+function areCredentialsCreated($pid): bool
+{
+    $return = false;
+    $credentialsCreated = sqlQuery("SELECT date_created FROM `patient_access_onsite` WHERE `pid`=?", [$pid]);
+    if ($credentialsCreated['date_created'] ?? null) {
+        $return = true;
+    }
+
+    return $return;
+}
+
+function isContactEmail($pid): bool
+{
+    $return = false;
+
+    $email = sqlQuery("SELECT email, email_direct FROM patient_data WHERE pid = ?", [$pid]);
+    if (!empty($email['email']) || !empty($email['email_direct'])) {
+        $return = true;
+    }
+    return $return;
+}
+
+function isEnforceSigninEmailPortal(): bool
+{
+    if (
+        $GLOBALS['enforce_signin_email']
+    ) {
+        return true;
+    }
+
+    return false;
+}
+
 function deceasedDays($days_deceased)
 {
     $deceased_days = intval($days_deceased['days_deceased'] ?? '');
@@ -1325,9 +1371,8 @@ function setMyPatient() {
                 <div class="col-md-4">
                     <!-- start right column div -->
                     <?php
-                    if ($GLOBALS['portal_onsite_two_enable']) :
-                        $portalCard = new PortalCard($GLOBALS);
-                    endif;
+                    // it's important enough to always show it
+                    $portalCard = new PortalCard($GLOBALS);
 
                     $sectionRenderEvents = $ed->dispatch(SectionEvent::EVENT_HANDLE, new SectionEvent('secondary'));
                     $sectionCards = $sectionRenderEvents->getCards();
diff --git a/interface/patient_file/summary/demographics_print.php b/interface/patient_file/summary/demographics_print.php
index e7625eaa7a8..be663a23ba8 100644
--- a/interface/patient_file/summary/demographics_print.php
+++ b/interface/patient_file/summary/demographics_print.php
@@ -208,10 +208,9 @@
 $logo = '';
 $ma_logo_path = "sites/" . $_SESSION['site_id'] . "/images/ma_logo.png";
 if (is_file("$webserver_root/$ma_logo_path")) {
-    $logo = "<img src='$web_root/$ma_logo_path' style='height:" . round(9 * 5.14) . "pt' />";
-} else {
-    $logo = "<!-- '$ma_logo_path' does not exist. -->";
+    $logo = "$web_root/$ma_logo_path";
 }
+
 echo genFacilityTitle(xl('Registration Form'), -1, $logo);
 
 function end_cell()
diff --git a/interface/patient_file/summary/track_anything_fragment.php b/interface/patient_file/summary/track_anything_fragment.php
index 15ac09a30eb..2d21c0facc1 100644
--- a/interface/patient_file/summary/track_anything_fragment.php
+++ b/interface/patient_file/summary/track_anything_fragment.php
@@ -32,8 +32,8 @@
             "AND formdir = ? " .
             "GROUP BY form_name " .
             "ORDER BY maxdate DESC ";
-$result = sqlQuery($spell, array($pid, 'track_anything'));
-if (!$result) { //If there are no disclosures recorded
+$result = sqlStatement($spell, array($pid, 'track_anything'));
+if (!sqlNumRows($result)) { //If there are no disclosures recorded
     ?>
   <span class='text'> <?php echo xlt("No tracks have been documented.");
     ?>
@@ -42,9 +42,7 @@
 } else {  // We have some tracks here...
     echo "<span class='text'>";
     echo xlt('Available Tracks') . ":";
-    echo text($result);
     echo "<ul>";
-    $result = sqlStatement($spell, array($pid, 'track_anything'));
     while ($myrow = sqlFetchArray($result)) {
         $formname = $myrow['form_name'];
         $thedate = $myrow['maxdate'];
diff --git a/interface/patient_file/transaction/print_referral.php b/interface/patient_file/transaction/print_referral.php
index 4e689d48472..d6bbde723b8 100644
--- a/interface/patient_file/transaction/print_referral.php
+++ b/interface/patient_file/transaction/print_referral.php
@@ -151,10 +151,10 @@
 }
 
 // Generate link to MA logo if it exists.
-$logo = "<!-- '" . ($ma_logo_path ?? '') . "' does not exist. -->";
+$logo = "";
 $ma_logo_path = "sites/" . $_SESSION['site_id'] . "/images/ma_logo.png";
 if (is_file("$webserver_root/$ma_logo_path")) {
-    $logo = "<img src='$web_root/$ma_logo_path' style='height:" . round(9 * 5.14) . "pt' />";
+    $logo = "$web_root/$ma_logo_path";
 }
 
 $s = '';
diff --git a/interface/usergroup/facility_admin.php b/interface/usergroup/facility_admin.php
index 4d933d6aaae..8b9a4613601 100644
--- a/interface/usergroup/facility_admin.php
+++ b/interface/usergroup/facility_admin.php
@@ -237,7 +237,7 @@ function displayAlert() {
                             <?php
                                 $disabled = '';
                                 $resPBE = $facilityService->getPrimaryBusinessEntity(array("excludedId" => $my_fid));
-                            if ($resPBE) {
+                            if ($resPBE && ($GLOBALS['erx_enable'] ?? null)) {
                                 $disabled = 'disabled';
                             }
                             ?>
diff --git a/library/classes/X12Partner.class.php b/library/classes/X12Partner.class.php
index 0f2ac02cf8c..0d11b1ed2de 100644
--- a/library/classes/X12Partner.class.php
+++ b/library/classes/X12Partner.class.php
@@ -237,7 +237,7 @@ function get_x12_isa02()
 
     function set_x12_isa02($string)
     {
-            $this->x12_isa02 = $string;
+            $this->x12_isa02 = str_pad($string, 10);
     }
 
     function get_x12_isa03()
@@ -257,7 +257,7 @@ function get_x12_isa04()
 
     function set_x12_isa04($string)
     {
-            $this->x12_isa04 = $string;
+            $this->x12_isa04 = str_pad($string, 10);
     }
 
     function get_x12_isa05()
diff --git a/library/clinical_rules.php b/library/clinical_rules.php
index 8843e14575f..6556f90a8d7 100644
--- a/library/clinical_rules.php
+++ b/library/clinical_rules.php
@@ -1192,7 +1192,7 @@ function test_rules_clinic($provider = '', $type = '', $dateTarget = '', $mode =
                             // increment pass target counter
                             $pass_target++;
                             // If report itemization is turned on, then record the "passed" item and set the flag
-                            if ($GLOBALS['report_itemizing_temp_flag_and_id']) {
+                            if ($GLOBALS['report_itemizing_temp_flag_and_id'] ?? null) {
                                 insertItemReportTracker($GLOBALS['report_itemizing_temp_flag_and_id'], $GLOBALS['report_itemized_test_id_iterator'], 1, $rowPatient['pid']);
                                 $temp_track_pass = 1;
                             }
diff --git a/library/options.inc.php b/library/options.inc.php
index ed2b0d1276c..4329392a194 100644
--- a/library/options.inc.php
+++ b/library/options.inc.php
@@ -2427,6 +2427,9 @@ function generate_display_field($frow, $currvalue)
     $field_id   = isset($frow['field_id'])  ? $frow['field_id'] : null;
     $list_id    = $frow['list_id'];
     $backup_list = isset($frow['list_backup_id']) ? $frow['list_backup_id'] : null;
+    $show_unchecked_arr = array();
+    getLayoutProperties($frow['form_id'] ?? null, $show_unchecked_arr, 'grp_unchecked', "1");
+    $show_unchecked = strval($show_unchecked_arr['']['grp_unchecked'] ?? null) == "0" ? false : true;
 
     $s = '';
 
diff --git a/library/patient.inc b/library/patient.inc
index 935ecdd4b8e..5b602b5fbb1 100644
--- a/library/patient.inc
+++ b/library/patient.inc
@@ -194,18 +194,18 @@ function getFacility($facid = 0)
 // Generate a report title including report name and facility name, address
 // and phone.
 //
-function genFacilityTitle($repname = '', $facid = 0, $logo = '')
+function genFacilityTitle($repname = '', $facid = 0, $logo = "")
 {
     $s = '';
-    $s .= "<table class='ftitletable'>\n";
+    $s .= "<table class='ftitletable' width='100%'>\n";
     $s .= " <tr>\n";
     if (empty($logo)) {
-        $s .= "  <td class='ftitlecell1'>" . text($repname) . "</td>\n";
+        $s .= "  <td align='left' class='ftitlecell1'>" . text($repname) . "</td>\n";
     } else {
-        $s .= "  <td class='ftitlecell1'>" . $logo . "</td>\n";
-        $s .= "  <td class='ftitlecellm'>" . text($repname) . "</td>\n";
+        $s .= "  <td align='left' class='ftitlecell1'><img class='h-auto' style='max-height:8%;' src='" . attr($logo) . "' /></td>\n";
+        $s .= "  <td align='left' class='ftitlecellm'><h2>" . text($repname) . "</h2></td>\n";
     }
-    $s .= "  <td class='ftitlecell2'>\n";
+    $s .= "  <td align='right' class='ftitlecell2'>\n";
     $r = getFacility($facid);
     if (!empty($r)) {
         $s .= "<b>" . text($r['name'] ?? '') . "</b>\n";
@@ -409,6 +409,34 @@ function getEmployerData($pid, $given = "*")
     return sqlQuery($sql, array($pid));
 }
 
+// Generate a consistent header and footer, used for printed patient reports
+function genPatientHeaderFooter($pid, $DOS = null)
+{
+    $patient_dob = getPatientData($pid, "DATE_FORMAT(DOB,'%m/%d/%Y') as DOB_TS");
+    $patient_name = getPatientName($pid);
+
+    // Header
+    $s = '<htmlpageheader name="PageHeader1"><div style="text-align: right; font-weight: bold;">';
+    $s .= text($patient_name) . '&emsp;DOB: ' . text($patient_dob['DOB_TS']);
+    if ($DOS) {
+        $s .= '&emsp;DOS: ' . text($DOS);
+    }
+    $s .= '</div></htmlpageheader>';
+
+    // Footer
+    $s .= '<htmlpagefooter name="PageFooter1"><div style="text-align: right; font-weight: bold;">';
+    $s .= '<div style="float: right; width:33%; text-align: left;">' . oeFormatDateTime(date("Y-m-d H:i:s")) . '</div>';
+    $s .= '<div style="float: right; width:33%; text-align: center;">{PAGENO}/{nbpg}</div>';
+    $s .= '<div style="float: right; width:33%; text-align: right;">' . text($patient_name) . '</div>';
+    $s .= '</div></htmlpagefooter>';
+
+    // Set the header and footer in the current document
+    $s .= '<sethtmlpageheader name="PageHeader1" page="ALL" value="ON" show-this-page="1" />';
+    $s .= '<sethtmlpagefooter name="PageFooter1" page="ALL" value="ON" />';
+
+    return $s;
+}
+
 function _set_patient_inc_count($limit, $count, $where, $whereBindArray = array())
 {
   // When the limit is exceeded, find out what the unlimited count would be.
@@ -757,7 +785,7 @@ function getPatientPID($args)
     return $returnval;
 }
 
-/* return a patient's name in the format LAST, FIRST */
+/* return a patient's name in the format LAST [SUFFIX], FIRST [MIDDLE] */
 function getPatientName($pid)
 {
     if (empty($pid)) {
@@ -769,7 +797,10 @@ function getPatientName($pid)
         return "";
     }
 
-    $patientName =  $patientData[0]['lname'] . ", " . $patientData[0]['fname'];
+    $patientName = $patientData[0]['lname'];
+    $patientName .= $patientData[0]['suffix'] ? " " . $patientData[0]['suffix'] . ", " : ", ";
+    $patientName .= $patientData[0]['fname'];
+    $patientName .= empty($patientData[0]['mname']) ? "" : " " . $patientData[0]['mname'];
     return $patientName;
 }
 
diff --git a/portal/get_patient_info.php b/portal/get_patient_info.php
index c0f9f72be7e..c4269e73183 100644
--- a/portal/get_patient_info.php
+++ b/portal/get_patient_info.php
@@ -63,6 +63,16 @@
 
 // Authentication
 require_once('../interface/globals.php');
+
+if (
+    $GLOBALS['enforce_signin_email']
+    && (!isset($_POST['passaddon']) || empty($_POST['passaddon']))
+) {
+    OpenEMR\Common\Session\SessionUtil::portalSessionCookieDestroy();
+    header('Location: ' . $landingpage . '&w&c');
+    exit();
+}
+
 require_once(dirname(__FILE__) . "/lib/appsql.class.php");
 require_once("$srcdir/user.inc");
 
@@ -245,8 +255,8 @@
         $_SESSION['patient_portal_onsite_two'] = 1;
 
         $tmp = getUserIDInfo($userData['providerID']);
-        $_SESSION['providerName'] = $tmp['fname'] . ' ' . $tmp['lname'];
-        $_SESSION['providerUName'] = $tmp['username'];
+        $_SESSION['providerName'] = ($tmp['fname'] ?? '') . ' ' . ($tmp['lname'] ?? '');
+        $_SESSION['providerUName'] = $tmp['username'] ?? null;
         $_SESSION['sessionUser'] = '-patient-'; // $_POST['uname'];
         $_SESSION['providerId'] = $userData['providerID'] ? $userData['providerID'] : 'undefined';
         $_SESSION['ptName'] = $userData['fname'] . ' ' . $userData['lname'];
diff --git a/portal/import_template.php b/portal/import_template.php
index 051feef24e4..5017f97fbfd 100644
--- a/portal/import_template.php
+++ b/portal/import_template.php
@@ -56,7 +56,7 @@
     die(xlt('Invalid File'));
 }
 
-if ($_POST['mode'] === 'get') {
+if ($_POST['mode'] ?? null === 'get') {
     if ($_REQUEST['docid']) {
         $template = $templateService->fetchTemplate($_POST['docid']);
         echo $template['template_content'];
diff --git a/portal/import_template_ui.php b/portal/import_template_ui.php
index 3843abe988c..c511f3b3cff 100644
--- a/portal/import_template_ui.php
+++ b/portal/import_template_ui.php
@@ -828,7 +828,7 @@ function createBlankTemplate() {
                                 $template_id = $file['id'];
                                 $audit_status = array(
                                     'pid' => '',
-                                    'create_date' => ($file['profile_date'] ?: $file['modified_date']) ?? '',
+                                    'create_date' => (($file['profile_date'] ?? null) ?: $file['modified_date']) ?? '',
                                     'doc_type' => '',
                                     'patient_signed_time' => '',
                                     'authorize_signed_time' => '',
@@ -850,7 +850,7 @@ function createBlankTemplate() {
                                         $audit_status['denial_reason'] = xl('Scheduled');
                                     }
                                     $next_due = date('m/d/Y', $next_due);
-                                } elseif ($next_due === 1 || ($next_due === true && $file['recurring'] ?? 0)) {
+                                } elseif ($next_due === 1 || ($next_due === true && ($file['recurring'] ?? 0))) {
                                     $audit_status['denial_reason'] = xl('Recurring');
                                     $next_due = xl('Active');
                                 } elseif ($next_due === 0) {
diff --git a/portal/index.php b/portal/index.php
index 33755b8193b..ce9f468dca9 100644
--- a/portal/index.php
+++ b/portal/index.php
@@ -139,7 +139,7 @@
         header('Location: ' . $landingpage . '&w&u');
         exit();
     }
-} else if (isset($_GET['forward'])) {
+} elseif (isset($_GET['forward'])) {
     if ((empty($GLOBALS['portal_two_pass_reset']) && empty($GLOBALS['portal_onsite_two_register'])) || empty($GLOBALS['google_recaptcha_site_key']) || empty($GLOBALS['google_recaptcha_secret_key'])) {
         (new SystemLogger())->debug("reset password and registration not supported, so stopped attempt to use forward token");
         OpenEMR\Common\Session\SessionUtil::portalSessionCookieDestroy();
@@ -357,14 +357,14 @@ function enableVerifyBtn(){
                     </div>
                 </div>
                 <div class="form-row my-3">
-                    <label class="col-md-2 col-form-label" for="pass"><?php echo !$_SESSION['onetime'] ? xlt('Current Password') : ''; ?></label>
+                    <label class="col-md-2 col-form-label" for="pass"><?php echo empty($_SESSION['onetime'] ?? null) ? xlt('Current Password') : ''; ?></label>
                     <div class="col-md">
-                        <input class="form-control" name="pass" id="pass" <?php echo $_SESSION['onetime'] ? 'type="hidden" ' : 'type="password" '; ?> autocomplete="none" value="<?php echo attr($_SESSION['onetime']);
-                        $_SESSION['password_update'] = $_SESSION['onetime'] ? 2 : 1;
+                        <input class="form-control" name="pass" id="pass" <?php echo ($_SESSION['onetime'] ?? null) ? 'type="hidden" ' : 'type="password" '; ?> autocomplete="none" value="<?php echo attr($_SESSION['onetime'] ?? '');
+                        $_SESSION['password_update'] = ($_SESSION['onetime'] ?? null) ? 2 : 1;
                         unset($_SESSION['onetime']); ?>" required />
                     </div>
                 </div>
-                <?php if ($_SESSION['pin']) { ?>
+                <?php if ($_SESSION['pin'] ?? null) { ?>
                     <div class="form-row my-3">
                         <label class="col-md-2 col-form-label" for="token_pin"><?php echo xlt('One Time PIN'); ?></label>
                         <div class="col-md">
diff --git a/portal/lib/appsql.class.php b/portal/lib/appsql.class.php
index 282ed76bf98..4de8bcc89b9 100644
--- a/portal/lib/appsql.class.php
+++ b/portal/lib/appsql.class.php
@@ -199,7 +199,7 @@ public function portalAudit(string $type = null, string $rec = null, array $audi
     public function portalLog($event = '', $patient_id = null, $comments = "", $binds = '', $success = '1', $user_notes = '', $ccda_doc_id = 0)
     {
         $groupname = isset($GLOBALS['groupname']) ? $GLOBALS['groupname'] : 'none';
-        $user = isset($_SESSION['portal_username']) ? $_SESSION['portal_username'] : $_SESSION['authUser'];
+        $user = isset($_SESSION['portal_username']) ? $_SESSION['portal_username'] : $_SESSION['authUser'] ?? null;
         $log_from = isset($_SESSION['portal_username']) ? 'onsite-portal' : 'portal-dashboard';
         if (!isset($_SESSION['portal_username']) && !isset($_SESSION['authUser'])) {
             $log_from = 'portal-login';
diff --git a/sql/database.sql b/sql/database.sql
index c2af43ab50e..a39ab73fcce 100644
--- a/sql/database.sql
+++ b/sql/database.sql
@@ -8730,6 +8730,14 @@ INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_re
 ('CQM_VALUESET', 'NIH_VSAC', '2020-05-07', 'ep_ec_only_cms_20200507.xml.zip', '02dc0b497da979e336c24b0b5c6e1ccb');
 INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES
 ( 'CQM_VALUESET', 'NIH_VSAC', '2021-05-06', 'ep_ec_eh_cms_20210506.xml.zip', '6455da86e269edb6d33288e72b467373');
+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES
+('ICD10', 'CMS', '2021-10-01', '2022-Code Descriptions.zip', '11d1d725c84e55d52ef6633da88aa137');
+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES
+('ICD10', 'CMS', '2021-10-01', 'Zip File 3 2022 ICD-10-PCS Codes File.zip', 'a432177acbdaf9908aa528078ae72176');
+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES
+('ICD10', 'CMS', '2022-10-01', '2023 Code Descriptions in Tabular Order.zip', 'a2bd2e87d6fac3f861b03dba9ca87cbc');
+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES
+('ICD10', 'CMS', '2022-10-01', 'Zip File 3 2023 ICD-10-PCS Codes File.zip', 'a4c0e6026557d770dc3d994718acaa21');
 -- --------------------------------------------------------
 
 --
@@ -13133,12 +13141,6 @@ INSERT INTO `document_templates` (`id`, `pid`, `provider`, `encounter`, `modifie
 INSERT INTO `document_templates` (`id`, `pid`, `provider`, `encounter`, `modified_date`, `profile`, `category`, `location`, `template_name`, `status`, `send_date`, `end_date`, `size`, `template_content`, `mime`) VALUES(9, 0, 18, NULL, '2021-11-21 15:51:42', '', '', NULL, 'Privacy Document', 'New', '0000-00-00 00:00:00', '0000-00-00 00:00:00', 2536, 0x3c703e4e4f54494345204f462050524956414359205052414354494345532050415449454e542041434b4e4f574c454447454d454e5420414e4420434f4e53454e5420544f204d45444943414c2054524541544d454e540d0a50617469656e74204e616d653a203c656d3e7b50617469656e744e616d657d3c2f656d3e0d0a44617465206f662042697274683a207b50617469656e74444f427d0d0a0d0a49206861766520726563656976656420616e6420756e6465727374616e6420746869732070726163746963652773204e6f74696365206f66205072697661637920507261637469636573207772697474656e20696e20706c61696e20456e676c6973682e20546865206e6f746963652070726f766964657320696e2064657461696c20746865207573657320616e6420646973636c6f7375726573206f66206d792070726f746563746564206865616c746820696e666f726d6174696f6e2074686174206d6179206265206d61646520627920746869732070726163746963652c206d7920696e646976696475616c207269676874732c20686f772049206d61792065786572636973652074686f7365207269676874732c20616e642074686520707261637469636573206c6567616c206475746965732077697468207265737065637420746f206d7920696e666f726d6174696f6e2e0d0a0d0a4920756e6465727374616e642074686174207468652070726163746963652072657365727665732074686520726967687420746f206368616e676520746865207465726d73206f66207468652050726976616379205072616374696365732c20616e6420746f206d616b65206368616e67657320726567617264696e6720616c6c2070726f746563746564206865616c746820696e666f726d6174696f6e2e204966206368616e676573206f63637572207468656e207468652070726163746963652077696c6c2070726f76696465206d6520776974682061207265766973656420636f70792075706f6e20726571756573742e0d0a0d0a4920766f6c756e746172696c7920636f6e73656e7420746f20636172652c20696e636c7564696e672070687973696369616e206578616d696e6174696f6e20616e64207465737473207375636820617320782d7261792c206c61626f7261746f727920746573747320616e6420746f206d65646963616c2074726561746d656e74206279206d792070687973696369616e206f72206869732f68657220617373697374616e7473206f722064657369676e6565732c206173206d6179206265206e656365737361727920696e20746865206a7564676d656e74206f66206d792070687973696369616e2e204e6f2067756172616e746565732068617665206265656e206d61646520746f206d652061732074686520726573756c74206f662074726561746d656e74206f72206578616d696e6174696f6e2e0d0a0d0a417574686f72697a6174696f6e20666f723a0d0a496e20636f6e73696465726174696f6e20666f72207365727669636573207265636569766564206279203c656d3e7b526566657272696e67444f437d3c2f656d3e204920616772656520746f2070617920616e7920616e6420616c6c20636861726765732061732062696c6c65642e204920616c736f2072657175657374207468617420646972656374207061796d656e7473206265206d61646520746f203c656d3e7b526566657272696e67444f437d3c2f656d3e206f6e206d7920626568616c6620627920696e73757265727320616e64206167656e6369657320696e2074686520736574746c656d656e74206f6620616e79206f66206d7920636c61696d732e204920756e6465727374616e642074686174206d792070726f746563746564206865616c746820696e666f726d6174696f6e206d6179206e65656420746f2062652072656c656173656420666f722074686520707572706f7365206f662074726561746d656e742c207061796d656e74206f72206865616c74682063617265206f7065726174696f6e732e0d0a0d0a4d656469636172652050617469656e74733a0d0a49206365727469667920746861742074686520696e666f726d6174696f6e20676976656e206279206d6520666f72206170706c69636174696f6e20666f72207061796d656e7420756e646572207469746c65205856494949206f662074686520536f6369616c2053656375726974792041637420697320636f72726563742e204920617574686f72697a6520616e7920686f6c646572206f66206d65646963616c206f72206f746865722072656c6576616e7420696e666f726d6174696f6e2061626f7574206d652062652072656c656173656420746f2074686520536f6369616c2053656375726974792041646d696e697374726174696f6e206f72206974277320696e7465726d6564696172696573206f6620636172726965727320616e64207375636820696e666f726d6174696f6e206e656564656420746f20737570706f7274206170706c69636174696f6e20666f72207061796d656e742e20496e636c7564696e67207265636f726473207065727461696e696e6720746f2048495620737461747573206f722074726561746d656e74202841494453207265636f726473292c206472756720616e6420616c636f686f6c2074726561746d656e742c20616e64206f722070737963686961747269632074726561746d656e742e20492061737369676e20616e6420617574686f72697a65207061796d656e74206469726563746c7920746f203c656d3e7b526566657272696e67444f437d3c2f656d3e20666f722074686520756e70616964206368617267657320666f72207468652070687973696369616e27732073657276696365732e204920756e6465727374616e642074686174204920616d20726573706f6e7369626c6520666f7220616c6c20696e737572616e63652064656475637469626c657320616e6420636f696e737572616e63652e0d0a436f6d6d656e74733a207b54657874496e7075747d0d0a5369676e61747572653a207b50617469656e745369676e61747572657d0d0a446f20796f7520617574686f72697a6520656c656374726f6e6963207369676e6174757265207b436865636b4d61726b7d200d0a52656c6174696f6e7368697020746f2070617469656e7420286966207369676e6564206279206120706572736f6e616c20726570726573656e746174697665293a207b54657874496e7075747d0d0a41726520796f75205072696d61727920436172652047697665723a7b796e526164696f47726f75707d0d0a446174653a207b444f537d0d0a3c2f703e3c703e436c696e696320526570726573656e746174697665205369676e6174757265266e6273703b7b526566657272696e67444f437d205369676e65643a207b41646d696e5369676e61747572657d203c2f703e3c703e3c6272202f3e3c2f703e, 'text/plain');
 INSERT INTO `document_templates` (`id`, `pid`, `provider`, `encounter`, `modified_date`, `profile`, `category`, `location`, `template_name`, `status`, `send_date`, `end_date`, `size`, `template_content`, `mime`) VALUES(10, -1, 1, NULL, '2021-11-30 16:02:52', '', '', NULL, 'Privacy Document', 'New', '0000-00-00 00:00:00', '0000-00-00 00:00:00', 2536, 0x3c703e4e4f54494345204f462050524956414359205052414354494345532050415449454e542041434b4e4f574c454447454d454e5420414e4420434f4e53454e5420544f204d45444943414c2054524541544d454e540d0a50617469656e74204e616d653a203c656d3e7b50617469656e744e616d657d3c2f656d3e0d0a44617465206f662042697274683a207b50617469656e74444f427d0d0a0d0a49206861766520726563656976656420616e6420756e6465727374616e6420746869732070726163746963652773204e6f74696365206f66205072697661637920507261637469636573207772697474656e20696e20706c61696e20456e676c6973682e20546865206e6f746963652070726f766964657320696e2064657461696c20746865207573657320616e6420646973636c6f7375726573206f66206d792070726f746563746564206865616c746820696e666f726d6174696f6e2074686174206d6179206265206d61646520627920746869732070726163746963652c206d7920696e646976696475616c207269676874732c20686f772049206d61792065786572636973652074686f7365207269676874732c20616e642074686520707261637469636573206c6567616c206475746965732077697468207265737065637420746f206d7920696e666f726d6174696f6e2e0d0a0d0a4920756e6465727374616e642074686174207468652070726163746963652072657365727665732074686520726967687420746f206368616e676520746865207465726d73206f66207468652050726976616379205072616374696365732c20616e6420746f206d616b65206368616e67657320726567617264696e6720616c6c2070726f746563746564206865616c746820696e666f726d6174696f6e2e204966206368616e676573206f63637572207468656e207468652070726163746963652077696c6c2070726f76696465206d6520776974682061207265766973656420636f70792075706f6e20726571756573742e0d0a0d0a4920766f6c756e746172696c7920636f6e73656e7420746f20636172652c20696e636c7564696e672070687973696369616e206578616d696e6174696f6e20616e64207465737473207375636820617320782d7261792c206c61626f7261746f727920746573747320616e6420746f206d65646963616c2074726561746d656e74206279206d792070687973696369616e206f72206869732f68657220617373697374616e7473206f722064657369676e6565732c206173206d6179206265206e656365737361727920696e20746865206a7564676d656e74206f66206d792070687973696369616e2e204e6f2067756172616e746565732068617665206265656e206d61646520746f206d652061732074686520726573756c74206f662074726561746d656e74206f72206578616d696e6174696f6e2e0d0a0d0a417574686f72697a6174696f6e20666f723a0d0a496e20636f6e73696465726174696f6e20666f72207365727669636573207265636569766564206279203c656d3e7b526566657272696e67444f437d3c2f656d3e204920616772656520746f2070617920616e7920616e6420616c6c20636861726765732061732062696c6c65642e204920616c736f2072657175657374207468617420646972656374207061796d656e7473206265206d61646520746f203c656d3e7b526566657272696e67444f437d3c2f656d3e206f6e206d7920626568616c6620627920696e73757265727320616e64206167656e6369657320696e2074686520736574746c656d656e74206f6620616e79206f66206d7920636c61696d732e204920756e6465727374616e642074686174206d792070726f746563746564206865616c746820696e666f726d6174696f6e206d6179206e65656420746f2062652072656c656173656420666f722074686520707572706f7365206f662074726561746d656e742c207061796d656e74206f72206865616c74682063617265206f7065726174696f6e732e0d0a0d0a4d656469636172652050617469656e74733a0d0a49206365727469667920746861742074686520696e666f726d6174696f6e20676976656e206279206d6520666f72206170706c69636174696f6e20666f72207061796d656e7420756e646572207469746c65205856494949206f662074686520536f6369616c2053656375726974792041637420697320636f72726563742e204920617574686f72697a6520616e7920686f6c646572206f66206d65646963616c206f72206f746865722072656c6576616e7420696e666f726d6174696f6e2061626f7574206d652062652072656c656173656420746f2074686520536f6369616c2053656375726974792041646d696e697374726174696f6e206f72206974277320696e7465726d6564696172696573206f6620636172726965727320616e64207375636820696e666f726d6174696f6e206e656564656420746f20737570706f7274206170706c69636174696f6e20666f72207061796d656e742e20496e636c7564696e67207265636f726473207065727461696e696e6720746f2048495620737461747573206f722074726561746d656e74202841494453207265636f726473292c206472756720616e6420616c636f686f6c2074726561746d656e742c20616e64206f722070737963686961747269632074726561746d656e742e20492061737369676e20616e6420617574686f72697a65207061796d656e74206469726563746c7920746f203c656d3e7b526566657272696e67444f437d3c2f656d3e20666f722074686520756e70616964206368617267657320666f72207468652070687973696369616e27732073657276696365732e204920756e6465727374616e642074686174204920616d20726573706f6e7369626c6520666f7220616c6c20696e737572616e63652064656475637469626c657320616e6420636f696e737572616e63652e0d0a436f6d6d656e74733a207b54657874496e7075747d0d0a5369676e61747572653a207b50617469656e745369676e61747572657d0d0a446f20796f7520617574686f72697a6520656c656374726f6e6963207369676e6174757265207b436865636b4d61726b7d200d0a52656c6174696f6e7368697020746f2070617469656e7420286966207369676e6564206279206120706572736f6e616c20726570726573656e746174697665293a207b54657874496e7075747d0d0a41726520796f75205072696d61727920436172652047697665723a7b796e526164696f47726f75707d0d0a446174653a207b444f537d0d0a3c2f703e3c703e436c696e696320526570726573656e746174697665205369676e6174757265266e6273703b7b526566657272696e67444f437d205369676e65643a207b41646d696e5369676e61747572657d203c2f703e3c703e3c6272202f3e3c2f703e, 'text/plain');
 
-INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES
-('ICD10', 'CMS', '2021-10-01', '2022-Code Descriptions.zip', '11d1d725c84e55d52ef6633da88aa137');
-
-INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES
-('ICD10', 'CMS', '2021-10-01', 'Zip File 3 2022 ICD-10-PCS Codes File.zip', 'a432177acbdaf9908aa528078ae72176');
-
 DROP TABLE IF EXISTS `valueset_oid`;
 CREATE TABLE `valueset_oid` (
   `nqf_code` varchar(255) NOT NULL DEFAULT '',
diff --git a/sql/patch.sql b/sql/patch.sql
index aad22314771..746831ec24e 100644
--- a/sql/patch.sql
+++ b/sql/patch.sql
@@ -52,6 +52,15 @@
 ALTER TABLE `prescriptions` CHANGE `route` `route` VARCHAR(100) NULL DEFAULT NULL Comment 'Max size 100 characters is same max as immunizations';
 #EndIf
 
+#IfNotRow4D supported_external_dataloads load_type ICD10 load_source CMS load_release_date 2022-10-01 load_filename 2023 Code Descriptions in Tabular Order.zip
+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES
+('ICD10', 'CMS', '2022-10-01', '2023 Code Descriptions in Tabular Order.zip', 'a2bd2e87d6fac3f861b03dba9ca87cbc');
+#EndIf
+
+#IfNotRow4D supported_external_dataloads load_type ICD10 load_source CMS load_release_date 2022-10-01 load_filename Zip File 3 2023 ICD-10-PCS Codes File.zip
+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES
+('ICD10', 'CMS', '2022-10-01', 'Zip File 3 2023 ICD-10-PCS Codes File.zip', 'a4c0e6026557d770dc3d994718acaa21');
+#EndIf
 #IfNotRow2D list_options list_id drug_route option_id bymouth
 INSERT INTO `list_options` (`list_id`, `option_id`, `title`, `seq`, `is_default`, `notes`, `codes`) VALUES ('drug_route', 'bymouth', 'By Mouth', 1, 0, 'PO', 'NCI-CONCEPT-ID:C38288');
 #EndIf
diff --git a/src/Billing/Hcfa1500.php b/src/Billing/Hcfa1500.php
index df76180b14a..429ba9a9e29 100644
--- a/src/Billing/Hcfa1500.php
+++ b/src/Billing/Hcfa1500.php
@@ -417,7 +417,9 @@ private function genHcfa1500Page($pid, $encounter, &$log, $claim)
         // Note: Date does not apply unless the person physically signs the form.
 
         // Box 13. Insured's or Authorized Person's Signature
-        $this->putHcfa(29, 55, 17, 'Signature on File');
+        if ($claim->billingFacilityAssignment()) {
+            $this->putHcfa(29, 55, 17, 'Signature on File');
+        }
 
         // Box 14. Date of Current Illness/Injury/Pregnancy
         // this will cause onsetDate in Encounter summary to override misc billing so not perfect yet but fine for now
diff --git a/src/Billing/X125010837P.php b/src/Billing/X125010837P.php
index 91489330112..77132601a86 100644
--- a/src/Billing/X125010837P.php
+++ b/src/Billing/X125010837P.php
@@ -626,7 +626,7 @@ public static function genX12837P($pid, $encounter, &$log, $encounter_claim = fa
         "*" .
         "*" . sprintf('%02d', $claim->facilityPOS()) . ":" . "B" . ":" . $claim->frequencyTypeCode() .
         "*" . "Y" .
-        "*" . "A" .
+        "*" . ($claim->billingFacilityAssignment() ? 'A' : 'C') .
         "*" . ($claim->billingFacilityAssignment() ? 'Y' : 'N') .
         "*" . "Y" .
         "~\n";
@@ -2158,7 +2158,7 @@ public static function gen_x12_837_tr3(
             "*" .
             "*" . sprintf('%02d', $claim->facilityPOS()) . ":" . "B" . ":" . $claim->frequencyTypeCode() .
             "*" . "Y" .
-            "*" . "A" .
+            "*" . ($claim->billingFacilityAssignment() ? 'A' : 'C') .
             "*" . ($claim->billingFacilityAssignment() ? 'Y' : 'N') .
             "*" . "Y" .
             "~\n";
diff --git a/src/Common/Logging/EventAuditLogger.php b/src/Common/Logging/EventAuditLogger.php
index 7a5ea0ae5ed..314d8eaecb3 100644
--- a/src/Common/Logging/EventAuditLogger.php
+++ b/src/Common/Logging/EventAuditLogger.php
@@ -155,8 +155,17 @@ class EventAuditLogger
      * @param string    $menu_item
      * @param int       $ccda_doc_id
      */
-    public function newEvent($event, $user, $groupname, $success, $comments = "", $patient_id = null, $log_from = 'open-emr', $menu_item = 'dashboard', $ccda_doc_id = 0)
-    {
+    public function newEvent(
+        $event,
+        $user,
+        $groupname,
+        $success,
+        $comments = "",
+        $patient_id = null,
+        $log_from = 'open-emr',
+        $menu_item = 'dashboard',
+        $ccda_doc_id = 0
+    ) {
         $category = $event;
         // Special case delete for lists table
         if ($event == 'delete') {
diff --git a/src/Patient/Cards/PortalCard.php b/src/Patient/Cards/PortalCard.php
index 8a93b7232fb..4e788f53032 100644
--- a/src/Patient/Cards/PortalCard.php
+++ b/src/Patient/Cards/PortalCard.php
@@ -21,9 +21,9 @@
 
 class PortalCard extends CardModel
 {
-    const TEMPLATE_FILE = 'patient/partials/portal.html.twig';
+    private const TEMPLATE_FILE = 'patient/partials/portal.html.twig';
 
-    const CARD_ID = 'patient_portal';
+    private const CARD_ID = 'patient_portal';
 
     private $opts = [];
 
@@ -70,16 +70,22 @@ private function setOpts()
         global $pid;
         $this->opts = [
             'acl' => ['patients', 'dem'],
-            'initiallyCollapsed' => (getUserSetting(self::CARD_ID) == 0) ? false : true,
-            'add' => true,
+            'initiallyCollapsed' => (getUserSetting(self::CARD_ID . '_expand') == 0),
+            'add' => false,
             'edit' => false,
             'collapse' => true,
             'templateFile' => self::TEMPLATE_FILE,
             'identifier' => self::CARD_ID,
             'title' => xl('Patient Portal') . ' / ' . xl('API Access'),
             'templateVariables' => [
-                'portalAuthorized' => portalAuthorized($pid),
+                'isPortalEnabled' => isPortalEnabled(),
+                'isPortalSiteAddressValid' => isPortalSiteAddressValid(),
+                'isPortalAllowed' => isPortalAllowed($pid),
                 'portalLoginHref' => $GLOBALS['webroot'] . "/interface/patient_file/summary/create_portallogin.php",
+                'isApiAllowed' => isApiAllowed($pid),
+                'areCredentialsCreated' => areCredentialsCreated($pid),
+                'isContactEmail' => isContactEmail($pid),
+                'isEnforceSigninEmailPortal' => isEnforceSigninEmailPortal($pid)
             ],
         ];
     }
diff --git a/templates/patient/partials/portal.html.twig b/templates/patient/partials/portal.html.twig
index 081aa96c85a..c5973995264 100644
--- a/templates/patient/partials/portal.html.twig
+++ b/templates/patient/partials/portal.html.twig
@@ -14,30 +14,76 @@ The Patient Portal card for the Medical Record Dashboard
     {% set append = cardMacros.injectedContent(appendedInjection) %}
 {% endif %}
 
-
 {% block content %}
-<div class="text d-flex pl-1">
-    {% if portalAuthorized.isAllowed == false %}
-        <div>
-        {% if portalAuthorized.authorized.api == false %}
-            <p>{{ "API Access Not Authorized"|xlt }}</p>
-        {% endif %}
-        {% if portalAuthorized.authorized.api == false %}
-            <p>{{ "Patient Portal Not Authorized"|xlt }}</p>
-        {% endif %}
+<div class="text pl-1">
+    {% if isPortalEnabled == false %}
+    <div class="alert alert-warning" role="alert">
+            <p class="font-weight-bold">{{  "Portal Status"|xlt }}</p>
+            <p> {{ "Patient Portal Not Enabled. Admin Can Enable Patient Portal."|xlt }} </p>
+        </div>
+    {% endif %} 
+
+    {% if isPortalSiteAddressValid == false %}
+    <div class="alert alert-warning" role="alert">
+            <p class="font-weight-bold">{{  "Portal Status"|xlt }}</p>
+            <p> {{ "Patient Portal Site Address Not Set Properly. Admin Can Correct in Config."|xlt }} </p>
+        </div>
+    {% endif %}
+
+    {% if isPortalAllowed == false %}
+        <div class="alert alert-warning" role="alert">
+            <p class="font-weight-bold">{{  "Portal Access"|xlt }}</p>
+            <p> {{ "Allow Patient Portal in Demographics Choices."|xlt }} </p>
         </div>
-    {% else %}
-        {{ prepend }}
-        {% if portalAuthorized.credentials.created == true %}
+    {% elseif isContactEmail == false and isEnforceSigninEmailPortal == true %}
+            <div class="alert alert-warning" role="alert">
+                <p class="font-weight-bold">{{  "Email Address"|xlt }}</p>
+                <p> {{ "Email is Enforced. Enter an Email in Demographics Contact."|xlt }} </p>
+            </div>
+    {% elseif isContactEmail == false and isEnforceSigninEmailPortal == false %}
+            <div class="alert alert-warning" role="alert">
+                <p class="font-weight-bold">{{  "Email Address"|xlt }}</p>
+                <p> {{ "Enter an Email in Demographics Contact for Sending Credentials."|xlt }} </p>
+            </div>        
+    {% elseif isPortalEnabled and isPortalSiteAddressValid %}
+    <div class="alert alert-info" role="alert">
+        <p class="font-weight-bold">{{ "Documents"|xlt }}</p>
+         <button type="button" class="btn btn-link btn-sm w-50" onclick='top.assignPatientDocuments({{pid|attr_js}})'><i class="fa fa-file-signature"></i>&nbsp;{{ "Assign"|xlt }}</button>
+        </div>           
+    {% endif %}
+
+
+    {% if isApiAllowed == false %}
+        <div class="alert alert-warning" role="alert">
+            <p class="font-weight-bold">{{  "API Access"|xlt }}</p>
+            <p> {{ "Prevent API Access can be disabled in Demographics Choices."|xlt }} </p>
+        </div>
+    {% endif %}     
+
+    {% if (
+        isPortalAllowed
+        and isPortalEnabled
+        and isPortalSiteAddressValid
+        and (
+            isEnforceSigninEmailPortal == false
+            or (
+                isEnforceSigninEmailPortal
+                and isContactEmail
+               )
+            ) 
+        or isApiAllowed == true
+        ) %}
+        <div class="alert alert-info" role="alert">
+        <p class="font-weight-bold">{{ "Credentials"|xlt }}</p>
+        {% if areCredentialsCreated == true %}
             {% set class = "fa-key" %}
-            {% set text = "Reset Credentials"|xlt %}
+            {% set text = "Reset"|xlt %}
         {% else %}
             {% set class = "fa-user-plus" %}
-            {% set text = "Create Credentials"|xlt %}
+            {% set text = "Create"|xlt %}
         {% endif %}
         <a href="{{ portalLoginHref|attr }}?patient={{ pid|attr_url }}" class="btn btn-link btn-sm w-50 small_modal"><i class="fa {{ class|attr }}"></i>&nbsp;{{ text|text }}</a>
-        <button type="button" class="btn btn-link btn-sm w-50" onclick='top.assignPatientDocuments({{pid|attr_js}})'><i class="fa fa-file-signature"></i>&nbsp;{{ "Assign Documents"|xlt }}</button>
-        {{ append }}
+        </div>
     {% endif %}
 </div>
 {% endblock %}
