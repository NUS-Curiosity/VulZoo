diff --git a/libsofia-sip-ua/url/url.c b/libsofia-sip-ua/url/url.c
index 6e437a4b..bc87ba68 100644
--- a/libsofia-sip-ua/url/url.c
+++ b/libsofia-sip-ua/url/url.c
@@ -364,8 +364,12 @@ char *url_canonize2(char *d, char const * const s, size_t n,
       continue;
     }
 
-    if (i >= strlen(s) - 1) return NULL;
-    h1 = s[i + 1], h2 = s[i + 2];
+    h1 = s[i + 1];
+    if (!h1) {
+        *d = '\0';
+        return NULL;
+    }
+    h2 = s[i + 2];
 
     if (!IS_HEX(h1) || !IS_HEX(h2)) {
       *d = '\0';
@@ -398,7 +402,6 @@ char *url_canonize2(char *d, char const * const s, size_t n,
   return d;
 }
 
-
 /** Canonize a URL component (with precomputed mask).
  *
  * This version does not flag error if *s contains character that should
