diff --git a/hphp/runtime/base/zend-string.cpp b/hphp/runtime/base/zend-string.cpp
index 072148f61c001..40267cffd6f70 100644
--- a/hphp/runtime/base/zend-string.cpp
+++ b/hphp/runtime/base/zend-string.cpp
@@ -1768,6 +1768,7 @@ String string_number_format(double d, int dec,
   String tmpstr(63, ReserveString);
   tmpbuf = tmpstr.mutableData();
   tmplen = snprintf(tmpbuf, 64, "%.*F", dec, d);
+  if (tmplen < 0) return empty_string();
   if (tmpbuf == nullptr || !isdigit((int)tmpbuf[0])) {
     tmpstr.setSize(tmplen);
     return tmpstr;
@@ -1777,6 +1778,7 @@ String string_number_format(double d, int dec,
     tmpstr = String(tmplen, ReserveString);
     tmpbuf = tmpstr.mutableData();
     tmplen = snprintf(tmpbuf, tmplen + 1, "%.*F", dec, d);
+    if (tmplen < 0) return empty_string();
     if (tmpbuf == nullptr || !isdigit((int)tmpbuf[0])) {
       tmpstr.setSize(tmplen);
       return tmpstr;
diff --git a/hphp/test/slow/string/number_format_error.php b/hphp/test/slow/string/number_format_error.php
new file mode 100644
index 0000000000000..e5899967bc0da
--- /dev/null
+++ b/hphp/test/slow/string/number_format_error.php
@@ -0,0 +1,19 @@
+<?php
+  $READ_LENGTH = 0x1000; // choose leak size
+// construct fake iptc header for controlled read
+$iptc_hdr =
+  "\x1c\x01" . // magic
+  "\x00\x80" . // dataset, recnum
+  "\x00" .     // padding
+  pack("N", $READ_LENGTH);
+// spray a bit so it's near the broken string
+$holder = [];
+for($i = 0; $i < 100; $i++)
+  $holder[] = str_pad($iptc_hdr, 96);
+// trigger bug to create string with len=-1
+$badstr = number_format(0,0x7fffffff);
+var_dump($badstr);
+// leak memory :)
+$tmp = iptcparse($badstr);
+var_dump($tmp);
+?>
diff --git a/hphp/test/slow/string/number_format_error.php.expect b/hphp/test/slow/string/number_format_error.php.expect
new file mode 100644
index 0000000000000..4cbe7ce9a7853
--- /dev/null
+++ b/hphp/test/slow/string/number_format_error.php.expect
@@ -0,0 +1,2 @@
+string(0) ""
+bool(false)
