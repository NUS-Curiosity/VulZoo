diff --git a/xwiki-platform-core/xwiki-platform-vfs/xwiki-platform-vfs-ui/pom.xml b/xwiki-platform-core/xwiki-platform-vfs/xwiki-platform-vfs-ui/pom.xml
index d3667eaa8270..5e3cccb2426e 100644
--- a/xwiki-platform-core/xwiki-platform-vfs/xwiki-platform-vfs-ui/pom.xml
+++ b/xwiki-platform-core/xwiki-platform-vfs/xwiki-platform-vfs-ui/pom.xml
@@ -55,6 +55,12 @@
       <type>xar</type>
       <scope>runtime</scope>
     </dependency>
+    <dependency>
+      <groupId>org.xwiki.platform</groupId>
+      <artifactId>xwiki-platform-rendering-xwiki</artifactId>
+      <version>${project.version}</version>
+      <scope>runtime</scope>
+    </dependency>
     <!-- Needed for Wiki Macros -->
     <dependency>
       <groupId>org.xwiki.platform</groupId>
diff --git a/xwiki-platform-core/xwiki-platform-vfs/xwiki-platform-vfs-ui/src/main/resources/Macros/VFSTreeMacro.xml b/xwiki-platform-core/xwiki-platform-vfs/xwiki-platform-vfs-ui/src/main/resources/Macros/VFSTreeMacro.xml
index 0affdc406c79..d398ebca11bc 100644
--- a/xwiki-platform-core/xwiki-platform-vfs/xwiki-platform-vfs-ui/src/main/resources/Macros/VFSTreeMacro.xml
+++ b/xwiki-platform-core/xwiki-platform-vfs/xwiki-platform-vfs-ui/src/main/resources/Macros/VFSTreeMacro.xml
@@ -250,7 +250,9 @@
     </property>
     <property>
       <code>{{velocity}}
-{{tree root="$xcontext.macro.params.root" reference="path:$xwiki.getURL($doc.getDocumentReference(), 'get', 'sheet=Macros.VFSTreeJSON&amp;outputSyntax=plain')" links="true"/}}
+#set ($root = $services.rendering.escape($xcontext.macro.params.root, 'xwiki/2.1'))
+#set ($reference = $services.rendering.escape("path:$xwiki.getURL($doc.getDocumentReference(), 'get', 'sheet=Macros.VFSTreeJSON&amp;outputSyntax=plain')", 'xwiki/2.1'))
+{{tree root="$root" reference="$reference" links="true"/}}
 {{/velocity}}</code>
     </property>
     <property>
