diff --git a/system/core/config.php b/system/core/config.php
index 4035c6949..df448bef8 100755
--- a/system/core/config.php
+++ b/system/core/config.php
@@ -144,7 +144,7 @@ public function setData() {
             $replace_upload_host_protocol = true;
         }
 
-        $this->set('document_root', rtrim(PATH, $this->root));
+        $this->set('document_root', preg_replace('#(.*)('.preg_quote($this->root).')$#u', '$1', PATH . DIRECTORY_SEPARATOR));
         $this->set('root_path', PATH . DIRECTORY_SEPARATOR);
         $this->set('system_path', $this->root_path . 'system/');
         $this->set('upload_path', $this->document_root . $this->upload_root);
diff --git a/system/core/user.php b/system/core/user.php
index 408665f4d..c7466d509 100755
--- a/system/core/user.php
+++ b/system/core/user.php
@@ -265,6 +265,8 @@ public static function autoLogin($auth_token) {
 
         self::setUserSession($user, $user['ip']);
 
+        self::sessionRegenerate();
+
         return intval($user['id']);
     }
 
@@ -343,6 +345,8 @@ public static function loginComplete($user, $remember = false) {
         self::getInstance()->id = $user['id'];
         self::getInstance()->is_logged = true;
 
+        self::sessionRegenerate();
+
         return true;
     }
 
@@ -384,6 +388,8 @@ public static function logout() {
 
         self::sessionUnset('user');
 
+        self::sessionRegenerate();
+
         return true;
     }
 
@@ -486,6 +492,19 @@ public static function sessionStart(cmsConfig $config) {
         }
     }
 
+    public static function sessionRegenerate() {
+
+        session_regenerate_id(false);
+
+        $id = session_id();
+
+        session_write_close();
+
+        session_id($id);
+
+        session_start();
+    }
+
     public static function sessionSet($key, $value) {
 
         if (strpos($key, ':') === false) {
@@ -568,7 +587,7 @@ public static function setCookie($key, $value, $time = 3600, $path = '/', $http_
                 'path'     => $path,
                 'domain'   => $domain,
                 'samesite' => 'Lax',
-                'secure'   => false,
+                'secure'   => cmsConfig::isSecureProtocol(),
                 'httponly' => $http_only
             ]);
         }
